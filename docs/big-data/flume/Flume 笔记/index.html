<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-big-data/flume/Flume 笔记">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Flume 笔记 | 十二翼堕落天使</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docusaurus.demo.icefery.github.io/docs/big-data/flume/Flume 笔记"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Flume 笔记 | 十二翼堕落天使"><meta data-rh="true" name="description" content="一、Flume 概述"><meta data-rh="true" property="og:description" content="一、Flume 概述"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docusaurus.demo.icefery.github.io/docs/big-data/flume/Flume 笔记"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/big-data/flume/Flume 笔记" hreflang="en"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/big-data/flume/Flume 笔记" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="十二翼堕落天使 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="十二翼堕落天使 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.37273cda.css">
<link rel="preload" href="/assets/js/runtime~main.58528b02.js" as="script">
<link rel="preload" href="/assets/js/main.4546e038.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">十二翼多堕落天使</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://blog.csdn.net/XY1790026787" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">CSDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/icefery/demo.icefery.xyz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/algorithm/">算法</a><button aria-label="Toggle the collapsible sidebar category &#x27;算法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/architecture/">架构</a><button aria-label="Toggle the collapsible sidebar category &#x27;架构&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/backend/">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/big-data/">大数据</a><button aria-label="Toggle the collapsible sidebar category &#x27;大数据&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/big-data/cdh/">CDH</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/big-data/flink/">Flink</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/big-data/flume/">Flume</a><button aria-label="Toggle the collapsible sidebar category &#x27;Flume&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/big-data/flume/Flume 笔记">Flume 笔记</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/big-data/greenplum/">Greenplum</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/big-data/hadoop/">Hadoop</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hadoop&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/big-data/hbase/">HBase</a><button aria-label="Toggle the collapsible sidebar category &#x27;HBase&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/big-data/hive/">Hive</a><button aria-label="Toggle the collapsible sidebar category &#x27;Hive&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/big-data/zookeeper/">ZooKeeper</a><button aria-label="Toggle the collapsible sidebar category &#x27;ZooKeeper&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/build-tool/">构建工具</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/container/">容器</a><button aria-label="Toggle the collapsible sidebar category &#x27;容器&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/container-app/clash/">container-app</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/db/">数据库</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据库&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/frontend/vue/">frontend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/gui/">GUI</a><button aria-label="Toggle the collapsible sidebar category &#x27;GUI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">概览</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/lang/">Lang</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lang&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/latex/">LaTex</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/load-balance/">负载均衡</a><button aria-label="Toggle the collapsible sidebar category &#x27;负载均衡&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/middleware/">中间件</a><button aria-label="Toggle the collapsible sidebar category &#x27;中间件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/network/">计算机网络</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/os/">操作系统</a><button aria-label="Toggle the collapsible sidebar category &#x27;操作系统&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/regexp/">正则表达式</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/software/">软件</a><button aria-label="Toggle the collapsible sidebar category &#x27;软件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/version-control/">版本控制</a><button aria-label="Toggle the collapsible sidebar category &#x27;版本控制&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/big-data/"><span itemprop="name">大数据</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/big-data/flume/"><span itemprop="name">Flume</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Flume 笔记</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Flume 笔记</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一flume-概述">一、Flume 概述<a class="hash-link" href="#一flume-概述" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-flume-定义">1.1 Flume 定义<a class="hash-link" href="#11-flume-定义" title="Direct link to heading">​</a></h3><p>Flume 是 Cloudera 提供的一个高可用的，高可靠的，分布式的海量日志采集、聚合和传输的系统。Flume 基于流式架构，灵活简单。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/bc00bad4c162417a84a2b349dee8d1db.png" alt="在这里插入图片描述" class="img_ev3q"></p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-flume-基础架构">1.2 Flume 基础架构<a class="hash-link" href="#12-flume-基础架构" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/9ca390ddd2dfdcf4f09001e910026c58.png" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="agent">Agent<a class="hash-link" href="#agent" title="Direct link to heading">​</a></h4><p>Agent 是一个 JVM 进程，它以事件的形式将数据从源头传送至目的地。</p><p>Agent 主要由三个部分组成：Source、Channel、Sink。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="source">Source<a class="hash-link" href="#source" title="Direct link to heading">​</a></h4><p>Source 是负责接收数据到 Flume Agent 的组件。Source 组件可以处理各种类型、各种格式的日志数据，包括 avro、thrift、exec、jms、spooling directory、netcat、taildir、sequence generator、syslog、http、legacy。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sink">Sink<a class="hash-link" href="#sink" title="Direct link to heading">​</a></h4><p>Sink 不断第轮询 Channel 中的事件且批量地移除它们，并将这些事件批量写入到存储或索引系统。或者被发送到另一个 Flume Agent。</p><p>Sink 组件目的地包括 hdfs、logger、avro、thrift、ipc、file、hbase、solr、自定义。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channel">Channel<a class="hash-link" href="#channel" title="Direct link to heading">​</a></h4><p>Channel 是位于 Source 和 Sink 之间的缓冲区。因此 Channel 允许 Source 和 Sink 运作在不同的速率上。Channel 是线程安全的，可以同时处理几个 Source 的写入操作和几个 Sink 的读取操作。</p><p>Flume 自带两种 Channel：</p><ul><li><p>Memory Channel</p><p>Memory Channel 是内存中的队列。Memory Channel 在不需要关系数据丢失的情景下适用。如果需要关系数据丢失，那么 Memory Channel 就不应该适用，因为程序死亡、及其宕机或者重启都会导致数据丢失。</p></li><li><p>File Channel</p><p>File Channel 将所有事件写到磁盘。因此在程序关闭或机器宕机的情况下不会丢失数据。</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="event">Event<a class="hash-link" href="#event" title="Direct link to heading">​</a></h4><p>Flume 数据传输的基本单元，以 Event 的形式将数据从源头送至目的地。Event 由 Header 和 Body 两部分组成，Header 用来存放该 Event 的一些属性，为 K-V 结构，Body 用来存放该条数据，形式为字节数组。</p><br><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二flume-入门">二、Flume 入门<a class="hash-link" href="#二flume-入门" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-flume-安装部署">2.1 Flume 安装部署<a class="hash-link" href="#21-flume-安装部署" title="Direct link to heading">​</a></h3><ul><li><p>下载解压</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> -zxvf apache-flume-1.9.0-bin.tar.gz -C /opt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> /opt/apache-flume-1.9.0-bin.tar.gz /opt/flume</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>配置环境变量</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;export FLUME_HOME=/opt/flume&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /etc/bash.profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">source</span><span class="token plain"> /etc/profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>兼容 Guava 依赖</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">find</span><span class="token variable" style="color:#36acaa"> $FLUME_HOME/lib -name </span><span class="token variable string" style="color:#e3116c">&#x27;guava-*&#x27;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">find</span><span class="token variable" style="color:#36acaa"> $HADOOP_HOME/share/hadoop/common/lib -name </span><span class="token variable string" style="color:#e3116c">&#x27;guava-*&#x27;</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable operator" style="color:#393A34">|</span><span class="token variable" style="color:#36acaa"> </span><span class="token variable function" style="color:#d73a49">head</span><span class="token variable" style="color:#36acaa"> -n </span><span class="token variable number" style="color:#36acaa">1</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$FLUME_HOME</span><span class="token plain">/lib</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>兼容 SLF4J 依赖</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable function" style="color:#d73a49">find</span><span class="token variable" style="color:#36acaa"> $FLUME_HOME/lib -name </span><span class="token variable string" style="color:#e3116c">&#x27;slf4j-*&#x27;</span><span class="token variable" style="color:#36acaa">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>调整内存</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$FLUME_HOME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">cp</span><span class="token plain"> conf/flume-env.sh.template conf/flume-env.sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> conf/flume-env.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修改相应注释行为：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">JAVA_OPTS</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;-Xms1024m -Xmx1024m -Dcom.sun.management.jmxremote&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-flume-入门案例">2.2 Flume 入门案例<a class="hash-link" href="#22-flume-入门案例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="221-监控端口数据官方案例">2.2.1 监控端口数据官方案例<a class="hash-link" href="#221-监控端口数据官方案例" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求">案例需求<a class="hash-link" href="#案例需求" title="Direct link to heading">​</a></h5><p>使用 Flume 监听一个端口，收集该端口数据，并打印到控制台。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤">实现步骤<a class="hash-link" href="#实现步骤" title="Direct link to heading">​</a></h5><ul><li><p>检查 44444 端口是否被占用</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">netstat</span><span class="token plain"> -nlp </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">grep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">44444</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建 Flume 配置文件 <code>jobs/flume-netcat-logger.conf</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$FLUME_HOME</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p </span><span class="token function" style="color:#d73a49">jobs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">vim</span><span class="token plain"> jobs/flume-netcat-logger.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># NetCat TCP Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = netcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind=localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 44444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent                          </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --conf conf/                              </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --conf-file jobs/flume-netcat-logger.conf </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  --name a1                                 </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -Dflume.root.logger</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">INFO,console</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>向本机 44444 端口发送数据</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> localhost </span><span class="token number" style="color:#36acaa">44444</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="222-实时监控单个追加文件">2.2.2 实时监控单个追加文件<a class="hash-link" href="#222-实时监控单个追加文件" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-1">案例需求<a class="hash-link" href="#案例需求-1" title="Direct link to heading">​</a></h5><p>实时监控 <code>/opt/flume/input/a.txt</code> 文件，并上传至 HDFS。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-1">实现步骤<a class="hash-link" href="#实现步骤-1" title="Direct link to heading">​</a></h5><ul><li><p>创建 Flume 配置文件 <code>jobs/flume-file-hdfs.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Exec Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.command = tail -F /opt/flume/input/a.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.shell = /bin/bash -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HDFS Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = hdfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.path = hdfs://node6:9000/flume/%Y-%m-%d/%H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.round = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.fileType = DataStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume-file-hdfs.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>追加文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /opt/flume/input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$RANDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /opt/flume/input/a.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="223-实时监控目录下的多个新文件">2.2.3 实时监控目录下的多个新文件<a class="hash-link" href="#223-实时监控目录下的多个新文件" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-2">案例需求<a class="hash-link" href="#案例需求-2" title="Direct link to heading">​</a></h5><p>使用 Flume 监听 <code>/opt/flume/input</code>整个目录的文件，并上传至 HDFS。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-2">实现步骤<a class="hash-link" href="#实现步骤-2" title="Direct link to heading">​</a></h5><ul><li><p>创建 Flume 配置文件 <code>jobs/flume-dir-hdfs.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Spooling Directory Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = spooldir</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.spoolDir = /opt/flume/input</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.fileHeader = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HDFS Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = hdfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.path = hdfs://node6:9000/flume/%Y-%m-%d/%H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.round = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.fileType = DataStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume-dir-hdfs.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>新建文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">touch</span><span class="token plain"> /opt/flume/input/1.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">touch</span><span class="token plain"> /opt/flume/input/2.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看目录变化</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> /opt/flume/input</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="说明">说明<a class="hash-link" href="#说明" title="Direct link to heading">​</a></h5><p><code>spoolDir</code> 不支持 <code>~</code> 路径。比如 <code>~/input</code> 会报错：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java.lang.IllegalStateException: Directory does not exist: /opt/flume/~/input</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在使用 Spooling Directory Source 时：</p><ol><li>不要再监控目录中创建并持续修改文件</li><li>上传完成的文件会以 <code>.COMPLETED</code> 结尾</li><li>被监控文件夹每 500 毫秒扫描一次文件变动</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="224-实时监控目录下的多个追加文件">2.2.4 实时监控目录下的多个追加文件<a class="hash-link" href="#224-实时监控目录下的多个追加文件" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a class="hash-link" href="#介绍" title="Direct link to heading">​</a></h5><p>Exec Source 适用于监控一个实时追加的文件，不能实现断点续传；Spooling Directory Source 适用于同步新文件，但不适合对实时追加日志的文件进行监听并同步；而 Taildir Source 适合用于监听多个实时追加的文件，并且能够实现断点续传。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-3">案例需求<a class="hash-link" href="#案例需求-3" title="Direct link to heading">​</a></h5><p>使用 Flume 监听整个目录的实时追加文件，并上传至 HDFS。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-3">实现步骤<a class="hash-link" href="#实现步骤-3" title="Direct link to heading">​</a></h5><ul><li><p>创建 Flume 配置文件 <code>jobs/flume-taildir-hdfs.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Taildir Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = TAILDIR</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.filegroups = f1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.filegroups.f1 = /opt/flume/input/.*txt.*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.positionFile = /opt/flume/taildir_position.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.fileHeader = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HDFS Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = hdfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.path = hdfs://node6:9000/flume/%Y-%m-%d/%H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.round = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.fileType = DataStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume-taildir-hdfs.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>追加文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$RANDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /opt/flume/input/a.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$RANDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /opt/flume/input/b.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="说明-1">说明<a class="hash-link" href="#说明-1" title="Direct link to heading">​</a></h5><p>Taildir Source 维护了一个 JSON 格式的 Position File，会定期的往 Position File 中更新每个文件读取到的最新的位置，因此能够实现断点续传。Position File 格式如下：</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;inode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1579598</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;pos&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;file&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/opt/flume/input/a.txt&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;inode&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1579593</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;pos&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;file&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;/opt/flume/input/b.txt&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Linux 中存储文件元数据区域叫做 inode，每个 inode 都有一个号码，操作系统用 inode 号码识别不同的文件，Unix/Linux 系统内部不使用文件名，而使用 inode 号码来识别文件。</p><br><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三flume-进阶">三、Flume 进阶<a class="hash-link" href="#三flume-进阶" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-flume-事务">3.1 Flume 事务<a class="hash-link" href="#31-flume-事务" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://img-blog.csdnimg.cn/702e4aaad9874d1fa59ea010106bee00.png" alt="在这里插入图片描述" class="img_ev3q"></p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-flume-agent-内部原理">3.2 Flume Agent 内部原理<a class="hash-link" href="#32-flume-agent-内部原理" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://img-blog.csdnimg.cn/22286d7942f34048a5a2d15cc7908b8f.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channelselector">ChannelSelector<a class="hash-link" href="#channelselector" title="Direct link to heading">​</a></h4><p>ChannelSelector 的作用就是选出 Event 将要被发往哪个 Channel。其共有两种类型，分别是 Replicating（复制）和 Multiplexing（多路复用）。</p><p>ReplicatingSelector 会将同一个 Event 发往所有的 Channel，MultiplexingSelector 会根据相应的原则，将不同的 Event 发往不同的 Channel。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sinkprocessor">SinkProcessor<a class="hash-link" href="#sinkprocessor" title="Direct link to heading">​</a></h4><p>SinkProcessor 共有三种类型，分别是：</p><ul><li>DefaultSinkProcessor：对应的是单个的 Sink。</li><li>LoadBalancingSinkProcessor：对应的是 Sink Group，可以实现负载均衡的功能。</li><li>FailoverSinkProcessor：对应的是 Sink Group，可以实现故障恢复的功能。</li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-flume-拓扑结构">3.3 Flume 拓扑结构<a class="hash-link" href="#33-flume-拓扑结构" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="简单串联">简单串联<a class="hash-link" href="#简单串联" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/5e336d60c2202a04f90fa45206a96a7a.png" class="img_ev3q"></p><p>这种模式是将多个 Flume 顺序连接起来了，从最初的 Source 开始到最终 Sink 传送的目的存储系统。</p><p>此模式不建议桥接过多的 Flume 数量，Flume 数量过多不仅会影响传输速率，而且一旦传输过程中某个节点 Flume 宕机，会影响整个传输系统 。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="复制和多路复用">复制和多路复用<a class="hash-link" href="#复制和多路复用" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/229a20a2c6b761e9acde353b97c26cb9.png" class="img_ev3q"></p><p>Flume 支持将事件流向一个或者多个目的地。这种模式可以将相同数据复制到多个 Channel 中，或者将不同数据分发到不同的 Channel 中，Sink 可以选择传送到不同的目的地。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="负载均衡和故障转移">负载均衡和故障转移<a class="hash-link" href="#负载均衡和故障转移" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/518579c3c47249eaa4c9bfda9676406c.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>Flume 支持使用多个 Sink 逻辑上分到一个 Sink 组，Sink 组配合不同的 SinkProcessor 可以实现负载均衡和故障恢复的功能。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="聚合">聚合<a class="hash-link" href="#聚合" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/2c4f7d96e540544bd51b0e170f43f51d.png" class="img_ev3q"></p><p>这种模式是我们最常见的，也非常实用，日常 Web 应用通常分布在上百个服务器，大者甚至上千个、上万个服务器。产生的日志，处理起来也非常麻烦。</p><p>用 Flume 的这种组合方式能很好的解决这一问题，每台服务器都部署一个 Flume 采集系统，传送到一个集中收集日志的 Flume，再由此 Flume 上传至 HDFS、Hive、Hbase 等，进行日志分析。</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-flume-开发案例">3.4 Flume 开发案例<a class="hash-link" href="#34-flume-开发案例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="341-复制和多路复用">3.4.1 复制和多路复用<a class="hash-link" href="#341-复制和多路复用" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-4">案例需求<a class="hash-link" href="#案例需求-4" title="Direct link to heading">​</a></h5><p>使用 Flume1 监控文件变动，Flume1 将变动内容传递给 Flume2，Flume2 负责存储到 HDFS。同时 Flume1 将变动内容传递给 Flume3，Flume3 负责输出到 Local File System。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-4">实现步骤<a class="hash-link" href="#实现步骤-4" title="Direct link to heading">​</a></h5><ul><li><p>创建接收文件的 Flume 配置文件 <code>jobs/flume1-file-flume.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1 k2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1 c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c2.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Exec Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.selector.type = replicating</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1 c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = exec</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.command = tail -F /opt/flume/input/a.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.shell = /bin/bash -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.channel = c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.port = 4142</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建输入到 HDFS 的 Flume 配置文件 <code>jobs/flume2-flume-hdfs.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># HDFS Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = hdfs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.path = hdfs://node6:9000/flume/%Y-%m-%d/%H</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.round = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.roundValue = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.fileType = DataStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hdfs.useLocalTimeStamp = true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建输出到本地目录的 Flume 配置文件 <code>jobs/flume3-flume-dir.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4142</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># File Roll Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = file_roll</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.sink.directory = /opt/flume/output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>注意：输出的目录必须数已经存在的目录，如果该目录不存在，并不会自动创建目录。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">mkdir</span><span class="token plain"> -p /opt/flume/output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>按顺序启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume3-flume-dir.conf -n a1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume2-flume-hdfs.conf -n a1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume1-file-flume.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>写入文件</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$RANDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /opt/flume/input/a.txt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看 HDFS 和本地目录</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">watch</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> /opt/flume/output</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="342-负责均衡和故障转移">3.4.2 负责均衡和故障转移<a class="hash-link" href="#342-负责均衡和故障转移" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-5">案例需求<a class="hash-link" href="#案例需求-5" title="Direct link to heading">​</a></h5><p>使用 Flume1 监控一个端口，其 Sink 组中的 Sink 分别对接 Flume2 和 Flume3，采用 FailoverSinkProcessor 实现故障转移。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-5">实现步骤<a class="hash-link" href="#实现步骤-5" title="Direct link to heading">​</a></h5><ul><li><p>创建接收端口数据的 Flume 配置文件 <code>jobs/flume1-netcat-flume.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups = g1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1 k2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># NetCat TCP Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = netcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 44444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Sink Group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups.g1.sinks = k1 k2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups.g1.processor.type = failover</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups.g1.processor.priority.k1 = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups.g1.processor.priority.k2 = 10</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinkgroups.g1.processor.maxpenalty = 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.port = 4142</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建两个输出到本地控制台的 Flume 配置文件 <code>jobs/flume2-flume-console.conf</code>、<code>jobs/flume3-flume-console.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4142</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>顺序启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume2-flume-console.conf -n a1 -Dflume.root.logger</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">INFO,console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume3-flume-console.conf -n a1 -Dflume.root.logger</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">INFO,console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume1-netcat-flume.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>向本机端口发送数据</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> loclahost </span><span class="token number" style="color:#36acaa">44444</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看 Flume2 及 Flume3 控制台日志打印情况</p></li><li><p>停止 Flume2 查看 Flume3 控制台日志打印情况</p></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="343-聚合">3.4.3 聚合<a class="hash-link" href="#343-聚合" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-6">案例需求<a class="hash-link" href="#案例需求-6" title="Direct link to heading">​</a></h5><ul><li>Flume1 监控文件 <code>/opt/flume/input/a.txt</code></li><li>Flume2 监控端口 44444</li><li>Flume1 与 Flume2 将数据发送给 Flume3，Flume3 将最终数据打印到控制台</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-6">实现步骤<a class="hash-link" href="#实现步骤-6" title="Direct link to heading">​</a></h5><ul><li><p>监控文件的 Flume1 配置文件 <code>jobs/flume1-file-flume.conf</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Memory Channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Exec Source</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin class-name">exec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.command </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">tail</span><span class="token plain"> -F /opt/flume/input/a.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.shell </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> /bin/bash -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Avro Sink</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hostname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinsk.k1.port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4141</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Hadoop102 上监控端口数据的 Flume2 配置文件 <code>jobs/flume2-netcat-flume.conf</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Agent</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Memory Channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># NetCat TCP Source</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> netcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">44444</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Avro Sink</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hostname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinsk.k1.port </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4141</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Hadoop103 上聚合输出到控制台的 Flume3 配置文件 <code>jobs/flume3-flume-logger.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = arvo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Flume3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume3-flume-logger.conf -n a1 -Dflume.root.logger</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">INFO,console</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Flume2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume2-netcat-flume.conf -n a1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Flume1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/flume-ng agent -c conf/ -f jobs/flume1-file-flume.conf -n a1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>追加文件并向端口发送数据</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Flume1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token environment constant" style="color:#36acaa">$RANDOM</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;&gt;</span><span class="token plain"> /opt/flume/input/a.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Flume1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> localhost </span><span class="token number" style="color:#36acaa">44444</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>查看 Flume3 控制台打印情况</p></li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="35-自定义-interceptor">3.5 自定义 Interceptor<a class="hash-link" href="#35-自定义-interceptor" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="案例需求-7">案例需求<a class="hash-link" href="#案例需求-7" title="Direct link to heading">​</a></h5><p>使用 Flume 采集服务器本地日志，需要按照日志类型的不同，将不同的日志发往不同的分析系统。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="需求分析">需求分析<a class="hash-link" href="#需求分析" title="Direct link to heading">​</a></h5><p>在实际的开发中，一台服务器产生的日志类型可能有很多种，不同类型的日志可能需要发送到不同的分析系统。</p><p>此时会用到 Flume 拓扑结构中的 Multiplexing 结构，Multiplexing 的原理是：根据 Event 中 Header 的某个 Key 的值，将不同的 Event 发送到不同的 Channel。所以我们需要自定义一个 Interceptor，为不同类型的 Event 的 Header 的 Key 赋予不同的值。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="实现步骤-7">实现步骤<a class="hash-link" href="#实现步骤-7" title="Direct link to heading">​</a></h5><ul><li><p>创建 Maven 项目并引入依赖</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.flume</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">flume-ng-core</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.9.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>创建自定义 Interceptor 并实现 <code>Interceptor</code> 接口</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Event;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.interceptor.Interceptor;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.ArrayList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.List;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import java.util.Map;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyInterceptor implements Interceptor {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private List&lt;Event&gt; eventList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void initialize() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventList = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 单个事件拦截</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Event intercept(Event event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Map&lt;String, String&gt; headers = event.getHeaders();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String body = new String(event.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (body.contains(&quot;info&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers.put(&quot;type&quot;, &quot;info&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (body.contains(&quot;error&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            headers.put(&quot;type&quot;, &quot;error&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return event;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 批量事件拦截</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public List&lt;Event&gt; intercept(List&lt;Event&gt; events) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eventList.clear();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Event event : events) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            eventList.add(intercept(event));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return eventList;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void close() { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static class Builder implements Interceptor.Builder {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public Interceptor build() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return new MyInterceptor();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        public void configure(Context context) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Flume 配置文件 <code>flume1-netcat-flume.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1 k2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1 c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c2.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># NetCat TCP Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1 c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = netcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 44444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.interceptors = i1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.interceptors.i1.type = xyz.icefery.demo.interceptor.MyInterceptor$Builder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.selector.type = multiplexing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.selector.header = type</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.selector.mapping.info = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.selector.mapping.error = c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.channel = c2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.hostname = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k2.port = 4142</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Flume 配置文件 <code>flume2-flume-logger.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>Flume 配置文件 <code>flume3-flume-logger.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Avro Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = avro</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 4142</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动任务 Flume2、Flume3、Flume1</p></li><li><p>向端口发送数据</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;info&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">nc</span><span class="token plain"> localhost </span><span class="token number" style="color:#36acaa">44444</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="36-自定义-source">3.6 自定义 Source<a class="hash-link" href="#36-自定义-source" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-1">介绍<a class="hash-link" href="#介绍-1" title="Direct link to heading">​</a></h5><p>Source 是负责接收数据到 Flume Agent 的组件。Source 组件可以处理各种类型、各种格式的日志数据，包括 Avro、Thrift、Exec、JMS、Spooling Directory、NetCat、Sequence Generator、Syslog、HTTP、Legacy。</p><p>官方提供的 Source 类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些 Source。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="需求">需求<a class="hash-link" href="#需求" title="Direct link to heading">​</a></h5><p>使用 Flume 接收数据，并给每条数据添加前缀，输出到控制台。前缀课从 Flume 配置文件中配置。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="编码">编码<a class="hash-link" href="#编码" title="Direct link to heading">​</a></h5><ul><li><p>自定义 Source，继承 <code>AbstractSource</code> 类，实现 <code>Configurable</code> 和 <code>PollableSource</code> 接口</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MySource extends AbstractSource implements Configurable, PollableSource {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private Long delay;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String field;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void configure(Context context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        delay = context.getLong(&quot;delay&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        field = context.getString(&quot;field&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Status process() throws EventDeliveryException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, String&gt; headers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Event event = new SimpleEvent();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; 5; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                event.setHeaders(headers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                event.setBody((field + i).getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                getChannelProcessor().processEvent(event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TimeUnit.MILLISECONDS.sleep(delay);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Status.READY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (InterruptedException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return Status.BACKOFF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long getBackOffSleepIncrement() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public long getMaxBackOffSleepInterval() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>打包并上传至 Flume 的 <code>lib</code> 目录下。</p></li><li><p>配置文件 <code>flume-custom-logger.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Custom Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = xyz.icefery.demo.source.MySource</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.prefix = custom-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Logger Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = logger</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="37-自定义-sink">3.7 自定义 Sink<a class="hash-link" href="#37-自定义-sink" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-2">介绍<a class="hash-link" href="#介绍-2" title="Direct link to heading">​</a></h5><p>Sink 不断地轮询 Channel 中的事件且批量地移除它们，并将这些事件批量写入到存储或索引系统、或者被发送到另一个 Flume Agent。</p><p>Sink 是完全事务性的，在从 Channel 批量删除数据之前，每个 Sink 用 Channel 启动一个事务。批量事件一旦成功写出到存储系统或下一个 Flume Agent，Sink 就利用 Channel 提交事务。事务一旦被提交，该 Channel 从自己的内部缓冲区删除事件。</p><p>Sink 组件目的地包括 HDFS、Avro、Thrift、IPC、File、Null、HBase、Solr、自定义。官方提供的 Sink 类型已经很多，但是有时候并不能满足实际开发当中的需求，此时我们就需要根据实际需求自定义某些 Sink。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="需求-1">需求<a class="hash-link" href="#需求-1" title="Direct link to heading">​</a></h5><p>使用 Flume 接收数据，并在 Sink 端给每条数据天添加前缀和后缀，输出到控制台。前后缀可在 Flume 任务配置文件中配置。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="编码-1">编码<a class="hash-link" href="#编码-1" title="Direct link to heading">​</a></h5><ul><li><p>自定义 Sink，继承 <code>AbstractSink</code>，实现 <code>Configurable</code> 接口</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Channel;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Context;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Event;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.EventDeliveryException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.Transaction;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.conf.Configurable;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.apache.flume.sink.AbstractSink;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.Logger;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">import org.slf4j.LoggerFactory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MySink extends AbstractSink implements Configurable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final Logger log = LoggerFactory.getLogger(AbstractSink.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String prefix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String suffix;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void configure(Context context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        prefix = context.getString(&quot;prefix&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        suffix = context.getString(&quot;suffix&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Status process() throws EventDeliveryException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Channel channel = getChannel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Transaction tx = channel.getTransaction();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tx.begin();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 读取 Channel 中的事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Event event;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            event = channel.take();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (event != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 处理事件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Status status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log.info(prefix + new String(event.getBody()) + suffix);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.commit();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = Status.READY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.rollback();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status = Status.BACKOFF;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } finally {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tx.close();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>打包上传至 Flume 的 <code>lib</code> 目录。</p></li><li><p>配置文件 <code>flume-netcat-custom.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Agent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources = r1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks = k1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Memory Channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.channels.c1.type = memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># NetCat TCP Source</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.channels = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.type = netcat</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.bind = localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sources.r1.port = 44444</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Custom Sink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.channel = c1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.type = xyz.icefery.demo.sink.MySink</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.prefix = custom-</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a1.sinks.k1.suffix = -custom</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><br><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四面试题">四、面试题<a class="hash-link" href="#四面试题" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-你是如何实现-flume-数据传输的监控的">4.1 你是如何实现 Flume 数据传输的监控的？<a class="hash-link" href="#41-你是如何实现-flume-数据传输的监控的" title="Direct link to heading">​</a></h3><p>使用第三方框架 Ganglia 实时监控 Flume。</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-flume-的-sourcesinkchannel-的作用你们-source-是什么类型">4.2 Flume 的 Source、Sink、Channel 的作用？你们 Source 是什么类型？<a class="hash-link" href="#42-flume-的-sourcesinkchannel-的作用你们-source-是什么类型" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="作用">作用<a class="hash-link" href="#作用" title="Direct link to heading">​</a></h4><ul><li>Source 组件是专门用来收集数据的，可以处理各种类型、各种格式的日志数据，包括 Avro、Thrift、Exec、JMS、Spooling Directory、NetCat、Sequence Generator、Syslog、HTTP、Legacy。</li><li>Sink 组件是用于把数据发送到目的地的组件，目的地包括 HDFS、Logger、Avro、Thrift、IPC、File、HBase、Solor、自定义。</li><li>Channel 组件对采集到的数据进行缓存，可以存放在 Memory 或在 File 中。</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="source-类型">Source 类型<a class="hash-link" href="#source-类型" title="Direct link to heading">​</a></h4><ul><li>监控后台日志：Exec</li><li>监控后台产生日志的端口：NetCat</li></ul><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-flume-的-channel-selectors">4.3 Flume 的 Channel Selectors<a class="hash-link" href="#43-flume-的-channel-selectors" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://img-blog.csdnimg.cn/ac6c4ce21fe843c0b5467b854eb5fff3.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-flume-参数调优">4.4 Flume 参数调优<a class="hash-link" href="#44-flume-参数调优" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="source-1">Source<a class="hash-link" href="#source-1" title="Direct link to heading">​</a></h4><p>增加 Source 个数可以增加 Source 读取数据的能力（使用 Taildir Source 时可增加 FileGroup 个数）。例如：当一个目录产生的文件过多时需要将这个文件目录拆分成多个文件目录，同时配置好多个 Source 以保证 Source 有足够的能力获取到新产生的数据。</p><p><code>batchSize</code>参数决定 Source 一次批量运输到 Channel 的 Event 条数，适当调大这个参数可以提高 Source 搬运 Event 到 Channel 时的性能。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channel-1">Channel<a class="hash-link" href="#channel-1" title="Direct link to heading">​</a></h4><p><code>type</code> 选择 <code>memory</code> 时 Channel 的性能最好，但是如果 Flume 进程意外挂掉可能会丢失数据。<code>type</code> 选择 <code>file</code>时 Channel 的容错性更好，但是性能会比 Memory Channel 差。</p><p>使用 File Channel 时 <code>dataDirs</code> 配置多个不同盘下的目录可以提高性能。</p><p><code>capacity</code> 参数决定 Channel 可容纳最大的 Event 条数。<code>transactionCapacity</code> 参数决定每次 Source 往 Channel 里面写的最大 Event 条数和每次 Sink 从 Channel 里面读的最大的 Event 条数。<code>transactionCapacity</code> 需要大于 Source 和 Sink 的 <code>batchSize</code> 参数。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="sink-1">Sink<a class="hash-link" href="#sink-1" title="Direct link to heading">​</a></h4><p>增加 Sink 的个数可以增加 Sink 消费 Event 的能力。Sink 也不是越多越好，够用就行，过多的 Sink 会占用系统资源，造成系统资源不必要的浪费。</p><p><code>batchSize</code> 参数决定 Sink 一次批量从 Channel 读取的 Event 条数，适当调大这个参数可以提高 Sink 从 Channel 搬出 Event 的性能。</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="45-flume-的事务机制">4.5 Flume 的事务机制<a class="hash-link" href="#45-flume-的事务机制" title="Direct link to heading">​</a></h3><p>Flume 使用两个独立的事务分别负责从 Source 到 Channel，以及从 Channel 到 Sink 的事件传递。</p><p>比如 Spooling Directory Source 为文件的每一行创建一个事件，一旦事务中所有的事件全部传递到 Channel 且提交成功，那么 Source 就将该文件标记为完成。</p><p>同理，事务以类似的方式处理 Channel 到 Sink 的传递过程，如果因为某种原因使得事件无法记录，那么事务将会回滚。且所有的事件都会保持到 Channel 中，等待重新传递。</p><br><h3 class="anchor anchorWithStickyNavbar_LWe7" id="46-flume-采集数据会丢失吗">4.6 Flume 采集数据会丢失吗？<a class="hash-link" href="#46-flume-采集数据会丢失吗" title="Direct link to heading">​</a></h3><p>根据 Flume 的架构原理，Flume 是不可能丢失数据的，其内部有完善的事务机制， Source 到 Channel 是事务性的，Channel 到 Sink 是事务性的，因此这两个环节不会出现数据的丢失，唯一可能丢失数据的情况是 Channel 采用 Memory Channel，Agent 宕机导致数据丢失，或者 Channel 存储数据已满，导致 Source 不再写入，未写入的数据丢失。</p><p>Flume 不会丢失数据，但是有可能造成数据的重复，例如数据已经由 Sink 发出，但是没有接收到响应，Sink 会再次发送数据，此时可能会导致数据的重复。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/big-data/flume/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Flume</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/big-data/greenplum/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Greenplum</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一flume-概述" class="table-of-contents__link toc-highlight">一、Flume 概述</a><ul><li><a href="#11-flume-定义" class="table-of-contents__link toc-highlight">1.1 Flume 定义</a></li><li><a href="#12-flume-基础架构" class="table-of-contents__link toc-highlight">1.2 Flume 基础架构</a><ul><li><a href="#agent" class="table-of-contents__link toc-highlight">Agent</a></li><li><a href="#source" class="table-of-contents__link toc-highlight">Source</a></li><li><a href="#sink" class="table-of-contents__link toc-highlight">Sink</a></li><li><a href="#channel" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#event" class="table-of-contents__link toc-highlight">Event</a></li></ul></li></ul></li><li><a href="#二flume-入门" class="table-of-contents__link toc-highlight">二、Flume 入门</a><ul><li><a href="#21-flume-安装部署" class="table-of-contents__link toc-highlight">2.1 Flume 安装部署</a></li><li><a href="#22-flume-入门案例" class="table-of-contents__link toc-highlight">2.2 Flume 入门案例</a><ul><li><a href="#221-监控端口数据官方案例" class="table-of-contents__link toc-highlight">2.2.1 监控端口数据官方案例</a><ul><li><a href="#案例需求" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li><li><a href="#222-实时监控单个追加文件" class="table-of-contents__link toc-highlight">2.2.2 实时监控单个追加文件</a><ul><li><a href="#案例需求-1" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-1" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li><li><a href="#223-实时监控目录下的多个新文件" class="table-of-contents__link toc-highlight">2.2.3 实时监控目录下的多个新文件</a><ul><li><a href="#案例需求-2" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-2" class="table-of-contents__link toc-highlight">实现步骤</a></li><li><a href="#说明" class="table-of-contents__link toc-highlight">说明</a></li></ul></li><li><a href="#224-实时监控目录下的多个追加文件" class="table-of-contents__link toc-highlight">2.2.4 实时监控目录下的多个追加文件</a><ul><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#案例需求-3" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-3" class="table-of-contents__link toc-highlight">实现步骤</a></li><li><a href="#说明-1" class="table-of-contents__link toc-highlight">说明</a></li></ul></li></ul></li></ul></li><li><a href="#三flume-进阶" class="table-of-contents__link toc-highlight">三、Flume 进阶</a><ul><li><a href="#31-flume-事务" class="table-of-contents__link toc-highlight">3.1 Flume 事务</a></li><li><a href="#32-flume-agent-内部原理" class="table-of-contents__link toc-highlight">3.2 Flume Agent 内部原理</a><ul><li><a href="#channelselector" class="table-of-contents__link toc-highlight">ChannelSelector</a></li><li><a href="#sinkprocessor" class="table-of-contents__link toc-highlight">SinkProcessor</a></li></ul></li><li><a href="#33-flume-拓扑结构" class="table-of-contents__link toc-highlight">3.3 Flume 拓扑结构</a><ul><li><a href="#简单串联" class="table-of-contents__link toc-highlight">简单串联</a></li><li><a href="#复制和多路复用" class="table-of-contents__link toc-highlight">复制和多路复用</a></li><li><a href="#负载均衡和故障转移" class="table-of-contents__link toc-highlight">负载均衡和故障转移</a></li><li><a href="#聚合" class="table-of-contents__link toc-highlight">聚合</a></li></ul></li><li><a href="#34-flume-开发案例" class="table-of-contents__link toc-highlight">3.4 Flume 开发案例</a><ul><li><a href="#341-复制和多路复用" class="table-of-contents__link toc-highlight">3.4.1 复制和多路复用</a><ul><li><a href="#案例需求-4" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-4" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li><li><a href="#342-负责均衡和故障转移" class="table-of-contents__link toc-highlight">3.4.2 负责均衡和故障转移</a><ul><li><a href="#案例需求-5" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-5" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li><li><a href="#343-聚合" class="table-of-contents__link toc-highlight">3.4.3 聚合</a><ul><li><a href="#案例需求-6" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#实现步骤-6" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li></ul></li><li><a href="#35-自定义-interceptor" class="table-of-contents__link toc-highlight">3.5 自定义 Interceptor</a><ul><li><a href="#案例需求-7" class="table-of-contents__link toc-highlight">案例需求</a></li><li><a href="#需求分析" class="table-of-contents__link toc-highlight">需求分析</a></li><li><a href="#实现步骤-7" class="table-of-contents__link toc-highlight">实现步骤</a></li></ul></li><li><a href="#36-自定义-source" class="table-of-contents__link toc-highlight">3.6 自定义 Source</a><ul><li><a href="#介绍-1" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#需求" class="table-of-contents__link toc-highlight">需求</a></li><li><a href="#编码" class="table-of-contents__link toc-highlight">编码</a></li></ul></li><li><a href="#37-自定义-sink" class="table-of-contents__link toc-highlight">3.7 自定义 Sink</a><ul><li><a href="#介绍-2" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#需求-1" class="table-of-contents__link toc-highlight">需求</a></li><li><a href="#编码-1" class="table-of-contents__link toc-highlight">编码</a></li></ul></li></ul></li><li><a href="#四面试题" class="table-of-contents__link toc-highlight">四、面试题</a><ul><li><a href="#41-你是如何实现-flume-数据传输的监控的" class="table-of-contents__link toc-highlight">4.1 你是如何实现 Flume 数据传输的监控的？</a></li><li><a href="#42-flume-的-sourcesinkchannel-的作用你们-source-是什么类型" class="table-of-contents__link toc-highlight">4.2 Flume 的 Source、Sink、Channel 的作用？你们 Source 是什么类型？</a><ul><li><a href="#作用" class="table-of-contents__link toc-highlight">作用</a></li><li><a href="#source-类型" class="table-of-contents__link toc-highlight">Source 类型</a></li></ul></li><li><a href="#43-flume-的-channel-selectors" class="table-of-contents__link toc-highlight">4.3 Flume 的 Channel Selectors</a></li><li><a href="#44-flume-参数调优" class="table-of-contents__link toc-highlight">4.4 Flume 参数调优</a><ul><li><a href="#source-1" class="table-of-contents__link toc-highlight">Source</a></li><li><a href="#channel-1" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#sink-1" class="table-of-contents__link toc-highlight">Sink</a></li></ul></li><li><a href="#45-flume-的事务机制" class="table-of-contents__link toc-highlight">4.5 Flume 的事务机制</a></li><li><a href="#46-flume-采集数据会丢失吗" class="table-of-contents__link toc-highlight">4.6 Flume 采集数据会丢失吗？</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with Docusaurus</div></div></div></footer></div>
<script src="/assets/js/runtime~main.58528b02.js"></script>
<script src="/assets/js/main.4546e038.js"></script>
</body>
</html>