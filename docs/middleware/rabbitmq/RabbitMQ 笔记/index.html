<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-middleware/rabbitmq/RabbitMQ 笔记">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">RabbitMQ 笔记 | 十二翼堕落天使</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docusaurus.demo.icefery.github.io/docs/middleware/rabbitmq/RabbitMQ 笔记"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="RabbitMQ 笔记 | 十二翼堕落天使"><meta data-rh="true" name="description" content="一、介绍"><meta data-rh="true" property="og:description" content="一、介绍"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docusaurus.demo.icefery.github.io/docs/middleware/rabbitmq/RabbitMQ 笔记"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/middleware/rabbitmq/RabbitMQ 笔记" hreflang="en"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/middleware/rabbitmq/RabbitMQ 笔记" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="十二翼堕落天使 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="十二翼堕落天使 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.37273cda.css">
<link rel="preload" href="/assets/js/runtime~main.58528b02.js" as="script">
<link rel="preload" href="/assets/js/main.4546e038.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">十二翼多堕落天使</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://blog.csdn.net/XY1790026787" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">CSDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/icefery/demo.icefery.xyz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/algorithm/">算法</a><button aria-label="Toggle the collapsible sidebar category &#x27;算法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/architecture/">架构</a><button aria-label="Toggle the collapsible sidebar category &#x27;架构&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/backend/">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/big-data/">大数据</a><button aria-label="Toggle the collapsible sidebar category &#x27;大数据&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/build-tool/">构建工具</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/container/">容器</a><button aria-label="Toggle the collapsible sidebar category &#x27;容器&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/container-app/clash/">container-app</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/db/">数据库</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据库&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/frontend/vue/">frontend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/gui/">GUI</a><button aria-label="Toggle the collapsible sidebar category &#x27;GUI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">概览</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/lang/">Lang</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lang&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/latex/">LaTex</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/load-balance/">负载均衡</a><button aria-label="Toggle the collapsible sidebar category &#x27;负载均衡&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/middleware/">中间件</a><button aria-label="Toggle the collapsible sidebar category &#x27;中间件&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/middleware/kafka/">Kafka</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kafka&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/middleware/rabbitmq/">RabbitMQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;RabbitMQ&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/middleware/rabbitmq/RabbitMQ 笔记">RabbitMQ 笔记</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/middleware/shardingsphere/">ShardingSphere</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/network/">计算机网络</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/os/">操作系统</a><button aria-label="Toggle the collapsible sidebar category &#x27;操作系统&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/regexp/">正则表达式</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/software/">软件</a><button aria-label="Toggle the collapsible sidebar category &#x27;软件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/version-control/">版本控制</a><button aria-label="Toggle the collapsible sidebar category &#x27;版本控制&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/middleware/"><span itemprop="name">中间件</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/middleware/rabbitmq/"><span itemprop="name">RabbitMQ</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">RabbitMQ 笔记</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>RabbitMQ 笔记</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="一介绍">一、介绍<a class="hash-link" href="#一介绍" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-核心概念">1.1 核心概念<a class="hash-link" href="#11-核心概念" title="Direct link to heading">​</a></h3><p><img loading="lazy" src="https://img-blog.csdnimg.cn/38797a92d6654d6380539e45227d3e0f.png" alt="请添加图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="broker">Broker<a class="hash-link" href="#broker" title="Direct link to heading">​</a></h4><p>接收和分发消息的应用，RabbitMQ Server 就是 Message Broker。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="virtual-host">Virtual Host<a class="hash-link" href="#virtual-host" title="Direct link to heading">​</a></h4><p>出于多租户和安全因素而设计，把 AMQP 的基本组件划分到一个虚拟的分组中，类似于网络中的 Namespace 概念。当多个不同的用户使用同一个 RabbitMQ Server 提供的服务时，可以划分出多个 VHost，每个用户在自己的 VHost 创建 Exchange / Queue 等。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="connection">Connection<a class="hash-link" href="#connection" title="Direct link to heading">​</a></h4><p>Producer / Consumer 和 Broker 之间的 TCP 连接。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="channel">Channel<a class="hash-link" href="#channel" title="Direct link to heading">​</a></h4><p>如果每一次访问 RabbitMQ 都建立一个 Connection，在消息量大的时候建立 TCP Connection 道德开销将是巨大的，效率也较低。Channel 是在 Connection 内部建立的逻辑连接，如果应用程序支持多线程，通常每个 Thread 创建单独的 Channel 进行通讯，AMQP 方法包含了 Channel ID 帮助客户端和 Message Broker 识别 Channel，所以 Channel 之间是完全隔离的。Channel 作为轻量级的 Connection 极大减少了操作系统建立 TCP Connection 的开销。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="exchange">Exchange<a class="hash-link" href="#exchange" title="Direct link to heading">​</a></h4><p>Message 到达 Broker 的第一站，根据分发规则匹配 Routing Key 分发消息到 Queue 中去。</p><p>交换机是 RabbitMQ 非常重要的一个部件，一方面它接收来自生产者的消息，另一方面它将消息推送到队列中。交换机必须确切知道如何处理它接收到的消息，是将这些消息推送到特定队列还是推送到多个队列，亦或者是把消息丢弃，这个都有交换机类型决定。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="queue">Queue<a class="hash-link" href="#queue" title="Direct link to heading">​</a></h4><p>队列是 RabbitMQ 内部使用的一种数据结构，尽管消息流经 RabbitMQ 和应用程序，但它们只能存储在队列中。队列仅受主机的内存和磁盘限制的约束，本质上是一个大的消息缓冲区。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="binding">Binding<a class="hash-link" href="#binding" title="Direct link to heading">​</a></h4><p>Exchange 和 Queue 之间的虚拟连接，Binding 中可以包含 Routing Key，Binding 信息被保存在 Exchange 中的查询表中，作为 Message 的分发依据。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="二安装">二、安装<a class="hash-link" href="#二安装" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-通过包管理器安装">2.1 通过包管理器安装<a class="hash-link" href="#21-通过包管理器安装" title="Direct link to heading">​</a></h3><p>通过 <code>--fix-missing</code> 选项自动解决需要的依赖（如 <code>erlang</code> 和 <code>socat</code> 等）。最新版本安装参考：<a href="https://www.rabbitmq.com/install-debian.html%E3%80%82" target="_blank" rel="noopener noreferrer">https://www.rabbitmq.com/install-debian.html。</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> rabbitmq-server -y --fix-missing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-开启-web-管理插件">2.2 开启 Web 管理插件<a class="hash-link" href="#22-开启-web-管理插件" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_management</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-用户和授权">2.3 用户和授权<a class="hash-link" href="#23-用户和授权" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="默认用户">默认用户<a class="hash-link" href="#默认用户" title="Direct link to heading">​</a></h4><p>RabbitMQ 默认用户和密码都为 <code>guest</code>，但只能本地 <code>localhost</code> 访问。可以通过配置 <code>loopback_users = none</code> 解除限制，比如 RabbitMQ 的官方镜像容器的默认配置：</p><ul><li><p><code>/etc/rabbitmq/conf.d/10-default-guest-user.conf</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">## DEFAULT SETTINGS ARE NOT MEANT TO BE TAKEN STRAIGHT INTO PRODUCTION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## see https://www.rabbitmq.com/configure.html for further information</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## on configuring RabbitMQ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## allow access to the guest user from anywhere on the network</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## https://www.rabbitmq.com/access-control.html#loopback-users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## https://www.rabbitmq.com/production-checklist.html#users</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">loopback_users.guest = false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><p>另一种方式是创建新的管理用户。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="创建管理用户">创建管理用户<a class="hash-link" href="#创建管理用户" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl add_user admin admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_user_tags admin administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_permissions -p / admin </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="角色分类">角色分类<a class="hash-link" href="#角色分类" title="Direct link to heading">​</a></h4><ul><li>None<ul><li>不能访问 Managment 插件</li></ul></li><li>Management<ul><li>列出自己可以通过 AMQP 登入的 VHost</li><li>查看自己的 VHost 节点的 Queue、Exchange、Binding 信息</li><li>查看和关闭自己 Channel 和 Connection</li><li>查看有关自己的 VHost 统计信息，包括其它用户在这个 VHost 中的活动信息</li></ul></li><li>Poclicymaker<ul><li>包含 Management 所有权限</li><li>查看和删除自己的 VHost 所属的 Policy 和 Parameter 信息</li></ul></li><li>Monitoring<ul><li>包含 Management 所有权限</li><li>列出所有的 VHost，包括不能登录的 VHost</li><li>查看其它用户的 Connection 和 Channel 信息</li><li>查看节点级别的数据，如 Clustering 和 Memory 使用情况</li><li>查看所有的 VHost 的全局统计信息</li></ul></li><li>Administrator<ul><li>最高权限</li><li>可以创建和删除 VHost</li><li>可以创建和删除 User</li><li>可以创建 Permission</li><li>可以关闭所有用户的 Connection</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="三java-客户端">三、Java 客户端<a class="hash-link" href="#三java-客户端" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-依赖">3.1 依赖<a class="hash-link" href="#31-依赖" title="Direct link to heading">​</a></h3><p>客户端依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">com.rabbitmq</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">amqp-client</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">5.14.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>日志依赖：</p><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.slf4j</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">slf4j-simple</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">1.7.32</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-示例">3.2 示例<a class="hash-link" href="#32-示例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="321-简单模式">3.2.1 简单模式<a class="hash-link" href="#321-简单模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/166108bb0f18081a041a9003862d32f2.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者">生产者<a class="hash-link" href="#生产者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 简单模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 创建连接工厂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConnectionFactory factory = new ConnectionFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setHost(&quot;192.192.192.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setPort(5672);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setUsername(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setPassword(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 使用 try-with-resources 语法(发送完消息后连接自动释放)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String connectionName = MyProducer.class.getSimpleName();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 创建连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection connection = factory.newConnection(connectionName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 创建通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Channel channel = connection.createChannel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. 声明队列(声明一个队列是幂等的，只有当它不存在时才会创建)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = &quot;q.tutorial_one&quot;;      // 队列名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean durable = false;              // 是否持久化(重启后队列是否还存在)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean exclusive = false;            // 是否独占</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean autoDelete = false;           // 是否自动删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; arguments = null; // 其它参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(queue, durable, exclusive, autoDelete, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String exchange = &quot;&quot;;                 // 交换机名(默认交互机名称为 `AMQP default` 类型为 `direct`)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String routingKey = queue;            // 路由键(默认交换机使用队列名匹配队列)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AMQP.BasicProperties headers = null;  // 消息头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String body = &quot;This is a message&quot;;    // 消息体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicPublish(exchange, routingKey, headers, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. 循环发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Scanner sc = new Scanner(System.in);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // while (sc.hasNextLine()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //     String body = sc.nextLine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //     channel.basicPublish(exchange, routingKey, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            //     System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException | TimeoutException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者">消费者<a class="hash-link" href="#消费者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 简单模式-消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 创建连接工厂</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConnectionFactory factory = new ConnectionFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setHost(&quot;192.192.192.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setPort(5672);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setUsername(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setPassword(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 不使用 try-with-resources 语法(避免消费完消息后连接自动释放)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 创建连接</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Connection connection = factory.newConnection(MyConsumer.class.getSimpleName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 创建通道</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Channel channel = connection.createChannel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = &quot;q.tutorial_one&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. 声明队列(声明一个队列是幂等的，只有当它不存在时才会创建)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(queue, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 5. 消费消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            boolean autoAck = true;                                        // 是否自动应答（默认为 false）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; { // 消费回调</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            CancelCallback cancelCallback = consumerTag -&gt; {               // 取消消费回调(如在消费时队列被删除)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.err.println(&quot;Consuming was interrupted&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(queue, autoAck, deliverCallback, cancelCallback);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } catch (IOException | TimeoutException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="工具类">工具类<a class="hash-link" href="#工具类" title="Direct link to heading">​</a></h5><p>可以发现生产消息和消费消息的整体流程是一致的：</p><ol><li>创建连接工厂</li><li>创建通道</li><li>操作 Channel</li></ol><p>那么就可以封装一个可以直接提供 Channel 的工具方法：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyRabbitMQ {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static final ConnectionFactory CONNECTION_FACTORY = new ConnectionFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONNECTION_FACTORY.setHost(&quot;192.192.192.6&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONNECTION_FACTORY.setPort(5672);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONNECTION_FACTORY.setUsername(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CONNECTION_FACTORY.setPassword(&quot;admin&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void start(String connectionName, boolean autoClose, ThrowableConsumer&lt;Channel, Exception&gt; throwableConsumer) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (autoClose) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try (</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Connection connection = CONNECTION_FACTORY.newConnection(connectionName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Channel channel = connection.createChannel()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throwableConsumer.accept(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Connection connection = CONNECTION_FACTORY.newConnection(connectionName);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Channel channel = connection.createChannel();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                throwableConsumer.accept(channel);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            } catch (Exception e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                e.printStackTrace();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static interface ThrowableConsumer&lt;T, E extends Throwable&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        void accept(T t) throws E;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="322-工作队列模式">3.2.2 工作队列模式<a class="hash-link" href="#322-工作队列模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/1dd2e684bfa454fc5a1f304752fd0922.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-1">生产者<a class="hash-link" href="#生产者-1" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 工作队列模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;&quot;;            // 默认交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = MyConsumer.QUEUE; // 队列一般在消费者端声明</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 1; i &lt;= 20; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = &quot;This is the &quot; + i + &quot;-th message&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, QUEUE, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-1">消费者<a class="hash-link" href="#消费者-1" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 工作队列模式-消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_two&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String connectionName1 = MyConsumer.class.getSimpleName() + &quot;1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String connectionName2 = MyConsumer.class.getSimpleName() + &quot;2&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cost1 = 500L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long cost2 = 1500L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Thread(() -&gt; roundRobinDispatch(connectionName1, cost1)).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new Thread(() -&gt; roundRobinDispatch(connectionName2, cost2)).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // new Thread(() -&gt; fairDispatch(connectionName1, cost1)).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // new Thread(() -&gt; fairDispatch(connectionName2, cost2)).start();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 工作队列模式-轮询分发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void roundRobinDispatch(String connectionName, long cost) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(connectionName, false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1. 收到消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received consumer=&#x27;%s&#x27; message=&#x27;%s&#x27;\n&quot;, connectionName, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. 处理消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try { TimeUnit.MILLISECONDS.sleep(cost); } catch (Exception ignored) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 工作队列模式-公平分发</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static void fairDispatch(String connectionName, long cost) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(connectionName, false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicQos(1); // 限制未确认消息缓冲区大小(一次只接收一条未确认的消息)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1. 收到消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received consumer=&#x27;%s&#x27; message=&#x27;%s&#x27;\n&quot;, connectionName, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. 处理消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try { TimeUnit.MILLISECONDS.sleep(cost); } catch (Exception ignored) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long deliveryTag = delivery.getEnvelope().getDeliveryTag(); // 消息 ID(服务器端向消费者推送消息，消息会携带一个 `deliveryTag` 参数，也可以称此参数为消息的唯一标识，是一个递增的正整数)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean multiple = false;                                   // 是否批量应答(如当前 tag=8，并且通道上 tag 在 5-8 的消息还未应答，是否一次性应答当前 tag 及其之前所有尚未应答的消息)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                boolean requeue = false;                                    // 是否重新入队</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3. 手动应答(肯定确认)(告知 RabbitMQ 该消息被成功处理了)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicAck(deliveryTag, multiple);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // // 3. 手动应答(否定确认)(不处理该消息直接拒绝)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // channel.basicNack(deliveryTag, multiple, requeue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, false, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果">效果<a class="hash-link" href="#效果" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/2c88968e9ba84cb3894dcb55ff87c407.png" alt="请添加图片描述" class="img_ev3q">
<img loading="lazy" src="https://img-blog.csdnimg.cn/22457776696c4e21b0808b4a1905079c.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="323-发布订阅模式">3.2.3 发布订阅模式<a class="hash-link" href="#323-发布订阅模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/ee39b4fe3d3090ee993baf8f357f1652.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-2">生产者<a class="hash-link" href="#生产者-2" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 发布订阅模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.tutorial_three.fanout&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE1 = MyConsumer1.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE2 = MyConsumer2.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. 声明交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.FANOUT, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 声明队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE1, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE2, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 绑定交换机和队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE1, EXCHANGE, ROUTING_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE2, EXCHANGE, ROUTING_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String body = &quot;This is a broadcast message&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicPublish(EXCHANGE, ROUTING_KEY, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者一">消费者一<a class="hash-link" href="#消费者一" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 发布订阅模式-消费者-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer1 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_three.queue1&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyConsumer1.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者二">消费者二<a class="hash-link" href="#消费者二" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 发布订阅模式-消费者-2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer2 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_three.queue2&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyConsumer2.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果-1">效果<a class="hash-link" href="#效果-1" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/6a215095384a4fab8629b7c85ec54e95.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="324-路由模式">3.2.4 路由模式<a class="hash-link" href="#324-路由模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/b2326695f6f4b8e3c48093e07be0659f.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-3">生产者<a class="hash-link" href="#生产者-3" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 路由模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.tutorial_four.log.direct&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE_LOG = LogConsumer.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE_ERROR_LOG = ErrorLogConsumer.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY_INFO = &quot;info&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY_WARN = &quot;warn&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY_ERROR = &quot;error&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final List&lt;String&gt; MESSAGE_LIST = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;[2022-01-01 00:00:00.100][main      ][info ] This is an info log.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;[2022-01-01 00:00:00.200][main      ][warn ] This is a warn log.&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;[2022-01-01 00:00:00.300][main      ][error] This is a error log.&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 1. 声明交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.DIRECT, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 2. 声明队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE_LOG, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE_ERROR_LOG, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 绑定交换机和队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_LOG, EXCHANGE, ROUTING_KEY_INFO);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_LOG, EXCHANGE, ROUTING_KEY_WARN);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_LOG, EXCHANGE, ROUTING_KEY_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_ERROR_LOG, EXCHANGE, ROUTING_KEY_ERROR);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 4. 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String routingKey = body.substring(38, 43).trim();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, routingKey, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Sent routingKey=&#x27;%s&#x27; message=&#x27;%s&#x27;\n&quot;, routingKey, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="收集所有日志消费者">收集所有日志消费者<a class="hash-link" href="#收集所有日志消费者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 路由模式-收集所有日志消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class LogConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_four.log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(LogConsumer.QUEUE, false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="收集错误日志消费者">收集错误日志消费者<a class="hash-link" href="#收集错误日志消费者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 路由模式-收集错误日志消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ErrorLogConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_four.error&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(ErrorLogConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1. 收到消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. 处理消息（告警）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try { TimeUnit.MILLISECONDS.sleep(500L); } catch (InterruptedException ignored) { }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3. 手动应答</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, false, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果-2">效果<a class="hash-link" href="#效果-2" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/a2cd572891444b98aa856038ebf3fee8.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="325-主题模式">3.2.5 主题模式<a class="hash-link" href="#325-主题模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/a871a6b497902eb6b3296d04ba7fdbd2.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-4">生产者<a class="hash-link" href="#生产者-4" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主题模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.tutorial_five.topic&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE_ORDER_LOG = OrderLogConsumer.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE_STOCK_LOG = StockLogConsumer.QUEUE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 主题(主题是由多个单词以 `.` 隔开的路由键，`*` 表示有且仅有一个单词，`#` 表示有任意个单词)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String TOPIC_ORDER = &quot;order.#.log.*&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String TOPIC_STOCK = &quot;stock.#.log.*&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final List&lt;String&gt; MESSAGE_LIST = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;-rw-r--r-- 1 root root 1M 2022-01-01 00:00 order.info.log.2022-01-01&quot;,  // 匹配订单主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;-rw-r--r-- 1 root root 1K 2022-01-01 00:00 order.warn.log.2022-01-01&quot;,  // 匹配订单主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;-rw-r--r-- 1 root root 10 2022-01-01 00:00 order.error.log.2022-01-01&quot;, // 匹配订单主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;-rw-r--r-- 1 root root  0 2022-01-01 00:00 stock.log&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;-rw-r--r-- 1 root root 1M 2022-01-01 00:00 stock.log.2022-01-01&quot;        // 匹配库存主题</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.TOPIC, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE_ORDER_LOG, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE_STOCK_LOG, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_ORDER_LOG, EXCHANGE, TOPIC_ORDER);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE_STOCK_LOG, EXCHANGE, TOPIC_STOCK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // ls -AFlh --time-style=long-iso | awk &#x27;{ print $8 }&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String[] split = body.split(&quot; &quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (split.length == 8) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    String routingKey = split[7];</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.basicPublish(EXCHANGE, routingKey, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.printf(&quot;sent routingKey=&#x27;%s&#x27; message=&#x27;%s&#x27;\n&quot;, routingKey, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="收集订单服务日志消费者">收集订单服务日志消费者<a class="hash-link" href="#收集订单服务日志消费者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主题模式-收集订单服务日志消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OrderLogConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_five.order.log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(OrderLogConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="收集库存服务日志消费者">收集库存服务日志消费者<a class="hash-link" href="#收集库存服务日志消费者" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 主题模式-收集库存服务日志消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class StockLogConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.tutorial_five.stock.log&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(StockLogConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, new String(delivery.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果-3">效果<a class="hash-link" href="#效果-3" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/75f35df087ad4061b910a5af0f0481e4.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="326-远程调用模式">3.2.6 远程调用模式<a class="hash-link" href="#326-远程调用模式" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/img_convert/9e30cd982ed17a65038c1b51070c1ff6.png" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="服务端">服务端<a class="hash-link" href="#服务端" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 远程调用模式-服务端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyServer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String REQUEST_EXCHANGE = &quot;&quot;;                          // 请求交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String REQUEST_QUEUE = &quot;q.tutorial_six.request&quot;;       // 请求队列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String RESPONSE_EXCHANGE = MyClient.RESPONSE_EXCHANGE; // 响应交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyServer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(REQUEST_QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicQos(1); // 限制未响应请求缓冲区大小(一次只处理一条请求)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback handler = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 1. 请求头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AMQP.BasicProperties requestHeaders = delivery.getProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String requestId = requestHeaders.getCorrelationId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String responseRoutingKey = requestHeaders.getReplyTo();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 2. 请求体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String requestBody = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received requestId=&#x27;%s&#x27; requestBody=&#x27;%s&#x27; responseRoutingKey=&#x27;%s&#x27;\n&quot;, requestId, requestBody, responseRoutingKey);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 3. 响应头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AMQP.BasicProperties responseHeaders = new AMQP.BasicProperties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .correlationId(requestId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 4. 响应体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String responseBody = Integer.toString(f(Integer.parseInt(requestBody)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(RESPONSE_EXCHANGE, responseRoutingKey, responseHeaders, responseBody.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicAck(delivery.getEnvelope().getDeliveryTag(), false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Responded requestId=&#x27;%s&#x27; requestBody=&#x27;%s&#x27; responseRoutingKey=&#x27;%s&#x27; responseBody=&#x27;%s&#x27;\n&quot;, requestId, requestBody, responseRoutingKey, responseBody);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(REQUEST_QUEUE, false, handler, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int f(int n) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (n == 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else if (n == 1) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        } else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            return f(n - 1) + f(n - 2);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="客户端">客户端<a class="hash-link" href="#客户端" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 远程调用模式-客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyClient {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String REQUEST_EXCHANGE = MyServer.REQUEST_EXCHANGE; // 请求交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String REQUEST_ROUTING_KEY = MyServer.REQUEST_QUEUE; // 请求路由键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String RESPONSE_EXCHANGE = &quot;&quot;;                       // 响应交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyClient.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                int f = f(channel, i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;f(%d) = %d\n&quot;, i, f);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static int f(Channel channel, int n) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. 请求头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestId = UUID.randomUUID().toString();          // 请求 ID(服务端响应时携带请求 ID，客户端收到响应后根据判断请求 ID 是否一致，不一致可进行丢弃)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String responseQueue = channel.queueDeclare().getQueue(); // 响应队列(每个请求单独创建临时队列，服务端将响应消息发送至该队列中)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AMQP.BasicProperties requestHeaders = new AMQP.BasicProperties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .correlationId(requestId)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .replyTo(responseQueue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. 请求体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String requestBody = Integer.toString(n);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.basicPublish(REQUEST_EXCHANGE, REQUEST_ROUTING_KEY, requestHeaders, requestBody.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;Requested requestId=&#x27;%s&#x27; requestBody=&#x27;%s&#x27; responseQueue=&#x27;%s&#x27;\n&quot;, requestId, requestBody, responseQueue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BlockingQueue&lt;String&gt; response = new ArrayBlockingQueue&lt;&gt;(1); // 响应结果阻塞队列(一次只发起一条请求并等待请求响应)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DeliverCallback responseCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 3. 响应头</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            AMQP.BasicProperties responseHeaders = delivery.getProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (Objects.equals(responseHeaders.getCorrelationId(), requestId)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                // 4. 响应体</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String responseBody = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received requestId=&#x27;%s&#x27; requestBody=&#x27;%s&#x27; responseQueue=&#x27;%s&#x27; responseBody=&#x27;%s&#x27; \n&quot;, requestId, requestBody, responseQueue, responseBody);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                response.offer(responseBody);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String cTag = channel.basicConsume(responseQueue, true, responseCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String responseBody = response.take(); // 等待响应结果</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        channel.basicCancel(cTag);             // 取消对响应队列的订阅</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Integer.parseInt(responseBody);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果-4">效果<a class="hash-link" href="#效果-4" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/e5f0586d4d714d1e915a1a85f6214659.png" alt="在这里插入图片描述" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="327-发布确认模式">3.2.7 发布确认模式<a class="hash-link" href="#327-发布确认模式" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-5">生产者<a class="hash-link" href="#生产者-5" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 发布确认模式-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final List&lt;String&gt; MESSAGE_LIST = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 1; i &lt;= 5000; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MESSAGE_LIST.add(&quot;msg&quot; + i);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        noConfirm();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confirmIndividuallySync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confirmBatchSync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confirmAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 无确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void noConfirm() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String mode = &quot;无确认&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = channel.queueDeclare().getQueue(); // 创建临时队列(主动声明一个由服务端命名的、排它的、自动删除的、非持久化的队列)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long start = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, queue, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long end = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;[%-20s] Sent %d messages for %d ms\n&quot;, mode, MESSAGE_LIST.size(), end - start);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 单独同步确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void confirmIndividuallySync() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String mode = &quot;单独同步确认&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = channel.queueDeclare().getQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.confirmSelect(); // 启用发布确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long start = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, queue, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.waitForConfirmsOrDie(1000L); // 等待确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long end = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;[%-20s] Sent %d messages for %d ms\n&quot;, mode, MESSAGE_LIST.size(), end - start);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 批量同步确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void confirmBatchSync() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String mode = &quot;批量同步确认&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = channel.queueDeclare().getQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.confirmSelect();           // 启用发布确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long batchSize = 100L;             // 批次大小</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long outstandingMessageCount = 0L; // 未确认的消息数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long start = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, queue, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outstandingMessageCount++;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                if (outstandingMessageCount == batchSize) { // 批量等待确认(当未确认的消息数到达批次大小时再等待确认)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.waitForConfirmsOrDie(1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    outstandingMessageCount = 0L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            if (outstandingMessageCount &gt; 0) {              // 批量等待确认(消息全部发送后可能仍有未确认的消息)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.waitForConfirmsOrDie(1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                outstandingMessageCount = 0L;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long end = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;[%-20s] Sent %d messages for %d ms\n&quot;, mode, MESSAGE_LIST.size(), end - start);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     * 异步确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private static void confirmAsync() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String mode = &quot;异步确认&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String queue = channel.queueDeclare().getQueue();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.confirmSelect(); // 启用发布确认</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.addConfirmListener(new ConfirmListener() { // 确认回调</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void handleAck(long deliveryTag, boolean multiple) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                public void handleNack(long deliveryTag, boolean multiple) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    System.out.println(&quot;Publishing failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long start = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String body : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, queue, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long end = System.currentTimeMillis();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;[%-20s] Sent %d messages for %d ms\n&quot;, mode, MESSAGE_LIST.size(), end - start);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="效果-5">效果<a class="hash-link" href="#效果-5" title="Direct link to heading">​</a></h5><p><img loading="lazy" src="https://img-blog.csdnimg.cn/8739393346064c3db67af1a9b08dbeff.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-总结">3.3 总结<a class="hash-link" href="#33-总结" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="官方示例总结">官方示例总结<a class="hash-link" href="#官方示例总结" title="Direct link to heading">​</a></h4><p>在官方的七个示例中，可以概括如下：</p><ol><li>简单模式：默认 <code>direct</code> 类型交换机，队列名充当路由键。</li><li>工作队列模式：同一队列不同消费者的消息分发机制。</li><li>发布订阅模式：同一个交换机绑定多个队列，实现广播消息。</li><li>路由模式：交换机根据分发规则将消息分发到不同的队列。</li><li>主题模式：交换机可以根据模糊的分发规则将消息分发到不同的队列。</li><li>远程调用模式：客户端发送请求到请求队列，并设置临时的响应队列，服务端订阅请求队列，并发送响应到临时的响应队列。</li><li>发布确认模式：消息可靠发送。</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="交换机类型总结">交换机类型总结<a class="hash-link" href="#交换机类型总结" title="Direct link to heading">​</a></h4><ul><li><code>fanout</code> 直连交换机：交换机忽略路由键，直接将消息分发到队列中。</li><li><code>direct</code> 路由交换机：交换机通过路由键，将消息分发到不同的队列中。（默认交互机使用队列名作为路由键）</li><li><code>topic</code> 主题交换机：交换机可以和队列绑定模糊的分发规则，以匹配不同的路由键。</li><li><code>headers</code> 头部交换机：不依赖于路由键，而是绑定时指定一组键值对，并提取消息的键值对是否完全匹配绑定的键值对，如果完全匹配则会把消息路由到该队列中。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="四spring-amqp">四、Spring AMQP<a class="hash-link" href="#四spring-amqp" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-介绍">4.1 介绍<a class="hash-link" href="#41-介绍" title="Direct link to heading">​</a></h3><p>在 Spring 生态中提供了 Spring AMQP 项目，让我们更简便的使用 AMQP，其官网介绍如下：</p><ul><li>它提供了一个 &quot;模板&quot; 作为发送消息的高级抽象。</li><li>它还通过 &quot;监听器容器&quot; 为消息驱动的 POJO 提供支持。</li><li>这些库促进 AMQP 资源的管理，同时促进使用依赖注入和申明式配置。</li><li>在所有这些情况下，您将看到与 Spring 框架中的 JMS 支持的相似之处。</li></ul><p>该项目包括两个部分：</p><ul><li><code>spring-amqp</code> 是 AMQP 的基础抽象</li><li><code>spring-rabbit</code> 是基于 RabbitMQ 对 AMQP 的具体实现</li></ul><p>功能特性：</p><ul><li>监听器容器：异步处理接收到的消息</li><li><code>RabbitTemplate</code>：发送和接收消息</li><li><code>RabbitAdmin</code>：自动创建队列、交换机、绑定关系</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-基本使用">4.2 基本使用<a class="hash-link" href="#42-基本使用" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="依赖">依赖<a class="hash-link" href="#依赖" title="Direct link to heading">​</a></h4><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.boot</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-boot-starter-amqp</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件">配置文件<a class="hash-link" href="#配置文件" title="Direct link to heading">​</a></h4><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.addresses=192.192.192.6:5672</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.username=admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.password=admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.rabbitmq.virtual-host=/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置类">配置类<a class="hash-link" href="#配置类" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RabbitMQConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String EXCHANGE = &quot;x.spring_boot.direct&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String QUEUE = &quot;q.spring_boot&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static final String ROUTING_KEY = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Queue springBootQueue() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // boolean durable = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // boolean exclusive = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // boolean autoDelete = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Map&lt;String, Object&gt; arguments = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Queue queue = new Queue(QUEUE, durable, exclusive, autoDelete, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return QueueBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .nonDurable(QUEUE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Exchange springBootExchange() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // boolean durable = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // boolean autoDelete = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Map&lt;String, Object&gt; arguments = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // DirectExchange exchange = new DirectExchange(EXCHANGE, durable, autoDelete, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return ExchangeBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .directExchange(EXCHANGE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Binding binding1(@Qualifier(&quot;springBootQueue&quot;) Queue queue, @Qualifier(&quot;springBootExchange&quot;) Exchange exchange) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Map&lt;String, Object&gt; arguments = null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Binding binding = new Binding(QUEUE, Binding.DestinationType.QUEUE, EXCHANGE, ROUTING_KEY, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return BindingBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .bind(queue)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .to(exchange)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .with(ROUTING_KEY)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .noargs();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-6">生产者<a class="hash-link" href="#生产者-6" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void sendRaw(String raw) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MessageProperties properties = MessagePropertiesBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .newInstance()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setContentType(MessageProperties.CONTENT_TYPE_TEXT_PLAIN)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message message = MessageBuilder</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .withBody(raw.getBytes())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .andProperties(properties)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE, RabbitMQConfig.ROUTING_KEY, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest(classes = { App.class })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AppTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyProducer producer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void test1() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String raw = &quot;{\&quot;data\&quot;: \&quot;This is a raw message\&quot;}&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        producer.sendRaw(raw);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-2">消费者<a class="hash-link" href="#消费者-2" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RabbitListener(queues = { RabbitMQConfig.QUEUE })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(Message message, Channel channel) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        String raw = new String(message.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;Received message=&#x27;%s&#x27;\n&quot;, raw);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>参考文档：</p><ul><li><a href="https://docs.spring.io/spring-amqp/docs/current/reference/html/#async-consumer" target="_blank" rel="noopener noreferrer">https://docs.spring.io/spring-amqp/docs/current/reference/html/#async-consumer</a></li></ul><p>参考类：</p><ul><li><p><code>org.springframework.amqp.core.MessageListener</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface MessageListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onMessage(Message message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>org.springframework.amqp.rabbit.listener.api.ChannelAwareMessageListener</code></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public interface ChannelAwareMessageListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void onMessage(Message message, Channel channel) throws Exception;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-自定义消息类">4.3 自定义消息类<a class="hash-link" href="#43-自定义消息类" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消息类">消息类<a class="hash-link" href="#消息类" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@AllArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@NoArgsConstructor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyMessage implements Serializable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private String data;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-7">生产者<a class="hash-link" href="#生产者-7" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private RabbitTemplate rabbitTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void sendObject(MyMessage object) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE, RabbitMQConfig.ROUTING_KEY, object);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-3">消费者<a class="hash-link" href="#消费者-3" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RabbitListener(queues = { RabbitMQConfig.QUEUE })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handMessage(MyMessage object, Channel channel, Message message) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;Received object=&#x27;%s&#x27; raw=&#x27;%s&#x27;\n&quot;, object, new String(message.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="json-序列化">JSON 序列化<a class="hash-link" href="#json-序列化" title="Direct link to heading">​</a></h4><p>默认情况下，<code>RabbitTempate</code> 消息转换器为 <code>SimpleMessageConverter</code>，使用 Java 的序列化。Spring Boot 也提供了 JSON 序列化的消息转换器：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RabbitMQConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MessageConverter jsonMessageConverter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new Jackson2JsonMessageConverter();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/3518c3d9e5284381b7d7099bc01fbf88.png" alt="在这里插入图片描述" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-批量消息">4.4 批量消息<a class="hash-link" href="#44-批量消息" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="441-批量发送">4.4.1 批量发送<a class="hash-link" href="#441-批量发送" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍">介绍<a class="hash-link" href="#介绍" title="Direct link to heading">​</a></h5><p>Spring AMQP 提供一个 <code>MessageBatch</code> 消息收集器，将发送给相同 Exchange 和 Routing Key 的消息，&quot;悄悄&quot; 收集在一起，当满足条件的时候，一次性批量发送提交给 RabbitMQ Broker。</p><p>Spring AMQP 通过 <code>BatchingRabbitTemplate</code> 提供批量发送的功能。如下是三个条件，满足任一即会批量发送：</p><ul><li>数量（<code>batchSize</code>）：超过收集的消息最大条数。</li><li>空间（<code>bufferLimit</code>）：超过收集的消息占用的最大内存。</li><li>时间（<code>timeout</code>）：超过收集的实际的最大等待时长，单位为毫秒。不过要注意，这里的超时开始计时的实际，是以最后一次发送时间为起点，也就是说，每调用一次发送消息，都以当前时刻开始计时，重新达到 <code>timeout</code> 才算超时。</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="配置类-1">配置类<a class="hash-link" href="#配置类-1" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RabbitMQConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public BatchingRabbitTemplate batchingRabbitTemplate(ConnectionFactory connectionFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 批量策略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int batchSize = 100;                // 批量收集最大消息条数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        int bufferLimit = 16 * 1024 * 1024; // 批量发送最大内存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long timeout = 60 * 1000L;          // 批量收集最长等待时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SimpleBatchingStrategy batchingStrategy = new SimpleBatchingStrategy(batchSize, bufferLimit, timeout);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 超时发送定时器</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TaskScheduler taskScheduler = new ConcurrentTaskScheduler();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        BatchingRabbitTemplate batchingRabbitTemplate = new BatchingRabbitTemplate(connectionFactory, batchingStrategy, taskScheduler);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batchingRabbitTemplate.setMessageConverter(jsonMessageConverter());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return batchingRabbitTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-8">生产者<a class="hash-link" href="#生产者-8" title="Direct link to heading">​</a></h5><p>Spring AMQP 会静默收集消息来实现批量发送，所以 <code>BatchingRabbitTemplate</code> 和 <code>RabbitTemplate</code> 的使用方法还是一致的。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private BatchingRabbitTemplate batchingRabbitTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void batchingSendRaw(String raw) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Message message = MessageBuilder.withBody(raw.getBytes()).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batchingRabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE, RabbitMQConfig.ROUTING_KEY, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@SpringBootTest(classes = { App.class })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">class AppTest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyProducer producer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    void test3() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 1; i &lt; 101; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            String raw = String.format(&quot;{\&quot;data\&quot;: \&quot;%s\&quot;}&quot;, &quot;This is the &quot; + i + &quot;-th message&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            producer.batchingSendRaw(raw);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="442-批量消费">4.4.2 批量消费<a class="hash-link" href="#442-批量消费" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-1">介绍<a class="hash-link" href="#介绍-1" title="Direct link to heading">​</a></h5><p>在【批量发送】章节中已经实现了批量发送消息到 RabbitMQ 中。那么，我们来思考一个问题，这批消息在 RabbitMQ 到底存储一条消息，还是多条消息？</p><p>实际上，RabbitMQ Broker 存储的是一条消息，又或者说，RabbitMQ 并没有提供批量接收消息的 API，&quot;批量发送&quot; 是 Spring AMQP 的 <code>SimpleBatchingStrategy</code> 所封装提供的：</p><ul><li>在 Producer 最终批量发送消息时，<code>SimpleBatchingStrategy</code> 会通过 <code>assembleMessage()</code> 方法，将批量发送的多条消息组装成一条 &quot;批量&quot; 消息，然后进行发送。</li><li>在 Consumer 拉取到消息时， 会根据 <code>canDebatch()</code> 方法，判断该消息是否为一条 &quot;批量&quot; 消息，如果是，则调用 <code>deBatch()</code> 方法，将一条 &quot;批量&quot; 消息拆开，变成多条消息。</li></ul><p><img loading="lazy" src="https://img-blog.csdnimg.cn/132e701e371a4cafaa56e458203a0d10.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-ettCQEte-1643449353557)(RabbitMQ 笔记/image-20220129151911629.png)]" class="img_ev3q"></p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="配置类-2">配置类<a class="hash-link" href="#配置类-2" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RabbitMQConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public SimpleRabbitListenerContainerFactory batchingConsumeContainerFactory(SimpleRabbitListenerContainerFactoryConfigurer configurer, ConnectionFactory connectionFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SimpleRabbitListenerContainerFactory factory = new SimpleRabbitListenerContainerFactory();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configurer.configure(factory, connectionFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setMessageConverter(jsonMessageConverter());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 启用批量消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setBatchListener(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConsumerBatchEnabled(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 阻塞等待最多 receiveTimeout 毫秒 拉取 batchSize 条消息进行消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setBatchSize(100);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setReceiveTimeout(60 * 1000L);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return factory;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-4">消费者<a class="hash-link" href="#消费者-4" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class BatchingConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RabbitListener(queues = { RabbitMQConfig.QUEUE }, containerFactory = &quot;batchingConsumeContainerFactory&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(List&lt;Message&gt; messages, Channel channel) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (Message message : messages) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.printf(&quot;Received raw=&#x27;%s&#x27;\n&quot;, new String(message.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="45-消费重试">4.5 消费重试<a class="hash-link" href="#45-消费重试" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-2">介绍<a class="hash-link" href="#介绍-2" title="Direct link to heading">​</a></h5><p>在消息消费失败的时候，Spring AMQP 会通过消费重试机制，重新投递给 Consumer，让 Consumer 有机会重新消费消息，实现消费成功。</p><p>当然，Spring AMQP 并不会无限重新投递消息给 Consumer 重新消费，而是在默认情况下，达到 N 次重试次数时，Consumer 还是会消费失败时，该消息就会进入死信队列。</p><p>那么消费失败达到最大次数的消息，是怎么进入到死信队列的呢？Spring AMQP 在消息到达最大消费次数的时候，会将该消息进行否定（<code>basicNack()</code>），并且 <code>requeue=false</code>，这样后续就可以利用 RabbitMQ 的死信队列机制，将该消息转发到死信队列。</p><p>在 Spring AMQP 的消费重试机制中，在消费失败到达最大次数后，会自动抛出 <code>AmqpRejectAndDontRequeueException</code> 异常，从而结束该消息的消费重试。这意味着如果我们在消费消息的逻辑中，主动抛出该异常，也能结束该消息的消息重试。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="spring-amqp-是怎么提供消费重试功能的">Spring AMQP 是怎么提供消费重试功能的<a class="hash-link" href="#spring-amqp-是怎么提供消费重试功能的" title="Direct link to heading">​</a></h5><ul><li>Spring AMQP 基于 <code>spring-retry</code> 项目提供的 <code>RetryTemplate</code> 实现重试功能。而 Spring AMQP 在获取到消息时，会交给 RetryTemplate 来调用消费者的监听器，实现该消息的消费重试。</li><li>在该消息的每次消费失败后，<code>RetryTemplate</code> 会通过 <code>BackOffPolicy</code> 来进行计算该消息的下一次重新消费的时候，通过 <code>Thread.sleep()</code> 方法实现重新消费的时间间隔。到达时间间隔后，<code>RetryTemplate</code>又会调用消费者监听器来消费该消息。</li><li>当该消息的重试消费达到上限后，<code>RetryTemplate</code> 会调用 <code>MethodInvocationRecoverer</code> 回调来实现恢复。而 Spring AMQP 自定义实现了 <code>RejectAndDontRequeueRecoverer</code> 来自动抛出 <code>AmqpRejectAndDontRequeueException</code> 异常，从而结束该消息的消费重试。</li><li>有一点需要注意，Spring AMQP 提供的消费重试的计数是在客户端级别的，重启 JVM 应用后，计数是会丢失的。</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="配置applicationyml">配置（<code>application.yml</code>）<a class="hash-link" href="#配置applicationyml" title="Direct link to heading">​</a></h5><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  rabbitmq:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listener:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      simple:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        retry: # 消费重试</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          enabled: true            # 开启消费重试机制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          max-attempts: 3          # 最大重试次数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          initial-interval: 1000ms # 重试间隔</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="46-并发消费">4.6 并发消费<a class="hash-link" href="#46-并发消费" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-3">介绍<a class="hash-link" href="#介绍-3" title="Direct link to heading">​</a></h5><p>在上述的示例中，我们配置的每一个 Spring AMQP 的 <code>@RabbitListener</code> 都是串行消费的。显然，这在监听的 Queue 每秒消息量比较大的时候，会导致消费不及时，导致消息积压问题。</p><p>虽然说，我们可以通过启动多个 JVM 进程，实现多进程的并发消费，从而加速消费的速度。但是怎么实现多线程的并发消费呢？</p><p>在 <code>@RabbitListener</code> 注解中，有 <code>concurrency</code> 属性，它可以指定并发消费的线程。例如，Spring AMQP 会根据 <code>@RabbitListener(concurrency = 2)</code> 注解配置，创建两个 Consumer，后续，每个 Consumer 会被单独分配到一个线程中，进行拉取消息，消费消息。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="spring-amqp-的容器类型containertype">Spring AMQP 的容器类型（<code>ContainerType</code>）<a class="hash-link" href="#spring-amqp-的容器类型containertype" title="Direct link to heading">​</a></h5><p>第一种类型 <code>SIMPLE</code> 对应 <code>SimpleMessageListenerContainer</code> 消息监听器容器，它一共有两类线程：</p><ul><li>Consumer 线程：负责从 RabbitMQ Broker 获取 Queue 中的消息，存储到内存中的 <code>BlockingQueue</code> 阻塞队列中。</li><li>Listener 线程，负责从内存中的 <code>BlockingQueue</code> 中获取消息，进行消费逻辑。</li></ul><p>注意，每一个 Consumer 线程，对应一个 RabbitMQ Consumer，对应一个 Listener 线程，也就是说，它们三责是一一对应的。</p><p>第二种类型 <code>DIRECT</code> 对应 <code>DirectMessageListenerContainer</code> 消息监听器容器。它只有一类线程，既做 <code>SIMPLE</code> 的 Consumer 线程的工作，也做 <code>SIMPLE</code> 的 Listener 线程工作。</p><p>注意因为只有一类线程，所有它要么正在获取消息，要么正在消费消息，也就是说，获取消息和消费消息是串行的。</p><p>默认情况下，Spring AMQP 选择第一种类型，即 <code>SIMPLE</code> 容器类型。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="配置applicationyml-1">配置（<code>application.yml</code>）<a class="hash-link" href="#配置applicationyml-1" title="Direct link to heading">​</a></h5><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rabbitmq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">listener</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> simple</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">simple</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">concurrency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-concurrency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-5">消费者<a class="hash-link" href="#消费者-5" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ConcurrencyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @RabbitListener(queues = { RabbitMQConfig.QUEUE }, concurrency = &quot;2&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void onMessage(Message message, Channel channel) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        long thread = Thread.currentThread().getId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;Received thread=&#x27;%d&#x27; raw=&#x27;%s&#x27;\n&quot;, thread, new String(message.getBody()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="47-事务消息">4.7 事务消息<a class="hash-link" href="#47-事务消息" title="Direct link to heading">​</a></h3><h5 class="anchor anchorWithStickyNavbar_LWe7" id="配置">配置<a class="hash-link" href="#配置" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@EnableTransactionManagement</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RabbitMQConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RabbitTransactionManager rabbitTransactionManager(ConnectionFactory connectionFactory, RabbitTemplate rabbitTemplate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rabbitTemplate.setChannelTransacted(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RabbitTransactionManager(connectionFactory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="48-消息异常处理器">4.8 消息异常处理器<a class="hash-link" href="#48-消息异常处理器" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="介绍-4">介绍<a class="hash-link" href="#介绍-4" title="Direct link to heading">​</a></h4><p>Spring AMQP 除了提供消息重试机制外，还可以自定义消费异常时的处理器，目前有两个接口：</p><ul><li><code>org.springframework.amqp.rabbit.listener.api.RabbitListenerErrorHandler</code></li><li><code>org.springframework.util.ErrorHandler</code></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rabbitlistenererrorhandler配置"><code>RabbitListenerErrorHandler</code>配置<a class="hash-link" href="#rabbitlistenererrorhandler配置" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyRabbitListenerErrorHandler implements RabbitListenerErrorHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Object handleError(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org.springframework.amqp.core.Message amqpMessage,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        org.springframework.messaging.Message&lt;?&gt; message,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListenerExecutionFailedException exception</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.error(&quot;[handleError] amqpMessage=&#x27;{}&#x27; message=&#x27;{}&#x27;&quot;, amqpMessage, message);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="errorhandler-配置"><code>ErrorHandler</code> 配置<a class="hash-link" href="#errorhandler-配置" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Slf4j</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyRabbitListenerErrorHandler implements ErrorHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public MyErrorHandler(SimpleRabbitListenerContainerFactory rabbitListenerContainerFactory) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rabbitListenerContainerFactory.setErrorHandler(this);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handleError(Throwable t) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log.error(&quot;[handleError] {}&quot;, t.getMessage());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="五消息应答">五、消息应答<a class="hash-link" href="#五消息应答" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-概念">5.1 概念<a class="hash-link" href="#51-概念" title="Direct link to heading">​</a></h3><p>消费者完成一个任务可能需要一段时间，如果其中一个消费者处理一个长的任务但是只完成了部分突然挂掉，会发生什么情况？</p><p>RabbitMQ 一旦向消费者传递了一条消息，便立即将该消息标记为删除。这这种情况下，突然有个消费者挂掉了，我们将丢失正在处理的消息，以及后续发送给该消费者的消息，因为该消费者无法接收到。</p><p>为了保证消息在发送过程中不丢失，RabbitMQ 引入消息应答机制：消费者在接收到消息并且处理掉消息之后，告诉 RabbitMQ 它已经处理了，RabbitMQ 可以把该消息删除了。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-自动应答">5.2 自动应答<a class="hash-link" href="#52-自动应答" title="Direct link to heading">​</a></h3><p>消息发送后立即被认为已经传送成功，这种模式需要在高吞吐量和数据传输安全性方面做权衡，因为这种模式如果消息在接收到之前，消费者那边出现 Connection 或 Channel 关闭，那么消息就丢失了。</p><p>另一方面这种模式消费者那边可以传递过载的消息，没有对传递的消息数量进行消息，这样有可能使得消费者这边由于接收太多还来不及处理的消息，导致这些消息的积压，最终使得内存耗尽，最终这些消费者线程被操作系统杀死。</p><p>所以这种模式仅适用在消费者可以高效并以某种速率能够处理这些消息的情况下适用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-手动应答">5.3 手动应答<a class="hash-link" href="#53-手动应答" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消息应答方法">消息应答方法<a class="hash-link" href="#消息应答方法" title="Direct link to heading">​</a></h4><ul><li><code>Channel.basicAck()</code> ：肯定确认（支持批量）</li><li><code>Channel.basicNack()</code>：否定确认</li><li><code>Channel.basicReject()</code>：否定确认（支持批量）</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="批量应答">批量应答<a class="hash-link" href="#批量应答" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/5f966e865d364662adca0459bf632a88.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>手动应答的好处是可以批量应答并且减少网络拥堵。<code>multiple</code> 表示是否一次性应答当前 Tag 及其之前所有尚未应答的消息。</p><p>比如 Channel 上的消息的 Tag 分别为 5、6、7、8，当前 Tag 为 8，那么 <code>multiple = true</code> 表示此时 Tag 为 5 到 8 的这些还未应答的消息都会被确认应答；<code>multiple = false</code> 则表示仅 Tag 为 8 的消息会被确认应答。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消息自动重新入队">消息自动重新入队<a class="hash-link" href="#消息自动重新入队" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/a6253594a9464b9e8de9aa3b452a9c50.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>如果消费者由于某些原因失去连接（通过关闭、连接关闭等），导致消息为发送 ACK 确认，RabbitMQ 将了解到消息未完成处理，并将其重新排队。如果此时其它消费者可以处理，它将很快将其分发给另一个消费者。这样即使消费者偶尔死亡，也可以确认不会丢失任何消息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="六工作队列">六、工作队列<a class="hash-link" href="#六工作队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-概念">6.1 概念<a class="hash-link" href="#61-概念" title="Direct link to heading">​</a></h3><p>当有多个消费者时，我们的消息会被哪个消费者消费呢？我们又该如何均衡消费者消息的多少呢？</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-轮询分发">6.2 轮询分发<a class="hash-link" href="#62-轮询分发" title="Direct link to heading">​</a></h3><p>一个消费者一条，按均分发。</p><p>轮询分发策略在某种场景下并不是很好，比如有两个消费者在处理任务，其中有个消费者处理任务的速度非常快，而另外一个消费者处理速度却很慢，这个时候如果还采用轮询分发策略，那么就会造成处理速度快的消费者很大一部分时间处于空闲状态，而处理慢的那个消费者一直在干活。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-公平分发">6.3 公平分发<a class="hash-link" href="#63-公平分发" title="Direct link to heading">​</a></h3><p>根据消费者的消费能力进行分发，处理快的处理的多，处理慢的处理的少。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="64-预取数">6.4 预取数<a class="hash-link" href="#64-预取数" title="Direct link to heading">​</a></h3><p>本身消息的发送就是异步发送的，所以在任何时候，Channel 上肯定不止只有一个消息，另外消费者的手动应答本质上也是异步的，因此这里就存在一个未确认的缓冲区，因此需要限制此缓冲区的大小，以避免缓冲区里面无限制的未确认消息问题。</p><p>这个时候可以通过 <code>Channel.basicQos()</code> 方法设置 “预取数”，该值定义通道上允许的未处理的消息最大数量。一旦达到与配置的数量，RabbitMQ 将停止在通道上传递更多消息，除非至少有一个未处理的消息被确认。</p><p>消息应答和 QoS 预取数对用户吞吐量有重大影响。通常增加预取数将提高向消费者传递消息的速度。虽然自动应答传输消息速度是最佳的，但是这种情况下已传递但尚未处理的消息的数量也会增加，从而增加了消费者的内存消耗（随机存取存储器）。</p><p><img loading="lazy" src="https://img-blog.csdnimg.cn/99e2c2b31b164975b20c94f61aefdeb7.png" alt="在这里插入图片描述" class="img_ev3q"></p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">int prefetchCount = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.basicQos(prefetchCount);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>表示如果这个任务我还没有处理完或者我没没有应答你，你先别分配给我，我目前只能处理一个任务，然后 RabbitMQ 就会把任务分配给没有那么忙的空闲消费者。当然如果所有的消费者都没有完成手上任务，队列还在不停的添加新任务，队列有可能会遇到被撑满的情况，这个时候就只能添加新的消费者或者改变其存储任务的策略。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="七rabbitmq-持久化">七、RabbitMQ 持久化<a class="hash-link" href="#七rabbitmq-持久化" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-概念">7.1 概念<a class="hash-link" href="#71-概念" title="Direct link to heading">​</a></h3><p>我们在 【消息应答机制】中了解了如何处理任务不丢失的情况，但是如果报账当 RabbitMQ 服务停掉以后消息生产者发送过来的消息不丢失？</p><p>默认情况下 RabbitMQ 退出或由于某种原因崩溃时，它将忽视队列和消息，除非告知它不要这样做。确保消息不会丢失需要将队列和消息都标记为持久化。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-队列持久化">7.2 队列持久化<a class="hash-link" href="#72-队列持久化" title="Direct link to heading">​</a></h3><p>非持久化的队列在 RabbitMQ 重启后会被自动删除掉，如果要队列持久化，需要在声明队列的时候把 <code>durable</code> 参数设为 <code>true</code>。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel.queueDeclare(queue, true, exclusive, autoDelete, arguments);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>需要注意的就是如果之前声明的队列不是持久化的，需要把原先队列先删除。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="73-消息持久化">7.3 消息持久化<a class="hash-link" href="#73-消息持久化" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel.basicPublish(exchange, routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, body.getBytes());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将消息标记为持久化并不能完全报账不会丢失消息。尽管它告诉 RabbitMQ 将消息保存到磁盘，但是这里依然存在当消息刚准备存储在磁盘，但是还没有存储完的时候，消息还在缓存的一个间隔点。此时并没有真正写入磁盘。持久化保证并不强，但是对于简单的任务队列而言，这已经绰绰有余了。</p><p>对于更强有力的持久化策略，会在【发布确认】章节说明。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="八事务机制">八、事务机制<a class="hash-link" href="#八事务机制" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-概念">8.1 概念<a class="hash-link" href="#81-概念" title="Direct link to heading">​</a></h3><p>在使用 RabbitMQ 的时候，我们可以通过消息持久化操作来解决因为服务器的异常奔溃导致的消息丢失，除此之外我们还会遇到一个问题，当消息的发布者在将消息发送出去之后，消息到底有没有正确到达 Broker 服务器呢？</p><p>如果不进行特殊配置的话，默认情况下发布操作是不会返回任何消息给生产者的，也就是默认情况下我们的生产者是不知道消息有没有正确到达 Broker 的，如果消息到达 Broker 之前已经丢失的话，持久化操作也解决不了这个问题，因为消息根本没到达 Broker。</p><p>RabbitMQ 为我们提供了两种方式：</p><ol><li>通过 AMQP 事务机制实现，这也是 AMQP 协议层面提供的解决方案；</li><li>通过讲发布确认机制来实习；</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-介绍">8.2 介绍<a class="hash-link" href="#82-介绍" title="Direct link to heading">​</a></h3><p>RabbitMQ 内置提供事务消息的支持，不过 RabbitMQ 提供的并不是完整的事务消息的支持，缺少了回查机制。</p><p>RabbitMQ 中与事务机制有关的方法有三个：</p><ul><li><code>channel.txSelect()</code>：用于将当前 Channel 设置成 Transaction 模式。</li><li><code>channel.txCommit()</code>：用于提交事务。</li><li><code>channel.txRollback()</code>：用于回滚事务。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-关键代码">8.2 关键代码<a class="hash-link" href="#82-关键代码" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">channel.txSelect();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.basicPublish(ConfirmConfig.exchangeName, ConfirmConfig.routingKey, MessageProperties.PERSISTENT_TEXT_PLAIN, ConfirmConfig.msg_10B.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.txCommit();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="83-问题">8.3 问题<a class="hash-link" href="#83-问题" title="Direct link to heading">​</a></h3><p>事务确实能够解决 Producer 和 Broker 之间消息确认的问题，只有消息成功被 Broker 接收，事务提交才能成功，否则我们便可以在捕获异常异常进行事务回滚，同时进行消息重发。</p><p>但是使用事务机制的话会降低 RabbitMQ 的性能，那么有没有更好的方法既能保障 Producer 知道消息已经正确发送到 Broker，又能基本上不带来性能上的损失呢？</p><p>从 AMQP 协议的层面看是没有更好的办法，但是 RabbitMQ 提供了一个更好的方案，即将 Channel 设置为 发布确认模式。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="九发布确认机制">九、发布确认机制<a class="hash-link" href="#九发布确认机制" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="91-概念">9.1 概念<a class="hash-link" href="#91-概念" title="Direct link to heading">​</a></h3><p>生产者将通道设为 Confirm 模式，所有在该通道上发布的消息都会被指派一个唯一的 ID，消息被投递到所有匹配的队列之后，Broker 就会发送一个确认给生产者（包含消息的唯一 ID）。</p><p>这就使得生产者知道消息已经正确到达目的队列了，如果消息和队列是持久化的，那么确认消息会在消息写入磁盘之后发出，Broker 回传给生产者的确认消息中的 <code>deliveryTag</code> 包含了确认消息的序列号，此外 Broker 也可以设置 <code>multiple</code> 表示到这个序列号之前的所有消息都已经得到了处理。</p><p>Confirm 模式最大的好处在于它是异步的，一旦发布一条消息，生产者应用程序就可以在等待通道返回确认的同时继续发送下一条消息，当消息最终得到确认之后，生产者应用程序便可以通过回调方法来处理该确认消息，如果 RabbitMQ 因为自身内部错误导致消息丢失，也会发送一条 Nack 消息，生产者应用程序同样可以在回调方法中处理该 Nack 消息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="92-mandatory-参数">9.2 <code>mandatory</code> 参数<a class="hash-link" href="#92-mandatory-参数" title="Direct link to heading">​</a></h3><p>在仅开启了生产者确认机制的情况下，交换机收到消息后，会直接给消息生产者发送确认消息，如果发现该消息不可路由，那么消息会被直接丢弃，此时生产者是不知道消息被丢弃这个事件的。那么如果让生产者知道无法被路由的消息呢？</p><p>通过设置 <code>mandatory</code> 参数可以在当消息传递过程中不可达到目的地时将消息返回给生产者。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">boolean mandatory = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.basicPublish(EXCHANGE, ROUTING_KEY, mandatory, null, &quot;Hello World&quot;.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.addReturnListener(returnMessage -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String replyText = returnMessage.getReplyText();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String exchange = returnMessage.getExchange();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String routingKey = returnMessage.getRoutingKey();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AMQP.BasicProperties properties = returnMessage.getProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String body = new String(returnMessage.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="93-备份交换机">9.3 备份交换机<a class="hash-link" href="#93-备份交换机" title="Direct link to heading">​</a></h3><p>有了 <code>mandatory</code> 参数和消息回退，我们获得了对无法投递消息的感知能力，有机会在生产者无法被投递时发现并处理。但有时候，我们并不知道如何处理这些无法路由的消息，最多打个日志，然后触发警告，再来手动处理。</p><p>通过日志处理这些无法路由的消息是很不优雅的做法，特别是当生产者所在的服务有多台机器的时候，手动复制日志会更加麻烦而且更容易出错。而且设置 <code>mandatory</code> 参数会增加生产者的复杂性，需要添加处理这些被回退消息的逻辑。</p><p>如果既不想增加生产者的复杂性，该怎么做呢？</p><p>在【死信队列】章节中会提到可以为队列设置死信交换机来存储那些处理失败的消息，可是这些不可路由的消息根本没有机会进入到队列，因此无法使用死信队列保存消息。</p><p>在 RabbitMQ 中有一种备份交换机机制存在，可以很好的应对这个问题。当交换机收到一条不可路由消息时，就会把这条消息转发到备份交换机中，由备份交换机来进行转发和处理。</p><p>通常设置备份交换机的类型为 <code>fanout</code>，这样就能把所有消息投递到与其绑定的队列中。当然我们还可以建立一个报警队列，用队列的消费者来进行监测和报警。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">static final String NORMAL_EXCHANGE = &quot;x.normal.direct&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">static final String BACKUP_EXCHANGE = &quot;x.backup.fanout&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;String, Object&gt; arguments = Map.of(&quot;alternate-exchange&quot;, BACKUP_EXCHANGE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean durable = true;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean autoDelete = false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.exchangeDeclare(BACKUP_EXCHANGE, BuiltinExchangeType.FANOUT, durable, autoDelete, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.exchangeDeclare(NORMAL_EXCHANGE, BuiltinExchangeType.DIRECT, durable, autoDelete, arguments);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十死信队列">十、死信队列<a class="hash-link" href="#十死信队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="101-概念">10.1 概念<a class="hash-link" href="#101-概念" title="Direct link to heading">​</a></h3><p>正常情况下消费者从 Queue 中取出消息进行消费，但某些时候由于特定的原因导致 Queue 中的某些消息无法被消费，这样的消息如果没有后续的处理，就变成了死信。</p><p>为了保证业务的消息数据不丢失，当消息消费发生异常时，将消息投入死信队列中以进行后续处理。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="102-死信的来源">10.2 死信的来源<a class="hash-link" href="#102-死信的来源" title="Direct link to heading">​</a></h3><ul><li>消息 TTL 过期</li><li>队列达到最大长度</li><li>消息被拒绝并且 <code>requeue = false</code></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="103-示例">10.3 示例<a class="hash-link" href="#103-示例" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-9">生产者<a class="hash-link" href="#生产者-9" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 死信队列-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String NORMAL_EXCHANGE = NormalConsumer.EXCHANGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String NORMAL_ROUTING_KEY = NormalConsumer.ROUTING_KEY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static List&lt;String&gt; MESSAGE_LIST = new ArrayList&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MESSAGE_LIST.add(i + &quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        for (int i = 0; i &lt; 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            MESSAGE_LIST.add((char) (i + 65) + &quot;&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Collections.shuffle(MESSAGE_LIST);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (String message : MESSAGE_LIST) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = message + &quot; &quot; + LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(NORMAL_EXCHANGE, NORMAL_ROUTING_KEY, null, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TimeUnit.MILLISECONDS.sleep(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="普通消费者">普通消费者<a class="hash-link" href="#普通消费者" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 死信队列-正常消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class NormalConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.normal.direct&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.normal&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String DEAD_LETTER_EXCHANGE = DeadLetterConsumer.EXCHANGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String DEAD_LETTER_ROUTING_KEY = DeadLetterConsumer.ROUTING_KEY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(NormalConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDelete(EXCHANGE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.DIRECT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDelete(QUEUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 正常队列绑定死信交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; arguments = Map.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;x-dead-letter-exchange&quot;, DEAD_LETTER_EXCHANGE,       // 设置死信交换机</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;x-dead-letter-routing-key&quot;, DEAD_LETTER_ROUTING_KEY, // 设置死信路由键</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;x-message-ttl&quot;, 1000 * 60,                           // 设置队列消息存活时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                &quot;x-max-length&quot;, 10                                    // 设置队列消息最大容量(先入队列的会先进入死信队列)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE, EXCHANGE, ROUTING_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                long deliveryTag = delivery.getEnvelope().getDeliveryTag();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String status;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                try {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    Integer.parseInt(body.split(&quot; &quot;)[0]);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.basicAck(deliveryTag, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    status = &quot;ack&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                } catch (NumberFormatException | ArrayIndexOutOfBoundsException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    // 消息被拒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    channel.basicNack(deliveryTag, false, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    status = &quot;nack&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27; status=&#x27;%s&#x27;\n&quot;, body, status);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, false, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="死信消费者">死信消费者<a class="hash-link" href="#死信消费者" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 死信队列-死信消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class DeadLetterConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.dead_letter.direct&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.dead_letter&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(DeadLetterConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDelete(EXCHANGE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, BuiltinExchangeType.DIRECT);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDelete(QUEUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE, EXCHANGE, ROUTING_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String at = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27; at=&#x27;%s&#x27;\n&quot;, body, at);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十一延迟队列">十一、延迟队列<a class="hash-link" href="#十一延迟队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="111-概念">11.1 概念<a class="hash-link" href="#111-概念" title="Direct link to heading">​</a></h3><p>延迟队列内部是有序的，最重要的特性就体现在它的延时属性上，延迟队列中的元素是希望在指定时间内取出处理。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="112-使用场景">11.2 使用场景<a class="hash-link" href="#112-使用场景" title="Direct link to heading">​</a></h3><ul><li>订单在十分钟之内未支付则自动取消</li><li>新创建的店铺，如果在十天内都没有上传过商品，则自动发送消息提醒</li><li>用户注册后，如果三天内没有登录则进行短信提醒</li><li>用户发起退款后，如果三天内没有得到处理则通知相关运营人员</li><li>预定会议后，需要在前十分钟通知各个与会人员参加会议</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="113-rabbitmq-中的-ttl">11.3 RabbitMQ 中的 TTL<a class="hash-link" href="#113-rabbitmq-中的-ttl" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="概念">概念<a class="hash-link" href="#概念" title="Direct link to heading">​</a></h4><p>如果一条消息设置了 TTL 属性或者进入了设置 TTL 属性的队列，那么这条消息如果在 TTL 设置的时间内没有被消费就会成为死信。如果同时配置了队列的 TTL 和消息的 TTL，那么较小的那个值将会被使用。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="两者区别">两者区别<a class="hash-link" href="#两者区别" title="Direct link to heading">​</a></h4><p>如果设置了队列的 TTL 属性，那么一旦消息过期，就会被队列丢弃（如果配置了死信队列则会被丢到死信队列）。</p><p>而第二种方式，即使消息过期，也不一定会被马上丢弃，因为消息是否过期是在即将投递到消费者之前判定的，如果当前队列有严重的消息积压情况，则已过期的消息也许还能存活较长时间。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="114-延迟队列插件">11.4 延迟队列插件<a class="hash-link" href="#114-延迟队列插件" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="安装插件">安装插件<a class="hash-link" href="#安装插件" title="Direct link to heading">​</a></h4><ul><li><a href="https://www.rabbitmq.com/community-plugins.html" target="_blank" rel="noopener noreferrer">https://www.rabbitmq.com/community-plugins.html</a></li><li><a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange" target="_blank" rel="noopener noreferrer">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></li></ul><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看插件目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins directories</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 下载插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> /usr/lib/rabbitmq/lib/rabbitmq_server-3.9.13/plugins</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/3.9.0/rabbitmq_delayed_message_exchange-3.9.0.ez</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 启用插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_delayed_message_exchange</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-10">生产者<a class="hash-link" href="#生产者-10" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 延迟队列-生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = MyConsumer.EXCHANGE;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY = MyConsumer.ROUTING_KEY;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyProducer.class.getSimpleName(), true, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (int i = 1; i &lt;= 10; i++) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                AMQP.BasicProperties headers = new AMQP.BasicProperties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .headers(Map.of(&quot;x-delay&quot;, Long.toString(i * 1000L)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = i + &quot; &quot; + LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                channel.basicPublish(EXCHANGE, ROUTING_KEY, headers, body.getBytes());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Sent message=&#x27;%s&#x27;\n&quot;, body);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                TimeUnit.MILLISECONDS.sleep(1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-6">消费者<a class="hash-link" href="#消费者-6" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 延迟队列-消费者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String EXCHANGE = &quot;x.delayed.x-delayed-message&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String QUEUE = &quot;q.delayed&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    static final String ROUTING_KEY = &quot;&quot;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        MyRabbitMQ.start(MyConsumer.class.getSimpleName(), false, channel -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDelete(EXCHANGE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Map&lt;String, Object&gt; arguments = Map.of(&quot;x-delayed-type&quot;, &quot;direct&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.exchangeDeclare(EXCHANGE, &quot;x-delayed-message&quot;, false, false, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDelete(QUEUE);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueDeclare(QUEUE, false, false, false, null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.queueBind(QUEUE, EXCHANGE, ROUTING_KEY);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            DeliverCallback deliverCallback = (consumerTag, delivery) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String body = new String(delivery.getBody());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                String at = LocalDateTime.now().format(DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;Received message=&#x27;%s&#x27; at=&#x27;%s&#x27;\n&quot;, body, at);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            };</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            channel.basicConsume(QUEUE, true, deliverCallback, consumerTag -&gt; { });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十二幂等性">十二、幂等性<a class="hash-link" href="#十二幂等性" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="121-概念">12.1 概念<a class="hash-link" href="#121-概念" title="Direct link to heading">​</a></h3><p>用户对于同一操作发起的一次请求或者多次请求的结果是一致的，不会因为多次点击而产生了副作用。</p><p>举个最简单的例子，那就是支付，用户购买商品后支付，支付扣款成功，但是返回结果的时候网络异常，此时钱已经扣了，用户再次点击按钮，此时会进行第二次扣款，返回结果成功，用户查询余额发现多扣钱了，流水记录也变成了两条。</p><p>在以前的单应用系统中，我们只需要把数据操作放入事物中即可，发送错误立即回滚，但是再响应客户端的时候也有可能出现网络终端或者异常等等。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="122-消息重复消费">12.2 消息重复消费<a class="hash-link" href="#122-消息重复消费" title="Direct link to heading">​</a></h3><p>消费者在消费 MQ 中的消息时，MQ 已把消息发送给消费者，消费者在给 MQ 返回 ACK 时网络中断，故 MQ 未收到确认消息，该条消息会重新发给其它的消费者，或者在网络重连后再次发送给该消费者，但实际上该消费者已成功消费了该条消息，造成消费者消费了重复的消息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="123-解决思路">12.3 解决思路<a class="hash-link" href="#123-解决思路" title="Direct link to heading">​</a></h3><p>MQ 消费者的幂等性的解决一般使用全局 ID 或者写个唯一标识比如时间戳或者 UUID，每次消费消息时先判断该消息是否已消费过。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="124-消费端的幂等性保障">12.4 消费端的幂等性保障<a class="hash-link" href="#124-消费端的幂等性保障" title="Direct link to heading">​</a></h3><p>在海量订单生成的业务高峰期，生产端有可能就会重复发生了消息，这时候消费端就要实现幂等性，这就意味着我们的消息永远不会被消费多次。主流的幂等性操作有两种：</p><ol><li>唯一 ID + 指纹码机制：业务规则拼接唯一标识，利用数据库去重；</li><li>Redis 原子性：利用 Redis 执行 <code>SETNX</code> 命令；</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十三优先级队列">十三、优先级队列<a class="hash-link" href="#十三优先级队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="131-添加优先级">13.1 添加优先级<a class="hash-link" href="#131-添加优先级" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;String, Object&gt; arguments = Map.of(&quot;x-max-priority&quot;, 10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.queueDeclare(queue, durable, exclusive, autoDelete, arguments);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AMQP.BasicProperties props = new AMQP.BasicProperties</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .priority(5)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.basicPublish(exchange, routingKey, props, body.getBytes());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十四惰性队列">十四、惰性队列<a class="hash-link" href="#十四惰性队列" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="141-使用场景">14.1 使用场景<a class="hash-link" href="#141-使用场景" title="Direct link to heading">​</a></h3><p>RabbitMQ 从 3.6.0 版本开始引入了惰性队列的概念，惰性队列会尽可能的将消息存入磁盘，而在消费到相应的消息时才会被加载到内存中，它的一个重要的设计目标是能够支持更长的队列，即支持更多的消息存储。当消费者由于各种各样的原因（比如消费者下线，宕机，亦或者是由于维护而关闭等）而致使长时间内不能消费消息造成堆积时，惰性队列就很有必要了。</p><p>默认情况下，当生产者将消息发送到 RabbitMQ 的时候，队列中的消息会尽可能的存储在内存之中，这样可以更加快速的将消息发送给消费者。即使是持久化的消息，在被写入磁盘的同时也会在内存中驻留一份备份。当 RabbitMQ 需要释放内存的时候，会将内存中的消息换页至磁盘中，这个操作会耗费较长的实际，也会阻塞队列的操作，进而无法接收新的消息。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="142-设置惰性队列">14.2 设置惰性队列<a class="hash-link" href="#142-设置惰性队列" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;String, Object&gt; arguments = Map.of(&quot;x-queue-mode&quot;, &quot;lazy&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">channel.queueDeclare(queue, durable, exclusive, autoDelete, arguments);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="十五集群">十五、集群<a class="hash-link" href="#十五集群" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="151-clustering">15.1 Clustering<a class="hash-link" href="#151-clustering" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="三个节点">三个节点<a class="hash-link" href="#三个节点" title="Direct link to heading">​</a></h4><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">192.192.192.101 ubuntu101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.192.192.102 ubuntu102</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">192.192.192.103 ubuntu103</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="各节点正常安装">各节点正常安装<a class="hash-link" href="#各节点正常安装" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">apt</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> rabbitmq-server -y --fix-missing</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmq-plugins </span><span class="token builtin class-name">enable</span><span class="token plain"> rabbitmq_management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl add_user admin admin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_user_tags admin administrator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl set_permissions -p / admin </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.*&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="确保各几点的erlangcookie-相同">确保各几点的<code>.erlang.cookie</code> 相同<a class="hash-link" href="#确保各几点的erlangcookie-相同" title="Direct link to heading">​</a></h4><p>清除各节点用户级的 <code>.erlang.cookie</code>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">rm</span><span class="token plain"> -rf ~/.erlang.cookie</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>同步各几点 RabbitMQ 的 <code>.erlang.cookie</code>：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> /var/lib/rabbitmq/.erlang.cookie root@ubuntu102:/var/lib/rabbitmq/.erlang.cookie</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">scp</span><span class="token plain"> /var/lib/rabbitmq/.erlang.cookie root@ubuntu103:/var/lib/rabbitmq/.erlang.cookie</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重启服务：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">systemctl restart rabbitmq-server</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="加入集群ubuntu102ubuntu103">加入集群（<code>ubuntu102</code>、<code>ubuntu103</code>）<a class="hash-link" href="#加入集群ubuntu102ubuntu103" title="Direct link to heading">​</a></h4><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl stop_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl reset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl join_cluster rabbit@ubuntu101</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl start_app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rabbitmqctl cluster_status</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="152-镜像队列">15.2 镜像队列<a class="hash-link" href="#152-镜像队列" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="原因">原因<a class="hash-link" href="#原因" title="Direct link to heading">​</a></h4><p>如果 RabbitMQ 集群只有一个 Broker 节点，那么该节点的失效将导致整体服务的临时性不可用，并且也可能导致消息的丢失。</p><p>可以将所有消息都设置为持久化，并且设置对应队列的持久化，但是这样仍然无法避免由于缓存导致的问题，因为消息在发送之后和被写入磁盘并执行刷盘动作之间存在一个短暂但会产生问题的时间窗。</p><p>通过发布确认机制能够确认客户端知道哪些消息已经存入磁盘，尽管如此，一般不希望遇到因单节点故障导致的服务不可用。</p><p>引入镜像队列的机制，可以将队列镜像到集群中的其它 Broker 节点之上，如果集群中的一个节点失效了，队列能自动切换到镜像中的另一个节点以保证服务的可用性。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="搭建步骤">搭建步骤<a class="hash-link" href="#搭建步骤" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/effd5bfd628d47388112e32b52908a88.png" alt="在这里插入图片描述" class="img_ev3q"></p><p>其中 <code>Pattern</code> 是匹配队列名称的正则表达式。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="效果-6">效果<a class="hash-link" href="#效果-6" title="Direct link to heading">​</a></h4><p><img loading="lazy" src="https://img-blog.csdnimg.cn/2686ef5f28e0418aacf6e711a55864d8.png" alt="在这里插入图片描述" class="img_ev3q"></p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/middleware/rabbitmq/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">RabbitMQ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/middleware/shardingsphere/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ShardingSphere</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#一介绍" class="table-of-contents__link toc-highlight">一、介绍</a><ul><li><a href="#11-核心概念" class="table-of-contents__link toc-highlight">1.1 核心概念</a><ul><li><a href="#broker" class="table-of-contents__link toc-highlight">Broker</a></li><li><a href="#virtual-host" class="table-of-contents__link toc-highlight">Virtual Host</a></li><li><a href="#connection" class="table-of-contents__link toc-highlight">Connection</a></li><li><a href="#channel" class="table-of-contents__link toc-highlight">Channel</a></li><li><a href="#exchange" class="table-of-contents__link toc-highlight">Exchange</a></li><li><a href="#queue" class="table-of-contents__link toc-highlight">Queue</a></li><li><a href="#binding" class="table-of-contents__link toc-highlight">Binding</a></li></ul></li></ul></li><li><a href="#二安装" class="table-of-contents__link toc-highlight">二、安装</a><ul><li><a href="#21-通过包管理器安装" class="table-of-contents__link toc-highlight">2.1 通过包管理器安装</a></li><li><a href="#22-开启-web-管理插件" class="table-of-contents__link toc-highlight">2.2 开启 Web 管理插件</a></li><li><a href="#23-用户和授权" class="table-of-contents__link toc-highlight">2.3 用户和授权</a><ul><li><a href="#默认用户" class="table-of-contents__link toc-highlight">默认用户</a></li><li><a href="#创建管理用户" class="table-of-contents__link toc-highlight">创建管理用户</a></li><li><a href="#角色分类" class="table-of-contents__link toc-highlight">角色分类</a></li></ul></li></ul></li><li><a href="#三java-客户端" class="table-of-contents__link toc-highlight">三、Java 客户端</a><ul><li><a href="#31-依赖" class="table-of-contents__link toc-highlight">3.1 依赖</a></li><li><a href="#32-示例" class="table-of-contents__link toc-highlight">3.2 示例</a><ul><li><a href="#321-简单模式" class="table-of-contents__link toc-highlight">3.2.1 简单模式</a><ul><li><a href="#生产者" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者" class="table-of-contents__link toc-highlight">消费者</a></li><li><a href="#工具类" class="table-of-contents__link toc-highlight">工具类</a></li></ul></li><li><a href="#322-工作队列模式" class="table-of-contents__link toc-highlight">3.2.2 工作队列模式</a><ul><li><a href="#生产者-1" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-1" class="table-of-contents__link toc-highlight">消费者</a></li><li><a href="#效果" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#323-发布订阅模式" class="table-of-contents__link toc-highlight">3.2.3 发布订阅模式</a><ul><li><a href="#生产者-2" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者一" class="table-of-contents__link toc-highlight">消费者一</a></li><li><a href="#消费者二" class="table-of-contents__link toc-highlight">消费者二</a></li><li><a href="#效果-1" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#324-路由模式" class="table-of-contents__link toc-highlight">3.2.4 路由模式</a><ul><li><a href="#生产者-3" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#收集所有日志消费者" class="table-of-contents__link toc-highlight">收集所有日志消费者</a></li><li><a href="#收集错误日志消费者" class="table-of-contents__link toc-highlight">收集错误日志消费者</a></li><li><a href="#效果-2" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#325-主题模式" class="table-of-contents__link toc-highlight">3.2.5 主题模式</a><ul><li><a href="#生产者-4" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#收集订单服务日志消费者" class="table-of-contents__link toc-highlight">收集订单服务日志消费者</a></li><li><a href="#收集库存服务日志消费者" class="table-of-contents__link toc-highlight">收集库存服务日志消费者</a></li><li><a href="#效果-3" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#326-远程调用模式" class="table-of-contents__link toc-highlight">3.2.6 远程调用模式</a><ul><li><a href="#服务端" class="table-of-contents__link toc-highlight">服务端</a></li><li><a href="#客户端" class="table-of-contents__link toc-highlight">客户端</a></li><li><a href="#效果-4" class="table-of-contents__link toc-highlight">效果</a></li></ul></li><li><a href="#327-发布确认模式" class="table-of-contents__link toc-highlight">3.2.7 发布确认模式</a><ul><li><a href="#生产者-5" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#效果-5" class="table-of-contents__link toc-highlight">效果</a></li></ul></li></ul></li><li><a href="#33-总结" class="table-of-contents__link toc-highlight">3.3 总结</a><ul><li><a href="#官方示例总结" class="table-of-contents__link toc-highlight">官方示例总结</a></li><li><a href="#交换机类型总结" class="table-of-contents__link toc-highlight">交换机类型总结</a></li></ul></li></ul></li><li><a href="#四spring-amqp" class="table-of-contents__link toc-highlight">四、Spring AMQP</a><ul><li><a href="#41-介绍" class="table-of-contents__link toc-highlight">4.1 介绍</a></li><li><a href="#42-基本使用" class="table-of-contents__link toc-highlight">4.2 基本使用</a><ul><li><a href="#依赖" class="table-of-contents__link toc-highlight">依赖</a></li><li><a href="#配置文件" class="table-of-contents__link toc-highlight">配置文件</a></li><li><a href="#配置类" class="table-of-contents__link toc-highlight">配置类</a></li><li><a href="#生产者-6" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-2" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li><li><a href="#43-自定义消息类" class="table-of-contents__link toc-highlight">4.3 自定义消息类</a><ul><li><a href="#消息类" class="table-of-contents__link toc-highlight">消息类</a></li><li><a href="#生产者-7" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-3" class="table-of-contents__link toc-highlight">消费者</a></li><li><a href="#json-序列化" class="table-of-contents__link toc-highlight">JSON 序列化</a></li></ul></li><li><a href="#44-批量消息" class="table-of-contents__link toc-highlight">4.4 批量消息</a><ul><li><a href="#441-批量发送" class="table-of-contents__link toc-highlight">4.4.1 批量发送</a><ul><li><a href="#介绍" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#配置类-1" class="table-of-contents__link toc-highlight">配置类</a></li><li><a href="#生产者-8" class="table-of-contents__link toc-highlight">生产者</a></li></ul></li><li><a href="#442-批量消费" class="table-of-contents__link toc-highlight">4.4.2 批量消费</a><ul><li><a href="#介绍-1" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#配置类-2" class="table-of-contents__link toc-highlight">配置类</a></li><li><a href="#消费者-4" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li></ul></li><li><a href="#45-消费重试" class="table-of-contents__link toc-highlight">4.5 消费重试</a><ul><li><a href="#介绍-2" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#spring-amqp-是怎么提供消费重试功能的" class="table-of-contents__link toc-highlight">Spring AMQP 是怎么提供消费重试功能的</a></li><li><a href="#配置applicationyml" class="table-of-contents__link toc-highlight">配置（<code>application.yml</code>）</a></li></ul></li><li><a href="#46-并发消费" class="table-of-contents__link toc-highlight">4.6 并发消费</a><ul><li><a href="#介绍-3" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#spring-amqp-的容器类型containertype" class="table-of-contents__link toc-highlight">Spring AMQP 的容器类型（<code>ContainerType</code>）</a></li><li><a href="#配置applicationyml-1" class="table-of-contents__link toc-highlight">配置（<code>application.yml</code>）</a></li><li><a href="#消费者-5" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li><li><a href="#47-事务消息" class="table-of-contents__link toc-highlight">4.7 事务消息</a><ul><li><a href="#配置" class="table-of-contents__link toc-highlight">配置</a></li></ul></li><li><a href="#48-消息异常处理器" class="table-of-contents__link toc-highlight">4.8 消息异常处理器</a><ul><li><a href="#介绍-4" class="table-of-contents__link toc-highlight">介绍</a></li><li><a href="#rabbitlistenererrorhandler配置" class="table-of-contents__link toc-highlight"><code>RabbitListenerErrorHandler</code>配置</a></li><li><a href="#errorhandler-配置" class="table-of-contents__link toc-highlight"><code>ErrorHandler</code> 配置</a></li></ul></li></ul></li><li><a href="#五消息应答" class="table-of-contents__link toc-highlight">五、消息应答</a><ul><li><a href="#51-概念" class="table-of-contents__link toc-highlight">5.1 概念</a></li><li><a href="#52-自动应答" class="table-of-contents__link toc-highlight">5.2 自动应答</a></li><li><a href="#53-手动应答" class="table-of-contents__link toc-highlight">5.3 手动应答</a><ul><li><a href="#消息应答方法" class="table-of-contents__link toc-highlight">消息应答方法</a></li><li><a href="#批量应答" class="table-of-contents__link toc-highlight">批量应答</a></li><li><a href="#消息自动重新入队" class="table-of-contents__link toc-highlight">消息自动重新入队</a></li></ul></li></ul></li><li><a href="#六工作队列" class="table-of-contents__link toc-highlight">六、工作队列</a><ul><li><a href="#61-概念" class="table-of-contents__link toc-highlight">6.1 概念</a></li><li><a href="#62-轮询分发" class="table-of-contents__link toc-highlight">6.2 轮询分发</a></li><li><a href="#63-公平分发" class="table-of-contents__link toc-highlight">6.3 公平分发</a></li><li><a href="#64-预取数" class="table-of-contents__link toc-highlight">6.4 预取数</a></li></ul></li><li><a href="#七rabbitmq-持久化" class="table-of-contents__link toc-highlight">七、RabbitMQ 持久化</a><ul><li><a href="#71-概念" class="table-of-contents__link toc-highlight">7.1 概念</a></li><li><a href="#72-队列持久化" class="table-of-contents__link toc-highlight">7.2 队列持久化</a></li><li><a href="#73-消息持久化" class="table-of-contents__link toc-highlight">7.3 消息持久化</a></li></ul></li><li><a href="#八事务机制" class="table-of-contents__link toc-highlight">八、事务机制</a><ul><li><a href="#81-概念" class="table-of-contents__link toc-highlight">8.1 概念</a></li><li><a href="#82-介绍" class="table-of-contents__link toc-highlight">8.2 介绍</a></li><li><a href="#82-关键代码" class="table-of-contents__link toc-highlight">8.2 关键代码</a></li><li><a href="#83-问题" class="table-of-contents__link toc-highlight">8.3 问题</a></li></ul></li><li><a href="#九发布确认机制" class="table-of-contents__link toc-highlight">九、发布确认机制</a><ul><li><a href="#91-概念" class="table-of-contents__link toc-highlight">9.1 概念</a></li><li><a href="#92-mandatory-参数" class="table-of-contents__link toc-highlight">9.2 <code>mandatory</code> 参数</a></li><li><a href="#93-备份交换机" class="table-of-contents__link toc-highlight">9.3 备份交换机</a></li></ul></li><li><a href="#十死信队列" class="table-of-contents__link toc-highlight">十、死信队列</a><ul><li><a href="#101-概念" class="table-of-contents__link toc-highlight">10.1 概念</a></li><li><a href="#102-死信的来源" class="table-of-contents__link toc-highlight">10.2 死信的来源</a></li><li><a href="#103-示例" class="table-of-contents__link toc-highlight">10.3 示例</a><ul><li><a href="#生产者-9" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#普通消费者" class="table-of-contents__link toc-highlight">普通消费者</a></li><li><a href="#死信消费者" class="table-of-contents__link toc-highlight">死信消费者</a></li></ul></li></ul></li><li><a href="#十一延迟队列" class="table-of-contents__link toc-highlight">十一、延迟队列</a><ul><li><a href="#111-概念" class="table-of-contents__link toc-highlight">11.1 概念</a></li><li><a href="#112-使用场景" class="table-of-contents__link toc-highlight">11.2 使用场景</a></li><li><a href="#113-rabbitmq-中的-ttl" class="table-of-contents__link toc-highlight">11.3 RabbitMQ 中的 TTL</a><ul><li><a href="#概念" class="table-of-contents__link toc-highlight">概念</a></li><li><a href="#两者区别" class="table-of-contents__link toc-highlight">两者区别</a></li></ul></li><li><a href="#114-延迟队列插件" class="table-of-contents__link toc-highlight">11.4 延迟队列插件</a><ul><li><a href="#安装插件" class="table-of-contents__link toc-highlight">安装插件</a></li><li><a href="#生产者-10" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-6" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li></ul></li><li><a href="#十二幂等性" class="table-of-contents__link toc-highlight">十二、幂等性</a><ul><li><a href="#121-概念" class="table-of-contents__link toc-highlight">12.1 概念</a></li><li><a href="#122-消息重复消费" class="table-of-contents__link toc-highlight">12.2 消息重复消费</a></li><li><a href="#123-解决思路" class="table-of-contents__link toc-highlight">12.3 解决思路</a></li><li><a href="#124-消费端的幂等性保障" class="table-of-contents__link toc-highlight">12.4 消费端的幂等性保障</a></li></ul></li><li><a href="#十三优先级队列" class="table-of-contents__link toc-highlight">十三、优先级队列</a><ul><li><a href="#131-添加优先级" class="table-of-contents__link toc-highlight">13.1 添加优先级</a></li></ul></li><li><a href="#十四惰性队列" class="table-of-contents__link toc-highlight">十四、惰性队列</a><ul><li><a href="#141-使用场景" class="table-of-contents__link toc-highlight">14.1 使用场景</a></li><li><a href="#142-设置惰性队列" class="table-of-contents__link toc-highlight">14.2 设置惰性队列</a></li></ul></li><li><a href="#十五集群" class="table-of-contents__link toc-highlight">十五、集群</a><ul><li><a href="#151-clustering" class="table-of-contents__link toc-highlight">15.1 Clustering</a><ul><li><a href="#三个节点" class="table-of-contents__link toc-highlight">三个节点</a></li><li><a href="#各节点正常安装" class="table-of-contents__link toc-highlight">各节点正常安装</a></li><li><a href="#确保各几点的erlangcookie-相同" class="table-of-contents__link toc-highlight">确保各几点的<code>.erlang.cookie</code> 相同</a></li><li><a href="#加入集群ubuntu102ubuntu103" class="table-of-contents__link toc-highlight">加入集群（<code>ubuntu102</code>、<code>ubuntu103</code>）</a></li></ul></li><li><a href="#152-镜像队列" class="table-of-contents__link toc-highlight">15.2 镜像队列</a><ul><li><a href="#原因" class="table-of-contents__link toc-highlight">原因</a></li><li><a href="#搭建步骤" class="table-of-contents__link toc-highlight">搭建步骤</a></li><li><a href="#效果-6" class="table-of-contents__link toc-highlight">效果</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with Docusaurus</div></div></div></footer></div>
<script src="/assets/js/runtime~main.58528b02.js"></script>
<script src="/assets/js/main.4546e038.js"></script>
</body>
</html>