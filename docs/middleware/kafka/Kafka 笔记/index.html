<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-middleware/kafka/Kafka 笔记">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Kafka 笔记 | 十二翼堕落天使</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docusaurus.demo.icefery.github.io/docs/middleware/kafka/Kafka 笔记"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Kafka 笔记 | 十二翼堕落天使"><meta data-rh="true" name="description" content="什么是 MQ"><meta data-rh="true" property="og:description" content="什么是 MQ"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docusaurus.demo.icefery.github.io/docs/middleware/kafka/Kafka 笔记"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/middleware/kafka/Kafka 笔记" hreflang="en"><link data-rh="true" rel="alternate" href="https://docusaurus.demo.icefery.github.io/docs/middleware/kafka/Kafka 笔记" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="十二翼堕落天使 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="十二翼堕落天使 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.37273cda.css">
<link rel="preload" href="/assets/js/runtime~main.58528b02.js" as="script">
<link rel="preload" href="/assets/js/main.4546e038.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/favicon.ico" alt="" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">十二翼多堕落天使</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">文档</a></div><div class="navbar__items navbar__items--right"><a href="https://blog.csdn.net/XY1790026787" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">CSDN<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><a href="https://github.com/icefery/demo.icefery.xyz" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/algorithm/">算法</a><button aria-label="Toggle the collapsible sidebar category &#x27;算法&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/architecture/">架构</a><button aria-label="Toggle the collapsible sidebar category &#x27;架构&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/backend/">后端</a><button aria-label="Toggle the collapsible sidebar category &#x27;后端&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/big-data/">大数据</a><button aria-label="Toggle the collapsible sidebar category &#x27;大数据&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/build-tool/">构建工具</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/container/">容器</a><button aria-label="Toggle the collapsible sidebar category &#x27;容器&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/container-app/clash/">container-app</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/db/">数据库</a><button aria-label="Toggle the collapsible sidebar category &#x27;数据库&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/docs/frontend/vue/">frontend</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/gui/">GUI</a><button aria-label="Toggle the collapsible sidebar category &#x27;GUI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/">概览</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/lang/">Lang</a><button aria-label="Toggle the collapsible sidebar category &#x27;Lang&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/latex/">LaTex</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/load-balance/">负载均衡</a><button aria-label="Toggle the collapsible sidebar category &#x27;负载均衡&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/middleware/">中间件</a><button aria-label="Toggle the collapsible sidebar category &#x27;中间件&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs/middleware/kafka/">Kafka</a><button aria-label="Toggle the collapsible sidebar category &#x27;Kafka&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/middleware/kafka/Kafka 笔记">Kafka 笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/middleware/kafka/kafka-3 kraft 模式安装">kafka-3 kraft 模式安装</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs/middleware/rabbitmq/">RabbitMQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;RabbitMQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/middleware/shardingsphere/">ShardingSphere</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/network/">计算机网络</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/os/">操作系统</a><button aria-label="Toggle the collapsible sidebar category &#x27;操作系统&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/regexp/">正则表达式</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/software/">软件</a><button aria-label="Toggle the collapsible sidebar category &#x27;软件&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/version-control/">版本控制</a><button aria-label="Toggle the collapsible sidebar category &#x27;版本控制&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/middleware/"><span itemprop="name">中间件</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/middleware/kafka/"><span itemprop="name">Kafka</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Kafka 笔记</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Kafka 笔记</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="什么是-mq">什么是 MQ<a class="hash-link" href="#什么是-mq" title="Direct link to heading">​</a></h2><p>很多人都说：MQ 通过讲消息的发送和接收分离来实现应用程序的异步和解耦，这个给人的直觉是——MQ 就是异步的，是用来解耦的，但这个只是 MQ 的效果而不是目的。MQ 真正的目的是为了通讯，屏蔽底层复杂的通讯协议，定义了一套应用层的更加简单的通讯协议。</p><p>一个分布式系统中两个模块之间通讯要么是 HTTP，要么是自己开发的 TCP，但是这两种协议其实都是原始的协议。HTTP 协议很难实现两端通讯——模块 A 可以调用 B，B 也可以主动调用 A，如果要做到这个，两端都要背上 WebServer，而且还不长连接（HTTP 2.0 的库根本找不到）。TCP 就更加原始了，粘包、心跳、私有的协议，想一想就头皮发麻。</p><p>MQ 所要做的就是在这些协议之上构建一个简单的“协议”——生产者 / 消费者模型。MQ 带给我们的“协议”不是具体的通讯协议，而是更高层次的通讯模型。</p><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="消息队列的流派">消息队列的流派<a class="hash-link" href="#消息队列的流派" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="有-broker-的-mq">有 Broker 的 MQ<a class="hash-link" href="#有-broker-的-mq" title="Direct link to heading">​</a></h3><p>这个流派通常有一台服务器作为 Broker，所有的消息都通过它中转。生产者把消息发送给它就结束自己的任务了，Broker 则把消息主动推给消费者（或者消费者主动轮询）</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="重-topic-kafkaactivemqjms">重 Topic （Kafka、ActiveMQ、JMS）<a class="hash-link" href="#重-topic-kafkaactivemqjms" title="Direct link to heading">​</a></h4><p>生产者会发送 Key 和数据到 Broker，由 Broker 比较 Key 之后决定给哪个消费者。这种模式是我们最常见的模式，是我们对 MQ 最多的印象。在这种模式下，一个 Topic 往往是一个比较大的概念，甚至一个系统中就可能只有一个 Topic，Topic 某种意义上就是 Queue，生产者发送 Key 相当于说：“Hi，把数据放到 Key 的队列中”。</p><blockquote><p>虽然架构一样但是 Kafka 的性能要比 JMS 的性能不知道高多少倍，所以基本上这种类型的 MQ 只有 Kafka 一种备选方案。</p></blockquote><h4 class="anchor anchorWithStickyNavbar_LWe7" id="轻-topicrabbitmq-或者-amqp-协议">轻 Topic（RabbitMQ 或者 AMQP 协议）<a class="hash-link" href="#轻-topicrabbitmq-或者-amqp-协议" title="Direct link to heading">​</a></h4><p>生产者发送 Key 和数据，消费者定义订阅的队列，Broker 收到数据之后会通过一定的逻辑计算出 Key 对应的队列，然后把数据交给队列。</p><p>这种模式下解耦了 Key 和 Queue，在这种架构中 Queue 是非常轻量级的（在 RabbitMQ 中它的上限取决于你的内存），消费者关心的知识自己的 Queue，生产者不必关心数据最终给谁，只要指定 Key 就行了，中间的那层映射在 QMQO 中叫做 Exchange。</p><p>AMQP 中有四种 Exchange：</p><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">Direct Exchange</td><td align="left">Key 就等于 Queue</td></tr><tr><td align="left">Fanout Exchange</td><td align="left">无视 Key，给所有的 Queue 都来一份</td></tr><tr><td align="left">Topic Exchange</td><td align="left">Key 可以用“宽字符”模糊匹配 Queue</td></tr><tr><td align="left">Header Exchange</td><td align="left">无视 Key，通过查看消息的头部元数据来决定发给哪个 Queue（AMQP 头部元数据非常丰富并且可以自定义）</td></tr></tbody></table><p>这种结构的架构给通讯带来了很大的灵活性，我们能想到的通讯方式都可以用这四种 Exchange 表达出来。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="无-broker-的-mq">无 Broker 的 MQ<a class="hash-link" href="#无-broker-的-mq" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="zeromq">ZeroMQ<a class="hash-link" href="#zeromq" title="Direct link to heading">​</a></h4><p>无 Broker 的 MQ 的代表是 ZeroMQ。该作者非常睿智，他非常敏锐的意识到——MQ 是更高级的 Socket，它是解决通讯问题的，所以 ZeroMQ 被设计成了一个“库”而不是一个中间件。</p><p>节点之间通讯的消息都是发送到彼此的队列中，每个节点都既是生产者又是消费者。ZeroMQ 做的事情就是封装出一套类似于 Socket 的 API，可以完成发送数据、读取数据。</p><p>ZeroMQ 其实就是一个跨语言的、重量级的 Actor 模型邮箱库。你可以把自己的程序想象成一个 Actor，ZeroMQ 就是提供邮箱功能的库。ZeroMQ 可以实现同一台机器的 RPC 通讯也可以实现不同机器上的 TCP、UDP 通讯。</p><blockquote><p>如果你需要一个强大的、灵活、野蛮的通讯能力，别犹豫 ZeroMQ。</p></blockquote><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-介绍">Kafka 介绍<a class="hash-link" href="#kafka-介绍" title="Direct link to heading">​</a></h2><p>Kafka 最初由 LinkedIn 公司开发，是一个分布式的、支持分区的（Partition）、多副本的（Replica）、基于 Zookeeper 协调的消息系统，它最大的特性就是可以实时的处理大量数据以满足各种需求场景。由 Scala 语言编写，LinkedIn 与 2010 年贡献给了 Apache 基金会并成为顶级开源项目。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-的使用场景">Kafka 的使用场景<a class="hash-link" href="#kafka-的使用场景" title="Direct link to heading">​</a></h3><ul><li><p>日志收集</p><blockquote><p>一个公司可以用 Kafka 收集各种服务的 Log，通过 Kafka 以统一接口服务的方式开放给各种 Consumer，例如 Hadoop、HBase、Solr 等。</p></blockquote></li><li><p>消息系统：</p><blockquote><p>解耦生产者和消费者、缓存消息等。</p></blockquote></li><li><p>用户活动跟踪</p><blockquote><p>Kafka 经常被用来记录 Web 用户或者 app 用户的各种活动，如浏览网页、搜索、点击等活动，这些活动信息被各个服务器发吧到 Kafka 的 Topic 中，然后订阅者通过订阅这些 Topic 来做实时的监控分析，后者装载到 Hadoop、数据仓库中做离线分析和挖掘。</p></blockquote></li><li><p>运营指标</p><blockquote><p>Kafka 也经常被用来记录运营监控数据，包括收集各种分布式应用的数据，生产各种操作的集中反馈，比如报警和报告。</p></blockquote></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-的基本概念">Kafka 的基本概念<a class="hash-link" href="#kafka-的基本概念" title="Direct link to heading">​</a></h3><p>Kafka 是一个分布式的，分区的消息服务（官方称之为 Commit Log），它提供一个消息系统应该具备的功能，但是却有着独特的设计。</p><blockquote><p>可以这样来说，Kafka 借鉴了 JMS 规范的思想，但是确并没有完全遵循 JMS 规范。</p></blockquote><p>基础的消息相关术语：</p><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">Broker</td><td align="left">消息中间件处理节点，一个 Kafka 节点就是一个 Broker，一个或者多个 Broker 可以组成一个 Kafka 集群</td></tr><tr><td align="left">Topic</td><td align="left">Kafka 根据 Topic 对消息进行归类，发布到 Kafka 集群的每条消息都需要指定一个 Topic</td></tr><tr><td align="left">Producer</td><td align="left">消息生产者，向 Broker 发送消息的客户端</td></tr><tr><td align="left">Consumer</td><td align="left">消息消费者，从 Broker 读取消息的客户端</td></tr><tr><td align="left">Consumer Group</td><td align="left">每个 Consumer 属于一个特定的 Consumer Group，一条消息可以被多个不同的 Consumer Group 消费，但是一个 Consumer Group 中只能有一个 Consumer 能够消费该消息</td></tr><tr><td align="left">Partition</td><td align="left">物理上的概念，一个 Topic 可以分为多个 Partition，每个 Partition 内部消息是有序的</td></tr></tbody></table><p>服务端（Broker）和客户端（Producer、Consumer）之间通信通过 TCP 协议来完成。</p><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-安装">Kafka 安装<a class="hash-link" href="#kafka-安装" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="环境准备">环境准备<a class="hash-link" href="#环境准备" title="Direct link to heading">​</a></h3><ul><li>jdk</li><li>zookeeper</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件">配置文件<a class="hash-link" href="#配置文件" title="Direct link to heading">​</a></h3><ul><li><p><code>config/server.properties</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># The id of the broker. This must be set to a unique integer for each broker.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">broker.id=6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Hostname and port the broker will advertise to producers and consumers.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">advertised.listeners=PLAINTEXT://192.192.192.6:9092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># A comma separated list of directories under which to store log files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">log.dirs=/opt/kafka/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Zookeeperi connection string.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">zookeeper.connect=192.192.192.6:2181</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="启动-kafka-服务器">启动 Kafka 服务器<a class="hash-link" href="#启动-kafka-服务器" title="Direct link to heading">​</a></h3><ul><li>启动 Zookeeper<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /opt/zookeeper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/zkServer.sh start</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>启动 Kafka<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /opt/kafka</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-server-start.sh -daemon config/server.properties</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>验证是否启动成功（进入 ZK 查看指定 ID 的 Broker 是否存在）<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">cd</span><span class="token plain"> /opt/zookeeper</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/zkCli.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">ls</span><span class="token plain"> /brokers/ids</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建主题发送消息消费消息">创建主题、发送消息、消费消息<a class="hash-link" href="#创建主题发送消息消费消息" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 创建主题</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-topics.sh --create --bootstrap-server localhost:9092 --replication-factor </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --partitions </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> --topic </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 查看 Kafka 有哪些 Topic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-topics.sh --list --bootstrap-server localhost:9092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 发送消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic </span><span class="token builtin class-name">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 消费最新消息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 从头开始消费</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic </span><span class="token builtin class-name">test</span><span class="token plain"> --from-beginning</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="关于消息的细节">关于消息的细节<a class="hash-link" href="#关于消息的细节" title="Direct link to heading">​</a></h3><ul><li>生产者将消息发送给 Broker，Broker 会将消息保存在本地的日志文件中<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/opt/kafka/data/&lt;主题&gt;-&lt;分区&gt;/00000000000000000000.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>消息的保存是有序的，通过 Offset 偏移量来描述消息的有序性</li><li>消费者消费消息时也是通过 Offset 来描述当前要消费的那条消息的位置</li></ul><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="单播消息和多播消息">单播消息和多播消息<a class="hash-link" href="#单播消息和多播消息" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="单播消息">单播消息<a class="hash-link" href="#单播消息" title="Direct link to heading">​</a></h3><p>在一个 Kafka 的 Topic 中，启动两个消费者和一个生产者，问：生产者发送消息，这条消息是否同时会被两个消费者消费？</p><p>如果两个消费者在同一个消费组，那么只有一个消费者可以收到订阅的 Topic 中的消息。</p><blockquote><p>换言之，同一个消费组中只能有一个消费者收到一个 Topic 中的消息。</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic </span><span class="token builtin class-name">test</span><span class="token plain"> --consumer-property group.id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test-group</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="多播消息">多播消息<a class="hash-link" href="#多播消息" title="Direct link to heading">​</a></h3><p>不同的消费组订阅同一个 Topic，那么不同的消费组中只有一个消费者能收到消息。</p><blockquote><p>实际上也是多个消费组中的多个消费者收到了同一个消息。</p></blockquote><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic </span><span class="token builtin class-name">test</span><span class="token plain"> --consumer-property group.id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test-group-1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic </span><span class="token builtin class-name">test</span><span class="token plain"> --consumer-property group.id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">test-group-2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="查看消费组的详细信息">查看消费组的详细信息<a class="hash-link" href="#查看消费组的详细信息" title="Direct link to heading">​</a></h3><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-consumer-groups.sh --describe --bootstrap-server localhost:9092 --group test-group</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://img-blog.csdnimg.cn/420ec442ebd54c4784c9fe11a82a1573.png" alt="请添加图片描述" class="img_ev3q"></p><p>重点关注以下几个信息：</p><table><thead><tr><th></th><th align="left"></th></tr></thead><tbody><tr><td>CURRENT-OFFSET</td><td align="left">最后被消费的消息的偏移量</td></tr><tr><td>LOG-END-OFFSET</td><td align="left">最后一条消息的偏移量（消息总量）</td></tr><tr><td>LAG</td><td align="left">积压了多少条消息</td></tr></tbody></table><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-中主题和分区的概念">Kafka 中主题和分区的概念<a class="hash-link" href="#kafka-中主题和分区的概念" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="主题">主题<a class="hash-link" href="#主题" title="Direct link to heading">​</a></h3><p>Topic 在 Kafka 中是一个逻辑的概念，Kafka 通过 Topic 将消息进行分类，不同的 Topic 会被订阅该 Topic 的消费者消费。</p><p>但是有一个问题，如果说这个 Topic 中的消息非常非常多，因为消息是会被保存到 Log 日志文件中的，为了解决这个文件过大的问题， Kafka 提出了 Partition 的概念。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="分区">分区<a class="hash-link" href="#分区" title="Direct link to heading">​</a></h3><p>通过 Partition 将一个 Topic 中的消息分区来存储。这样的好处有多个：</p><ul><li>分区存储，可以解决存储文件过大的问题</li><li>提供了读写的吞吐量，读和写可以同时在多个分区中进行</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-中消息日志文件中保存的内容">Kafka 中消息日志文件中保存的内容<a class="hash-link" href="#kafka-中消息日志文件中保存的内容" title="Direct link to heading">​</a></h3><ul><li><p><code>00000000000000000000.log</code></p><blockquote><p>这个文件中保存的就是消息。文件中保存的消息，默认保存 7 天，7 天后消息会被删除。</p></blockquote></li><li><p><code>__consumer_offsets-49</code></p><blockquote><p>Kafka 内部创建了<code>__consumer_offsets</code> 主题，包含了 50 个分区，这个主题用来存放消费者消费某个主题的偏移量。每个消费者会把消费的主题的偏移量自主上报给 Kafka 的默认主题 <code>__consumer_offsets</code>，因此 Kafka 为了提升这个主题的并发性，默认设置了 50 个分区。</p></blockquote><ul><li><p>提交到哪个分区</p><blockquote><p>通过 Hash 函数 <code>hash(&lt;Consumer Group ID&gt;) % &lt;__consumer_offsets 主题的分区数&gt;</code></p></blockquote></li><li><p>提交到该主题的内容</p><blockquote><p>Key 为 <code>&lt;Consumer Group ID&gt;</code> + <code>&lt;Topic&gt;</code> + <code>&lt;分区号&gt;</code>，Value 就是当前 Offset 的值</p></blockquote></li></ul></li></ul><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-集群操作">Kafka 集群操作<a class="hash-link" href="#kafka-集群操作" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="副本的概念">副本的概念<a class="hash-link" href="#副本的概念" title="Direct link to heading">​</a></h3><p>副本是为了主题中的分区创建多个备份，在 Kafka 集群的多个 Broker 中，会有一个副本作为 Leader，其它是 Follower。</p><p>查看 Topic 情况：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">bin/kafka-topics.sh --describe --bootstrap-server localhost:9092 --topic my-replicated-topic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left">Leader</td><td align="left">Kafka 的写和读的操作，都发生在 Leader 上。Leader 负责把数据同步给 Follower。当 Leader 挂了，经过主从选举，从多个 Follower 中选举一个新的 Leader</td></tr><tr><td align="left">Follower</td><td align="left">接收 Leader 的同步的数据</td></tr><tr><td align="left">Isr</td><td align="left">可以同步和已同步的节点会被放入到 Isr 集群。如果 Isr 中的节点性能较差，会被踢出 Isr 集合</td></tr></tbody></table><p>集群中有多个 Broker，创建主题时可以指明主题有多少个分区（把消息拆分到不同的分区中存储），可以为分区创建多个副本，不同的副本存放在不同的 Broker 里。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群消费中分区分消费组的细节">集群消费中分区分消费组的细节<a class="hash-link" href="#集群消费中分区分消费组的细节" title="Direct link to heading">​</a></h3><ul><li>一个 Parittion 只能被一个消费组中的一个消费者消费，目的是为了保证消息的顺序性，但是多个 Partition 的多个消费者消费的总顺序是得不到保证的。</li><li>Partition 的数量决定了消费组中消费者的数量，建议同一个消费者的数量不要超过 Partition 的数量，否则多的消费者消费不到消息。</li><li>如果消费者挂了，那么就会触发 Rebalance 机制，会让其它消费者来消费该分区。</li></ul><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="客户端-api">客户端 API<a class="hash-link" href="#客户端-api" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依赖">依赖<a class="hash-link" href="#依赖" title="Direct link to heading">​</a></h3><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.kafka</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">kafka-clients</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">3.0.0</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="生产者">生产者<a class="hash-link" href="#生产者" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyProducer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) throws Exception {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;192.192.192.6:9092&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建生产者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Producer&lt;String, String&gt; producer = new KafkaProducer&lt;&gt;(props);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ProducerRecord&lt;String, String&gt; record = new ProducerRecord&lt;&gt;(&quot;my-topic&quot;, &quot;my-key&quot;, &quot;my-value&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 发送消息</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Future&lt;RecordMetadata&gt; future = producer.send(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 获取消息发送的元数据</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RecordMetadata metadata = future.get();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;topic=%s partition=%d offset=%d\n&quot;, metadata.topic(), metadata.partition(), metadata.offset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者的同步发送消息">生产者的同步发送消息<a class="hash-link" href="#生产者的同步发送消息" title="Direct link to heading">​</a></h4><p>如果生产者发送消息没有收到 Ack，生产者会阻塞，阻塞到 3s 的时间，如果还没有收到消息，会进行重试，重试的次数为 3 次。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Future&lt;RecordMetadata&gt; future = producer.send(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RecordMetadata metadata = future.get();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者的异步发送消息">生产者的异步发送消息<a class="hash-link" href="#生产者的异步发送消息" title="Direct link to heading">​</a></h4><p>异步发送，生产者发送完消息后就可以执行之后的业务，Broker 在收到 消息后异步调用生产者提供的 Callback 回调方法。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">producer.send(record, (RecordMetadata metadata, Exception e) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (e != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(&quot;消息发送失败&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">});</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者中-ack-配置">生产者中 Ack 配置<a class="hash-link" href="#生产者中-ack-配置" title="Direct link to heading">​</a></h4><p>在同步发送的前提下，生产者在获得集群返回的 Ack 之前会一直阻塞，那么集群什么时候返回 Ack 呢？此时 Ack 有 3 个配置：</p><ul><li><p><code>ack=0</code></p><blockquote><p>Kafka 集群不需要任何的 Broker 收到消息，就立刻返回 Ack 给生产者。最容易丢消息，效率最高。</p></blockquote></li><li><p><code>ack=1</code>（默认）</p><blockquote><p>多副本之间的 Leader 已经收到消息，并把消息写入到本地的 Log 中，才会返回 Ack 给生产者。性能和安全性是最均衡的。</p></blockquote></li><li><p><code>ack=-1</code> / <code>ack=all</code></p><blockquote><p>有配置 <code>min.insync.replicas=2</code>（默认为 1，推荐配置大于等于 2），此时就需要 Leader 和一个 Follower 同步完后，才会返回 Ack 给生产者，此时集群中有 2 个 Broker 已完成数据的接收。这种方式最安全，但性能最差。</p></blockquote></li></ul><p>下面是关于 Ack 和重试的配置（如果没有收到 Ack 就开启重试）：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.ACKS_CONFIG, &quot;1&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.RETRIES_CONFIG, 3);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 重试间隔设置（发送失败会重试，默认间隔 100ms，重试能保证消息发送的可靠性，但是也可能造成消息重复发送，比如网络抖动，所以需要再接收者那边做好消息接收的幂等性处理）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.RETRY_BACKOFF_MS_CONFIG, 100);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="关于消息发送的缓冲区">关于消息发送的缓冲区<a class="hash-link" href="#关于消息发送的缓冲区" title="Direct link to heading">​</a></h4><ul><li>Kafka 默认会创建一个消息缓冲区，用来存放要发送的消息，缓冲区是 32m<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, 33554432);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>Kafka 本地线程会去缓冲区中一次拉 16k 的数据发送给 Broker<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.BATCH_SIZE_CONFIG, 16384);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>如果线程拉不到 16k 的数据，间隔 10ms 也会将已拉到的数据发送给 Broker<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ProducerConfig.LINGER_MS_CONFIG, 10);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="消费者">消费者<a class="hash-link" href="#消费者" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public static void main(String[] args) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 设置参数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Properties props = new Properties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;192.192.192.6:9092&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 消费组</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        props.put(ConsumerConfig.GROUP_ID_CONFIG, &quot;test-group&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 创建消费者客户端</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        KafkaConsumer&lt;String, String&gt; consumer = new KafkaConsumer&lt;&gt;(props);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 消费者订阅主题列表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.subscribe(List.of(&quot;test&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // poll() 是拉取消息的长轮询</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(1000));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            for (ConsumerRecord&lt;String, String&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                System.out.printf(&quot;partitoin=%d offset=%d key=%s value=%s\n&quot;, record.partition(), record.offset(), record.key(), record.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="关于消费者自动提交和手动提交-offset">关于消费者自动提交和手动提交 Offset<a class="hash-link" href="#关于消费者自动提交和手动提交-offset" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_LWe7" id="提交的内容">提交的内容<a class="hash-link" href="#提交的内容" title="Direct link to heading">​</a></h5><p>消费者无论是自动提交还是手动提交，都需要把所属的消费组 + 消费的主题 + 消费的分区 + 消费的偏移量这样的信息提交到集群的 <code>__consumer_offsets</code> 主题里面。</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="自动提交">自动提交<a class="hash-link" href="#自动提交" title="Direct link to heading">​</a></h5><p>消费者 <code>poll</code> 消息下来后就会自动提交 Offset。自动提交会丢消息，因为消费者在消费前提交 Offset，有可能提交完后还没消费就挂了。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 是否自动提交 Offset（默认为 true）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, &quot;true&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 自动提交 Offset 的间隔时间</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.AUTO_COMMIT_INTERVAL_MS_CONFIG, &quot;1000&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h5 class="anchor anchorWithStickyNavbar_LWe7" id="手动提交">手动提交<a class="hash-link" href="#手动提交" title="Direct link to heading">​</a></h5><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, &quot;false&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>手动提交又分成了两种：</p><ul><li>手动同步提交<blockquote><p>在消费完消息后调用同步提交的方法，当集群返回 Ack 前一直阻塞，返回 Ack 后表示提交成功，执行之后的逻辑。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(1000));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ConsumerRecord&lt;String, String&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;partitoin=%d offset=%d key=%s value=%s\n&quot;, record.partition(), record.offset(), record.key(), record.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (records.count() &gt; 0) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 手动同步提交 Offset，当前线程会阻塞，直到 Offset 提交成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        consumer.commitAsync();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote></li><li>手动异步提交<blockquote><p>在消息消费完后提交，不需要等集群 Ack，直接执行之后的逻辑，可以设置一个回调方法供集群调用。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">while (true) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsumerRecords&lt;String, String&gt; records = consumer.poll(Duration.ofMillis(1000));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    for (ConsumerRecord&lt;String, String&gt; record : records) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.printf(&quot;partitoin=%d offset=%d key=%s value=%s\n&quot;, record.partition(), record.offset(), record.key(), record.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    consumer.commitAsync((Map&lt;TopicPartition, OffsetAndMetadata&gt; offsets, Exception e) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (e != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            System.out.println(&quot;提交失败&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="长轮询-poll-消息">长轮询 <code>poll</code> 消息<a class="hash-link" href="#长轮询-poll-消息" title="Direct link to heading">​</a></h4><p>默认情况下，消费者一次会 <code>poll</code> 500 条消息。代码中设置了长轮询的时间为 1000 毫秒，意味着：</p><ul><li>如果一次 <code>poll</code> 到 500 条，就直接执行 <code>for</code> 循环</li><li>如果这一次没有 <code>poll</code> 到 500 条，且时间在 1 秒内，那么长轮询继续 <code>poll</code>，要么到 500 条，要么到 1 秒</li><li>如果两次 <code>poll</code> 都没到 500 条，且 1 秒时间到了，那么直接执行 <code>for</code> 循环</li></ul><p>如果两次 <code>poll</code> 的间隔超过 30 秒，集群会认为该消费者的消费能力过弱，该消费者会被踢出消费组，触发 Rebalance 机制，Rebalance 机制会造成性能开销。可以通过设置这个参数，让一次 <code>poll</code> 的消息少一点：</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.MAX_POLL_RECORDS_CONFIG, 500);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG, 30 * 1000);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者的健康状态检查">消费者的健康状态检查<a class="hash-link" href="#消费者的健康状态检查" title="Direct link to heading">​</a></h4><p>消费者每隔 1 秒向 Kafka 集群发送心跳，集群发现如果有超过 10 秒没有续约的消费者，将踢出消费组，触发该消费组的 Rebalance 机制，将分区交给消费组里的其它消费者进行消费。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.HEARTBEAT_INTERVAL_MS_CONFIG, 1000);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.SESSION_TIMEOUT_MS_CONFIG, 10 * 1000);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="指定分区偏移量时间消费">指定分区、偏移量、时间消费<a class="hash-link" href="#指定分区偏移量时间消费" title="Direct link to heading">​</a></h4><ul><li>指定分区消费<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">consumer.assign(List.of(new TopicPartition(&quot;test&quot;, 0)));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>指定 Offset 消费<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 从头消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer.seekToBeginning(List.of(new TopicPartition(&quot;test&quot;, 0)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 指定 Offset 消费</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer.seek(new TopicPartition(&quot;test&quot;, 0), 10);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li>指定时间消费<blockquote><p>根据时间，去所有的 Partition 中确定该时间对应的 Offset，然后去所有的 Partition 中找到该 Offset 之后的消息开始消费。</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// long timestamp = new Date().getTime() - 1000 * 60 * 60;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long timestamp = LocalDateTime.now().plusHours(-1).atZone(ZoneId.systemDefault()).toInstant().toEpochMilli();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;TopicPartition, Long&gt; timestampsToSearch = consumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .partitionsFor(topic)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .collect(Collectors.toMap(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (PartitionInfo it) -&gt; new TopicPartition(topic, it.partition()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (PartitionInfo it) -&gt; timestamp,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        (v1, v2) -&gt; v2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">consumer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .offsetsForTimes(timestampsToSearch)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    .forEach((TopicPartition key, OffsetAndTimestamp value) -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 如果查询偏移量的时间点大于最大的索引记录时间那么 value 就会为空</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        if (value != null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            // 根据 timestamp 确定 offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            long offset = value.offset();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumer.assign(List.of(key));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            consumer.seek(key, offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></blockquote></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="新消费组的消费-offset-规则">新消费组的消费 Offset 规则<a class="hash-link" href="#新消费组的消费-offset-规则" title="Direct link to heading">​</a></h4><p>新消费组中的消费者在启动以后，默认会从当前分区的最后一条消息的 <code>offset + 1</code> 开始消费（消费新消息）。通过以下的设置，让新的消费者第一次从头开始消费，之后开始消费新消息。</p><ul><li><p><code>latest</code>（默认）</p><blockquote><p>消费新消息。</p></blockquote></li><li><p><code>earliest</code></p><blockquote><p>第一次从头开始消费，之后开始消费新消息。这个需要区别于 <code>consumer.seekToBeginning()</code>（每次都从头开始消费）。</p></blockquote></li></ul><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">props.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="spring-boot-中使用-kafka">Spring Boot 中使用 Kafka<a class="hash-link" href="#spring-boot-中使用-kafka" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="依赖-1">依赖<a class="hash-link" href="#依赖-1" title="Direct link to heading">​</a></h3><div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.springframework.kafka</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">spring-kafka</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">2.8.1</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">version</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置文件-1">配置文件<a class="hash-link" href="#配置文件-1" title="Direct link to heading">​</a></h3><ul><li><p><code>application.properties</code></p><div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.bootstrap-servers=192.192.192.6:9092</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.producer.key-serializer=org.apache.kafka.common.serialization.StringSerializer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.producer.value-serializer=org.apache.kafka.common.serialization.StringSerializer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.producer.acks=1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.consumer.group-id=test-group</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.consumer.enable-auto-commit=false</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.consumer.auto-offset-reset=earliest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spring.kafka.listener.ack-mode=MANUAL_IMMEDIATE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><table><thead><tr><th align="left"></th><th align="left"></th></tr></thead><tbody><tr><td align="left"><code>RECORD</code></td><td align="left">当每一条记录被消费者监听器处理之后提交</td></tr><tr><td align="left"><code>BATCH</code></td><td align="left">当每一批 <code>poll</code> 的数据被消费者监听器处理之后提交</td></tr><tr><td align="left"><code>TIME</code></td><td align="left">当每一批 <code>poll</code> 的数据被消费者监听器处理之后，距离上次提交时间大于 <code>ack-time</code>时提交</td></tr><tr><td align="left"><code>COUNT</code></td><td align="left">当每一批 <code>poll</code> 的数据被消费者监听器处理之后，被处理的 Record 数量大于等于 <code>ack-count</code> 时提交</td></tr><tr><td align="left"><code>COUNT_TIME</code></td><td align="left"><code>TIME</code> 和 <code>COUNT</code> 有一个条件满足时提交</td></tr><tr><td align="left"><code>MANUAL</code></td><td align="left">当每一批 <code>poll</code> 的数据被消费者监听器处理之后，手动调用 <code>Acknowledgment.acknowledge()</code> 后提交</td></tr><tr><td align="left"><code>MANUAL_IMMEDIATE</code></td><td align="left">手动调用 <code>Acknowledgment.acknowledge()</code> 后立即提交</td></tr></tbody></table></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-1">生产者<a class="hash-link" href="#生产者-1" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@RestController</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyKafkaController {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private KafkaTemplate&lt;String, String&gt; kafkaTemplate;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @GetMapping(&quot;/send&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void send() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ListenableFuture&lt;SendResult&lt;String, String&gt;&gt; future = kafkaTemplate.send(&quot;test&quot;, 0, &quot;key&quot;, &quot;消息&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-1">消费者<a class="hash-link" href="#消费者-1" title="Direct link to heading">​</a></h3><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class MyConsumer {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @KafkaListener(topics = {&quot;test&quot;}, groupId = &quot;test-group&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void listen(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        System.out.println(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 手动提交 Offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ack.acknowledge();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者中配置主题分区偏移量">消费者中配置主题、分区、偏移量<a class="hash-link" href="#消费者中配置主题分区偏移量" title="Direct link to heading">​</a></h4><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@KafkaListener(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    groupId = &quot;test-group&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    topicPartitions = {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @TopicPartition(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            topic = &quot;topic-1&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            partitions = {&quot;0&quot;, &quot;1&quot;},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            partitionOffsets = {@PartitionOffset(partition = &quot;1&quot;, initialOffset = &quot;100&quot;)}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        @TopicPartition(topic = &quot;topic-2&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 同组下的消费者个数，即并发消费数，建议小于等于分区总数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    concurrency = &quot;3&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void listen(ConsumerRecord&lt;String, String&gt; record, Acknowledgment ack) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    System.out.println(record);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 手动提交 Offset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ack.acknowledge();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-集群中的-controllerrebalancehw">Kafka 集群中的 Controller、Rebalance、HW<a class="hash-link" href="#kafka-集群中的-controllerrebalancehw" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="controller">Controller<a class="hash-link" href="#controller" title="Direct link to heading">​</a></h3><p>每个 Broker 启东时会向 ZK 创建一个临时序号节点，获得的序号最小的那个 Broker 将会作为集群中的 Controller，负责：</p><ul><li>当集群中有一个副本的 Leader 挂掉，需要在集群中选举出一个新的 Leader，选举的规则是从 Isr 集合中最左边获得。</li><li>当集群中有 Broker 新增或减少，Controller 会同步信息给其它 Broker。</li><li>当集群中有分区新增或减少，Controller 会同步信息给其它 Broker。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="rebalance-机制">Rebalance 机制<a class="hash-link" href="#rebalance-机制" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="前提">前提<a class="hash-link" href="#前提" title="Direct link to heading">​</a></h4><p>消费组中的消费者没有指明分区来消费</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="触发的条件">触发的条件<a class="hash-link" href="#触发的条件" title="Direct link to heading">​</a></h4><p>当消费组中的消费者和分区的关系发生变化的时候</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="分区分配的策略">分区分配的策略<a class="hash-link" href="#分区分配的策略" title="Direct link to heading">​</a></h4><ul><li><p>Range</p><blockquote><p>根据公司计算得到每个消费者消费哪几个分区。前面的消费者是 <code>&lt;分区总数&gt; / (&lt;消费者数量&gt; + 1)</code>，之后的消费者是 <code>&lt;分区总数&gt; / &lt;消费者数量&gt;</code>。</p></blockquote></li><li><p>轮询</p></li><li><p>Sticky</p><blockquote><p>粘合策略，如果需要 Rebalance，会在之前已分配的基础上调至，不会改变之前的分配情况。如果这个没有策略没有开启，那么就要进行全部重新分配。建议开启。</p></blockquote></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hw-和-leo">HW 和 LEO<a class="hash-link" href="#hw-和-leo" title="Direct link to heading">​</a></h3><p>HW（High Watermark）俗称高水位，取一个 Partition 对应的 Isr 集合中最小的 LEO（LOG-END-OFFSET）作为 HW，Consumer 最多只能消费到 HW 所在的位置。另外每个 Replica 都有 HW，Leader 和 Follower 各自负责更新自己的 HW 状态。</p><p>对于 Leader 新写入的消息，Consumer 不能立刻消费，Leader 会等待该消息被所有 Isr 集合中的 Reolicas 同步后更新 HW，此时消息才能被 Consumer 消费。</p><p>这样就保证了如果 Leader 所在的 Broker 失效，但该消息仍然可以从新选举的 Leader 中获取，这样的目的是防止消息的丢失。</p><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-的优化问题">Kafka 的优化问题<a class="hash-link" href="#kafka-的优化问题" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何防止消息丢失">如何防止消息丢失<a class="hash-link" href="#如何防止消息丢失" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="生产者-2">生产者<a class="hash-link" href="#生产者-2" title="Direct link to heading">​</a></h4><ol><li>使用同步发送。</li><li>把 Ack 设为 <code>1</code> 或者 <code>all</code>，并且设置同步的分区数（<code>min.insync.replicas</code>）为分区备份数。</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="消费者-2">消费者<a class="hash-link" href="#消费者-2" title="Direct link to heading">​</a></h4><ol><li>把自动提交改成手动提交</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何防止重复消费">如何防止重复消费<a class="hash-link" href="#如何防止重复消费" title="Direct link to heading">​</a></h3><p>在防止消息的方案中，如果生产者发送完消息后，因为网络抖动，没有收到 Ack，但实际上 Broker 已经收到消息了，此时生产者就会重试，于是 Broker 就会收到多条相同的消息，而造成消费者的重复消费。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案">解决方案<a class="hash-link" href="#解决方案" title="Direct link to heading">​</a></h4><ul><li><p>生产者关闭重试</p><blockquote><p>会造成消息丢失，不建议。</p></blockquote></li><li><p>消费者解决非幂等性消费问题</p><blockquote><p>业务 ID 唯一或分布式锁。</p></blockquote></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何做到消息的顺序消费">如何做到消息的顺序消费<a class="hash-link" href="#如何做到消息的顺序消费" title="Direct link to heading">​</a></h3><ol><li>生产者保证消息按顺序消费，且消息不丢失，使用同步发送，Ack 设置成非 0 的值。</li><li>主题只能设置一个分区，消费组中只能有一个消费者。</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何解决消息积压问题">如何解决消息积压问题<a class="hash-link" href="#如何解决消息积压问题" title="Direct link to heading">​</a></h3><p>消息的消费速度远赶不上生产速度，导致 Kafka 中有大量的数据没有被消费。随着没有消费的数据堆积越多，消费者的寻址性能会越来越差，最后导致整个 Kafka 对外提供的服务的性能很差，从而导致其它服务也访问速度变慢，造成服务雪崩。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-1">解决方案<a class="hash-link" href="#解决方案-1" title="Direct link to heading">​</a></h4><ul><li>在这个消费者中，使用多线程，充分利用机器的性能进行消费消息。</li><li>通过业务的架构设计，提高业务层面消费的性能。</li><li>创建多个消费组，多个消费者，部署到其它机器上，一起消费，提高消费者的消费速度</li><li>创建一个消费者，该消费者在 Kafka 另建一个主题，配上多个分区，再配上多个消费者。该消费者将 <code>poll</code> 下来的消息，不进行消费，直接转发到新建的主题上。此时，新的主题的多个分区的多个消费者就开始一起消费了。</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何实现延时队列">如何实现延时队列<a class="hash-link" href="#如何实现延时队列" title="Direct link to heading">​</a></h3><h4 class="anchor anchorWithStickyNavbar_LWe7" id="应用场景">应用场景<a class="hash-link" href="#应用场景" title="Direct link to heading">​</a></h4><p>订单创建后，超过 30 分钟没有支付，则需要取消订单，这种场景可以通过延时队列来实现。</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="解决方案-2">解决方案<a class="hash-link" href="#解决方案-2" title="Direct link to heading">​</a></h4><ol><li>Kafka 中创建多个 Topic，每个 Topic 表示延时的间隔，如 <code>topic_30m</code>。</li><li>消息发送者发送消息到相应的 Topic，并带上消息的发送时间。</li><li>消费者订阅相应的 Topic，消费时长轮询消费整个 Topic 中的消息。<ul><li>判断消费的发送时间和当前比较当前时间是否超过预设的值，如 30 分钟。</li><li>如果超过，去数据库中修改订单状态为已取消。</li><li>如果未超过，记录当前消息的 Offset 并不再继续消费之后的消息，下次消费 Offset 之后的消息继续进行判断。</li></ul></li></ol></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/middleware/kafka/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Kafka</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/middleware/kafka/kafka-3 kraft 模式安装"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">kafka-3 kraft 模式安装</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#什么是-mq" class="table-of-contents__link toc-highlight">什么是 MQ</a></li><li><a href="#消息队列的流派" class="table-of-contents__link toc-highlight">消息队列的流派</a><ul><li><a href="#有-broker-的-mq" class="table-of-contents__link toc-highlight">有 Broker 的 MQ</a><ul><li><a href="#重-topic-kafkaactivemqjms" class="table-of-contents__link toc-highlight">重 Topic （Kafka、ActiveMQ、JMS）</a></li><li><a href="#轻-topicrabbitmq-或者-amqp-协议" class="table-of-contents__link toc-highlight">轻 Topic（RabbitMQ 或者 AMQP 协议）</a></li></ul></li><li><a href="#无-broker-的-mq" class="table-of-contents__link toc-highlight">无 Broker 的 MQ</a><ul><li><a href="#zeromq" class="table-of-contents__link toc-highlight">ZeroMQ</a></li></ul></li></ul></li><li><a href="#kafka-介绍" class="table-of-contents__link toc-highlight">Kafka 介绍</a><ul><li><a href="#kafka-的使用场景" class="table-of-contents__link toc-highlight">Kafka 的使用场景</a></li><li><a href="#kafka-的基本概念" class="table-of-contents__link toc-highlight">Kafka 的基本概念</a></li></ul></li><li><a href="#kafka-安装" class="table-of-contents__link toc-highlight">Kafka 安装</a><ul><li><a href="#环境准备" class="table-of-contents__link toc-highlight">环境准备</a></li><li><a href="#配置文件" class="table-of-contents__link toc-highlight">配置文件</a></li><li><a href="#启动-kafka-服务器" class="table-of-contents__link toc-highlight">启动 Kafka 服务器</a></li><li><a href="#创建主题发送消息消费消息" class="table-of-contents__link toc-highlight">创建主题、发送消息、消费消息</a></li><li><a href="#关于消息的细节" class="table-of-contents__link toc-highlight">关于消息的细节</a></li></ul></li><li><a href="#单播消息和多播消息" class="table-of-contents__link toc-highlight">单播消息和多播消息</a><ul><li><a href="#单播消息" class="table-of-contents__link toc-highlight">单播消息</a></li><li><a href="#多播消息" class="table-of-contents__link toc-highlight">多播消息</a></li><li><a href="#查看消费组的详细信息" class="table-of-contents__link toc-highlight">查看消费组的详细信息</a></li></ul></li><li><a href="#kafka-中主题和分区的概念" class="table-of-contents__link toc-highlight">Kafka 中主题和分区的概念</a><ul><li><a href="#主题" class="table-of-contents__link toc-highlight">主题</a></li><li><a href="#分区" class="table-of-contents__link toc-highlight">分区</a></li><li><a href="#kafka-中消息日志文件中保存的内容" class="table-of-contents__link toc-highlight">Kafka 中消息日志文件中保存的内容</a></li></ul></li><li><a href="#kafka-集群操作" class="table-of-contents__link toc-highlight">Kafka 集群操作</a><ul><li><a href="#副本的概念" class="table-of-contents__link toc-highlight">副本的概念</a></li><li><a href="#集群消费中分区分消费组的细节" class="table-of-contents__link toc-highlight">集群消费中分区分消费组的细节</a></li></ul></li><li><a href="#客户端-api" class="table-of-contents__link toc-highlight">客户端 API</a><ul><li><a href="#依赖" class="table-of-contents__link toc-highlight">依赖</a></li><li><a href="#生产者" class="table-of-contents__link toc-highlight">生产者</a><ul><li><a href="#生产者的同步发送消息" class="table-of-contents__link toc-highlight">生产者的同步发送消息</a></li><li><a href="#生产者的异步发送消息" class="table-of-contents__link toc-highlight">生产者的异步发送消息</a></li><li><a href="#生产者中-ack-配置" class="table-of-contents__link toc-highlight">生产者中 Ack 配置</a></li><li><a href="#关于消息发送的缓冲区" class="table-of-contents__link toc-highlight">关于消息发送的缓冲区</a></li></ul></li><li><a href="#消费者" class="table-of-contents__link toc-highlight">消费者</a><ul><li><a href="#关于消费者自动提交和手动提交-offset" class="table-of-contents__link toc-highlight">关于消费者自动提交和手动提交 Offset</a><ul><li><a href="#提交的内容" class="table-of-contents__link toc-highlight">提交的内容</a></li><li><a href="#自动提交" class="table-of-contents__link toc-highlight">自动提交</a></li><li><a href="#手动提交" class="table-of-contents__link toc-highlight">手动提交</a></li></ul></li><li><a href="#长轮询-poll-消息" class="table-of-contents__link toc-highlight">长轮询 <code>poll</code> 消息</a></li><li><a href="#消费者的健康状态检查" class="table-of-contents__link toc-highlight">消费者的健康状态检查</a></li><li><a href="#指定分区偏移量时间消费" class="table-of-contents__link toc-highlight">指定分区、偏移量、时间消费</a></li><li><a href="#新消费组的消费-offset-规则" class="table-of-contents__link toc-highlight">新消费组的消费 Offset 规则</a></li></ul></li></ul></li><li><a href="#spring-boot-中使用-kafka" class="table-of-contents__link toc-highlight">Spring Boot 中使用 Kafka</a><ul><li><a href="#依赖-1" class="table-of-contents__link toc-highlight">依赖</a></li><li><a href="#配置文件-1" class="table-of-contents__link toc-highlight">配置文件</a></li><li><a href="#生产者-1" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-1" class="table-of-contents__link toc-highlight">消费者</a><ul><li><a href="#消费者中配置主题分区偏移量" class="table-of-contents__link toc-highlight">消费者中配置主题、分区、偏移量</a></li></ul></li></ul></li><li><a href="#kafka-集群中的-controllerrebalancehw" class="table-of-contents__link toc-highlight">Kafka 集群中的 Controller、Rebalance、HW</a><ul><li><a href="#controller" class="table-of-contents__link toc-highlight">Controller</a></li><li><a href="#rebalance-机制" class="table-of-contents__link toc-highlight">Rebalance 机制</a><ul><li><a href="#前提" class="table-of-contents__link toc-highlight">前提</a></li><li><a href="#触发的条件" class="table-of-contents__link toc-highlight">触发的条件</a></li><li><a href="#分区分配的策略" class="table-of-contents__link toc-highlight">分区分配的策略</a></li></ul></li><li><a href="#hw-和-leo" class="table-of-contents__link toc-highlight">HW 和 LEO</a></li></ul></li><li><a href="#kafka-的优化问题" class="table-of-contents__link toc-highlight">Kafka 的优化问题</a><ul><li><a href="#如何防止消息丢失" class="table-of-contents__link toc-highlight">如何防止消息丢失</a><ul><li><a href="#生产者-2" class="table-of-contents__link toc-highlight">生产者</a></li><li><a href="#消费者-2" class="table-of-contents__link toc-highlight">消费者</a></li></ul></li><li><a href="#如何防止重复消费" class="table-of-contents__link toc-highlight">如何防止重复消费</a><ul><li><a href="#解决方案" class="table-of-contents__link toc-highlight">解决方案</a></li></ul></li><li><a href="#如何做到消息的顺序消费" class="table-of-contents__link toc-highlight">如何做到消息的顺序消费</a></li><li><a href="#如何解决消息积压问题" class="table-of-contents__link toc-highlight">如何解决消息积压问题</a><ul><li><a href="#解决方案-1" class="table-of-contents__link toc-highlight">解决方案</a></li></ul></li><li><a href="#如何实现延时队列" class="table-of-contents__link toc-highlight">如何实现延时队列</a><ul><li><a href="#应用场景" class="table-of-contents__link toc-highlight">应用场景</a></li><li><a href="#解决方案-2" class="table-of-contents__link toc-highlight">解决方案</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Built with Docusaurus</div></div></div></footer></div>
<script src="/assets/js/runtime~main.58528b02.js"></script>
<script src="/assets/js/main.4546e038.js"></script>
</body>
</html>