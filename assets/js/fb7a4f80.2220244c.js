"use strict";(self.webpackChunkdocusaurus=self.webpackChunkdocusaurus||[]).push([[8366],{3905:(e,n,t)=>{t.d(n,{Zo:()=>o,kt:()=>g});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function p(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},l=Object.keys(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(a=0;a<l.length;a++)t=l[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var c=a.createContext({}),s=function(e){var n=a.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},o=function(e){var n=s(e.components);return a.createElement(c.Provider,{value:n},e.children)},m="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},u=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,l=e.originalType,c=e.parentName,o=p(e,["components","mdxType","originalType","parentName"]),m=s(t),u=r,g=m["".concat(c,".").concat(u)]||m[u]||d[u]||l;return t?a.createElement(g,i(i({ref:n},o),{},{components:t})):a.createElement(g,i({ref:n},o))}));function g(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var l=t.length,i=new Array(l);i[0]=u;var p={};for(var c in n)hasOwnProperty.call(n,c)&&(p[c]=n[c]);p.originalType=e,p[m]="string"==typeof e?e:r,i[1]=p;for(var s=2;s<l;s++)i[s]=t[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,t)}u.displayName="MDXCreateElement"},3189:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>m,frontMatter:()=>l,metadata:()=>p,toc:()=>s});var a=t(7462),r=(t(7294),t(3905));const l={},i=void 0,p={unversionedId:"container/GitLab CI \u96c6\u6210 Nexus \u548c Harbor",id:"container/GitLab CI \u96c6\u6210 Nexus \u548c Harbor",title:"GitLab CI \u96c6\u6210 Nexus \u548c Harbor",description:"\u73af\u5883\u51c6\u5907",source:"@site/docs/container/GitLab CI \u96c6\u6210 Nexus \u548c Harbor.md",sourceDirName:"container",slug:"/container/GitLab CI \u96c6\u6210 Nexus \u548c Harbor",permalink:"/docs/container/GitLab CI \u96c6\u6210 Nexus \u548c Harbor",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"defaultSidebar",previous:{title:"\u5bb9\u5668",permalink:"/docs/container/"},next:{title:"Containerd",permalink:"/docs/container/containerd/"}},c={},s=[{value:"\u73af\u5883\u51c6\u5907",id:"\u73af\u5883\u51c6\u5907",level:2},{value:"\u57fa\u7840\u7ec4\u4ef6",id:"\u57fa\u7840\u7ec4\u4ef6",level:3},{value:"GitLab",id:"gitlab",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5",level:4},{value:"Harbor",id:"harbor",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-1",level:4},{value:"\u955c\u50cf\u6ce8\u518c\u8868\u914d\u7f6e",id:"\u955c\u50cf\u6ce8\u518c\u8868\u914d\u7f6e",level:4},{value:"\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\u914d\u7f6e",id:"\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\u914d\u7f6e",level:4},{value:"\u56fe\u8868\u4ed3\u5e93\u914d\u7f6e",id:"\u56fe\u8868\u4ed3\u5e93\u914d\u7f6e",level:4},{value:"Nexus \u5b89\u88c5",id:"nexus-\u5b89\u88c5",level:3},{value:"\u5b89\u88c5",id:"\u5b89\u88c5-2",level:4},{value:"Maven \u4ee3\u7406\u4ed3\u5e93\u914d\u7f6e",id:"maven-\u4ee3\u7406\u4ed3\u5e93\u914d\u7f6e",level:4},{value:"GitLab CI",id:"gitlab-ci",level:2},{value:"GitLab Runner",id:"gitlab-runner",level:3},{value:"\u6267\u884c\u5668\u5bf9\u6bd4",id:"\u6267\u884c\u5668\u5bf9\u6bd4",level:4},{value:"Kubernetes \u6267\u884c\u5668",id:"kubernetes-\u6267\u884c\u5668",level:4},{value:"Shell \u6267\u884c\u5668",id:"shell-\u6267\u884c\u5668",level:4},{value:"Maven \u9879\u76ee",id:"maven-\u9879\u76ee",level:3},{value:"\u521b\u5efa\u9879\u76ee",id:"\u521b\u5efa\u9879\u76ee",level:4},{value:"GitLab CI \u6d41\u6c34\u7ebf",id:"gitlab-ci-\u6d41\u6c34\u7ebf",level:4},{value:"\u7f13\u5b58\u5230 Nexus \u4e2d\u7684 Jar",id:"\u7f13\u5b58\u5230-nexus-\u4e2d\u7684-jar",level:4},{value:"NPM \u9879\u76ee",id:"npm-\u9879\u76ee",level:3},{value:"\u521b\u5efa\u9879\u76ee",id:"\u521b\u5efa\u9879\u76ee-1",level:4},{value:"GitLab CI \u6d41\u6c34\u7ebf",id:"gitlab-ci-\u6d41\u6c34\u7ebf-1",level:4},{value:"\u4e0a\u4f20\u5230 Harbor \u7684\u955c\u50cf",id:"\u4e0a\u4f20\u5230-harbor-\u7684\u955c\u50cf",level:4},{value:"\u5e38\u89c1\u95ee\u9898",id:"\u5e38\u89c1\u95ee\u9898",level:2},{value:"GitLab CI \u7f13\u5b58",id:"gitlab-ci-\u7f13\u5b58",level:3},{value:"\u5185\u7f51 DNS",id:"\u5185\u7f51-dns",level:3}],o={toc:s};function m(e){let{components:n,...t}=e;return(0,r.kt)("wrapper",(0,a.Z)({},o,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"\u73af\u5883\u51c6\u5907"},"\u73af\u5883\u51c6\u5907"),(0,r.kt)("h3",{id:"\u57fa\u7840\u7ec4\u4ef6"},"\u57fa\u7840\u7ec4\u4ef6"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"K8S \u5355\u8282\u70b9\u96c6\u7fa4\uff08",(0,r.kt)("inlineCode",{parentName:"li"},"v1.24.4+k3s1"),"\uff09\u3001Ingress Controller\u3001Storage Class"),(0,r.kt)("li",{parentName:"ul"},"Containerd\uff08",(0,r.kt)("inlineCode",{parentName:"li"},"v1.6.6"),"\uff09\u3001BuildKit"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"kubectl"),"\u3001",(0,r.kt)("inlineCode",{parentName:"li"},"helm"),"\u3001",(0,r.kt)("inlineCode",{parentName:"li"},"nerdctl"))),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"gitlab"},"GitLab"),(0,r.kt)("h4",{id:"\u5b89\u88c5"},"\u5b89\u88c5"),(0,r.kt)("p",null,"\u901a\u8fc7 Helm \u5b89\u88c5 GitLab \u9ed8\u8ba4\u914d\u7f6e\u81f3\u5c11\u9700\u8981 8C32G \u8d44\u6e90\uff0c\u4f46\u662f GitLab \u6587\u6863\u4e2d\u4e5f\u63d0\u4f9b\u4e86\u9488\u5bf9 MiniKube \u6ee1\u8db3 2C4G \u8d44\u6e90\u7684\u914d\u7f6e ",(0,r.kt)("a",{parentName:"p",href:"https://gitlab.com/gitlab-org/charts/gitlab/-/blob/master/examples/values-minikube-minimum.yaml"},"values-minikube-minimum.yaml"),"\u3002"),(0,r.kt)("p",null,"\u6700\u7ec8\u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff0c\u5e76\u4e14\u7981\u7528\u4e86\u4e00\u4e9b\u975e\u5fc5\u8981\u7684\u7ec4\u4ef6\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"HTTPS"),(0,r.kt)("li",{parentName:"ul"},"Cert Manager"),(0,r.kt)("li",{parentName:"ul"},"Nginx Ingress Controller\uff08\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684 Ingress Controller\uff09"),(0,r.kt)("li",{parentName:"ul"},"Prometheus"),(0,r.kt)("li",{parentName:"ul"},"Docker Registry\uff08\u4f7f\u7528 Harbor\uff09"),(0,r.kt)("li",{parentName:"ul"},"GitLab Agent Server")),(0,r.kt)("p",null,"\u9700\u8981\u6ce8\u610f\u7684\u914d\u7f6e\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"global.ingress.class")," \u9700\u8981\u8bbe\u7f6e\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"none"),"\u624d\u4f1a\u8ba9 GitLab \u4f7f\u7528\u9ed8\u8ba4\u7684 Ingress Controller\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'global:\n  edition: ce\n  hosts:\n    domain: dev.icefery.xyz\n    https: false\n  ingress:\n    configureCertmanager: false\n    class: none\n    tls:\n      enabled: false\n  kas:\n    enabled: false\n  rails:\n    bootsnap:\n      enabled: false\n  time_zone: Asia/Shanghai\ncertmanager:\n  install: false\nnginx-ingress:\n  enabled: false\nprometheus:\n  install: false\nregistry:\n  enabled: false\ngitlab-runner:\n  install: true\n  rbac:\n    create: true\n    clusterWideAccess: true\n  runners:\n    privileged: true\n    config: |\n      [[runners]]\n        [runners.kubernetes]\n          image = "ubuntu:22.04"\n          {{- if .Values.global.minio.enabled }}\n          [runners.cache]\n            Type = "s3"\n            Path = "gitlab-runner"\n            Shared = true\n            [runners.cache.s3]\n              ServerAddress = {{ include "gitlab-runner.cache-tpl.s3ServerAddress" . }}\n              BucketName = "runner-cache"\n              BucketLocation = "us-east-1"\n              Insecure = true\n          {{ end }}\ngitlab:\n  webservice:\n    minReplicas: 1\n    maxReplicas: 1\n  sidekiq:\n    minReplicas: 1\n    maxReplicas: 1\n  gitlab-shell:\n    minReplicas: 1\n    maxReplicas: 1\n')),(0,r.kt)("p",null,"\u56fe\u8868\u91c7\u7528\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"gitlab-jh/gitlab"),"\uff0c\u56e0\u4e3a\u6781\u72d0 GitLab \u4e0e\u539f\u751f GitLab \u4f7f\u7528\u76f8\u540c\u7684\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u4e14\u9ed8\u8ba4\u60c5\u51b5\u4e0b\u7cfb\u7edf\u754c\u9762\u662f\u4e2d\u6587\u7684\u4e0d\u9700\u8981\u518d\u9891\u7e41\u505a\u8c03\u6574\uff0c\u6240\u4ee5\u53ea\u9700\u8981\u4fee\u6539 Chart \u4ed3\u5e93\u5373\u53ef\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# helm repo add gitlab http://charts.gitlab.io/\nhelm repo add gitlab-jh https://charts.gitlab.cn\n\nhelm repo update\n\n# helm upgrade gitlab gitlab/gitlab --install --namespace gitlab --create-namespace --values gitlab.yaml\nhelm upgrade gitlab gitlab-jh/gitlab --install --namespace gitlab --create-namespace --values gitlab.yaml\n\n# \u67e5\u770b root \u5bc6\u7801\nkubectl get secret -n gitlab gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/f19d579eb1884b9ab56a2a55608c627c.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"harbor"},"Harbor"),(0,r.kt)("h4",{id:"\u5b89\u88c5-1"},"\u5b89\u88c5"),(0,r.kt)("p",null,"Harbor \u7684\u5b89\u88c5\u4f7f\u7528\u4e86 Bitnami \u7cfb\u5217\u7684\u56fe\u8868\uff0c\u5e76\u4e14\u7981\u7528\u4e86 HTTPS \u4ee5\u53ca Ingress \u7684\u81ea\u52a8\u8df3\u8f6c\u3002"),(0,r.kt)("p",null,"\u4e0d\u8fc7\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56e0\u4e3a Docker \u65e0\u6cd5\u4f7f\u7528 HTTP \u6ce8\u518c\u8868\uff0c\u5f53 Harbor \u7981\u7528\u4e86 TLS \u540e\u4e5f\u5373\u65e0\u6cd5\u518d\u5728 Docker \u4e0a\u8fdb\u884c\u4f7f\u7528\u4e86\uff0c\u56e0\u6b64\u8fd9\u91cc\u91c7\u7528\u7684\u955c\u50cf\u6784\u5efa\u5de5\u5177\u662f Containerd \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"nerdctl"),"\uff0c\u8fd9\u4e24\u8005\u7684\u642d\u914d\u76f8\u6bd4\u4e8e Docker \u53ca\u5176 CLI \u529f\u80fd\u4f1a\u66f4\u591a\u4e00\u4e9b\uff0c\u5e76\u4e14\u5728\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\u65b9\u4fbf\u76f8\u6bd4 Docker CLI \u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"docker buildx")," \u9650\u5236\u66f4\u5c11\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"adminPassword: admin\nexternalURL: http://core.harbor.dev.icefery.xyz\nexposureType: ingress\ningress:\n  core:\n    hostname: core.harbor.dev.icefery.xyz\n    annotations:\n      ingress.kubernetes.io/ssl-redirect: 'false'\n      nginx.ingress.kubernetes.io/ssl-redirect: 'false'\n  notary:\n    hostname: notary.harbor.dev.icefery.xyz\n    annotations:\n      ingress.kubernetes.io/ssl-redirect: 'false'\n      nginx.ingress.kubernetes.io/ssl-redirect: 'false'\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm upgrade harbor bitnami/harbor --install --namespace harbor --create-namespace --values values.yaml\n")),(0,r.kt)("h4",{id:"\u955c\u50cf\u6ce8\u518c\u8868\u914d\u7f6e"},"\u955c\u50cf\u6ce8\u518c\u8868\u914d\u7f6e"),(0,r.kt)("p",null,"\u5b89\u88c5\u5b8c Harbor \u540e\uff0c\u53ef\u4ee5\u5c06 Harbor \u6dfb\u52a0\u5230 Containerd \u4ee5\u53ca K3S \u5185\u7f6e\u7684 Containerd \u4e2d\u3002"),(0,r.kt)("p",null,"\u76f8\u6bd4\u4e8e Docker \u6362\u6e90\uff0cContainerd \u7684\u6362\u6e90\u8fc7\u7a0b\u53ef\u80fd\u4f1a\u9ebb\u70e6\u4e00\u4e9b\uff0c\u5177\u4f53\u53ef\u4ee5\u53c2\u8003\u5b98\u65b9\u6587\u6863 ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/containerd/containerd/blob/main/docs/cri/registry.md"},"registry.md"),"\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u66f4\u6539 Containerd \u914d\u7f6e\u6587\u4ef6"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'mkdir -p /etc/containerd/\n\ncat > /etc/containerd/config.toml <<- "EOF"\nversion = 2\n[plugins."io.containerd.grpc.v1.cri".registry]\n  config_path = "/etc/containerd/certs.d"\nEOF\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6dfb\u52a0\u955c\u50cf\u6ce8\u518c\u8868\u914d\u7f6e"),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"\u5982\u679c Ingress Controller \u66b4\u9732\u7684\u7aef\u53e3\u4e0d\u662f 80 \u5219\u4e0d\u80fd\u7701\u7565 Harbor \u5730\u5740\u4e2d\u7684\u7aef\u53e3\uff0c\u4f8b\u5982 ",(0,r.kt)("inlineCode",{parentName:"p"},"core.harbor.dev.icefery.xyz:30080"),"\u3002")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'mkdir -p /etc/containerd/certs.d/core.harbor.dev.icefery.xyz/\n\ncat > /etc/containerd/certs.d/core.harbor.dev.icefery.xyz/hosts.toml <<- "EOF"\nserver = "http://core.harbor.dev.icefery.xyz"\n[host."http://core.harbor.dev.icefery.xyz"]\n  skip_verify = true\nEOF\n'))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u5bf9 ",(0,r.kt)("inlineCode",{parentName:"p"},"docker.io")," \u8fdb\u884c\u6362\u6e90"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'mkdir -p /etc/containerd/certs.d/docker.io/\n\ncat > /etc/containerd/certs.d/docker.io/hosts.toml <<- "EOF"\nserver = "https://registry-1.docker.io"\n[host."https://uwk49ut2.mirror.aliyuncs.com"]\n  capabilities = ["pull"]\nEOF\n')))),(0,r.kt)("p",null,"\u4ee5\u4e0a\u7684\u914d\u7f6e\u65b9\u5f0f\u6765\u6e90\u4e8e 1.6.6 \u7248\u672c\u7684 Containerd \u6587\u6863\uff0c\u662f\u4e00\u79cd\u8f83\u65b0\u7684\u914d\u7f6e\u65b9\u5f0f\uff0c\u4f46\u662f\u8fd9\u79cd\u65b9\u5f0f\u4e0b\u5e76\u4e0d\u80fd\u6307\u5b9a Harbor \u7684\u5bc6\u7801\u3002\u5982\u679c\u5728 Harbor \u521b\u5efa\u7684\u662f\u79c1\u6709\u9879\u76ee\uff0c\u90a3\u4e48\u5c31\u9700\u8981\u4f7f\u7528\u539f\u5148\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /etc/containerd/config.toml <<- "EOF"\nversion = 2\n[plugins."io.containerd.grpc.v1.cri".registry]\n  config_path = "/etc/containerd/certs.d"\n[plugins."io.containerd.grpc.v1.cri".registry.mirrors]\n[plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]\n  endpoint = ["https://uwk49ut2.mirror.aliyuncs.com"]\n[plugins."io.containerd.grpc.v1.cri".registry.mirrors."core.harbor.dev.icefery.xyz"]\n  endpoint = ["http://core.harbor.dev.icefery.xyz"]\n[plugins."io.containerd.grpc.v1.cri".registry.configs."core.harbor.dev.icefery.xyz".tls]\n  insecure_skip_verify = true\n[plugins."io.containerd.grpc.v1.cri".registry.configs."core.harbor.dev.icefery.xyz".auth]\n  username = "admin"\n  password = "admin"\nEOF\n')),(0,r.kt)("p",null,"K3S \u63d0\u4f9b\u4e86\u4e00\u4e2a\u66f4\u7b80\u5355\u7684\u65b9\u6cd5\u53bb\u914d\u7f6e\u5185\u7f6e Containerd \u7684\u955c\u50cf\u6ce8\u518c\u8868\uff0c\u867d\u7136\u6700\u7ec8\u4e5f\u4f1a\u540c\u6b65\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"/var/lib/rancher/k3s/agent/etc/containerd/config.toml"),"\u4e2d\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'cat > /etc/rancher/k3s/registries.yaml <<- "EOF"\nmirrors:\n  docker.io:\n    endpoint:\n      - "https://uwk49ut2.mirror.aliyuncs.com"\n  "core.harbor.dev.icefery.xyz":\n    endpoint:\n      - "http://core.harbor.dev.icefery.xyz"\nconfigs:\n  "core.harbor.dev.icefery.xyz":\n    tls:\n      insecure_skip_verify: true\n    auth:\n      username: admin\n      password: admin\nEOF\n')),(0,r.kt)("h4",{id:"\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\u914d\u7f6e"},"\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\u914d\u7f6e"),(0,r.kt)("p",null,"\u9ed8\u8ba4\u4ece GitHub \u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"containerd/nerdctl")," \u5b89\u88c5\u5b8c\u6210\u540e\u5e76\u6ca1\u6709\u542f\u52a8 BuildKit\uff0c\u4e3a\u4e86\u542f\u7528 BuildKit \u4ee5\u53ca\u652f\u6301\u591a\u5e73\u53f0\u955c\u50cf\u6784\u5efa\uff0c\u8fd8\u9700\u8981\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"systemctl enable --now buildkit\n\nnerdctl run --privileged --rm tonistiigi/binfmt --install all\n")),(0,r.kt)("h4",{id:"\u56fe\u8868\u4ed3\u5e93\u914d\u7f6e"},"\u56fe\u8868\u4ed3\u5e93\u914d\u7f6e"),(0,r.kt)("p",null,"\u4e3a\u4e86\u80fd\u591f\u63a8\u9001\u5230 Harbor \u5185\u7f6e\u7684 ChartMuseum \u4ed3\u5e93\uff0c\u8fd8\u9700\u4e3a Helm \u5b89\u88c5 ",(0,r.kt)("inlineCode",{parentName:"p"},"helm-push")," \u5dee\u8ddd\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm plugin install https://github.com/chartmuseum/helm-push\n")),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"nexus-\u5b89\u88c5"},"Nexus \u5b89\u88c5"),(0,r.kt)("h4",{id:"\u5b89\u88c5-2"},"\u5b89\u88c5"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"ingress:\n  enabled: true\n  ingressClassName: ''\n  hostRepo: nexus.dev.icefery.xyz\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"helm repo add sonatype https://sonatype.github.io/helm3-charts/\n\nhelm repo update\n\nhelm upgrade nexus sonatype/nexus-repository-manager --install --namespace nexus --create-namespace --values values.yaml\n\n# \u67e5\u770b admin \u5bc6\u7801\nkubectl exec -n nexus pods/<POD> -- cat /nexus-data/admin.password\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/c5dfdc4c888f4ec380488d096f0ca355.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("h4",{id:"maven-\u4ee3\u7406\u4ed3\u5e93\u914d\u7f6e"},"Maven \u4ee3\u7406\u4ed3\u5e93\u914d\u7f6e"),(0,r.kt)("p",null,"Nexus \u6709\u4e09\u79cd\u7c7b\u578b\u7684\u4ed3\u5e93\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"proxy")," \u4ee3\u7406\u4ed3\u5e93\uff0c\u53ea\u8bfb"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"hosted")," \u5bbf\u4e3b\u4ed3\u5e93\uff0c\u5b58\u50a8\u81ea\u5b9a\u4e49 JAR \u5305\uff0c\u53ef\u5199"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"group")," \u7ec4\u4ed3\u5e93\uff0c\u805a\u5408\u4ee3\u7406\u4ed3\u5e93\u548c\u5bbf\u4e3b\u4ed3\u5e93\uff0c\u4e3a\u5176\u63d0\u4f9b\u7edf\u4e00\u7684\u670d\u52a1\u5730\u5740\uff0c\u53ef\u5199")),(0,r.kt)("p",null,"\u53c2\u8003\u4ee5\u4e0b\u7684\u914d\u7f6e\uff0c\u901a\u8fc7\u4ee3\u7406\u963f\u91cc\u4e91\u4e91\u6548 Maven \u548c\u9ed8\u8ba4\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"repo.maven.apache.org")," \u57fa\u672c\u53ef\u4ee5\u7f13\u5b58\u5927\u90e8\u5206\u4ed3\u5e93\u7684\u8bbf\u95ee\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"- { type: proxy, name: maven-proxy-aliyun-public, url: https://maven.aliyun.com/repository/public }\n- { type: proxy, name: maven-proxy-aliyun-google, url: https://maven.aliyun.com/repository/google }\n- { type: proxy, name: maven-proxy-aliyun-spring, url: https://maven.aliyun.com/repository/spring }\n- { type: proxy, name: maven-proxy-aliyun-spring-plugin, url: https://maven.aliyun.com/repository/spring-plugin }\n- { type: proxy, name: maven-proxy-aliyun-gradle-plugin, url: https://maven.aliyun.com/repository/gradle-plugin }\n- { type: proxy, name: maven-proxy-repo, url: https://repo.maven.apache.org/maven2 }\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/2c3bfcb22e1e43669bd561befd946243.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("h2",{id:"gitlab-ci"},"GitLab CI"),(0,r.kt)("h3",{id:"gitlab-runner"},"GitLab Runner"),(0,r.kt)("h4",{id:"\u6267\u884c\u5668\u5bf9\u6bd4"},"\u6267\u884c\u5668\u5bf9\u6bd4"),(0,r.kt)("p",null,"GitLab Runner \u5404\u79cd\u7c7b\u578b\u7684 Runner \u5bf9\u6bd4\u5982\u4e0b",(0,r.kt)("a",{parentName:"p",href:"https://docs.gitlab.com/runner/executors/"},"Executors"),"\uff1a"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:"left"},"\u6267\u884c\u5668"),(0,r.kt)("th",{parentName:"tr",align:"center"},"SSH"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Shell"),(0,r.kt)("th",{parentName:"tr",align:"center"},"VirtualBox"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Parallels"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Docker"),(0,r.kt)("th",{parentName:"tr",align:"center"},"Kubernetes"),(0,r.kt)("th",{parentName:"tr",align:"center"},"\u81ea\u5b9a\u4e49"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u4e3a\u6bcf\u4e2a\u6784\u5efa\u6e05\u7406\u6784\u5efa\u73af\u5883"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u6709\u6761\u4ef6\u7684")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u91cd\u7528\u4e4b\u524d\u7684\u514b\u9686\uff08\u5982\u679c\u6709\uff09"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u6709\u6761\u4ef6\u7684")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u4fdd\u62a4 Runner \u6587\u4ef6\u7cfb\u7edf\u8bbf\u95ee"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u6709\u6761\u4ef6\u7684")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u8fc1\u79fb Runner \u673a\u5668"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u90e8\u5206"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u90e8\u5206"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u5e76\u53d1\u6784\u5efa\u7684\u96f6\u914d\u7f6e\u652f\u6301"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u6709\u6761\u4ef6\u7684")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u590d\u6742\u6784\u5efa\u73af\u5883"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2717"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u2713")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:"left"},"\u4fee\u590d\u6784\u5efa\u95ee\u9898"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u7b80\u5355"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u7b80\u5355"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u56f0\u96be"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u56f0\u96be"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u9002\u4e2d"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u9002\u4e2d"),(0,r.kt)("td",{parentName:"tr",align:"center"},"\u9002\u4e2d")))),(0,r.kt)("h4",{id:"kubernetes-\u6267\u884c\u5668"},"Kubernetes \u6267\u884c\u5668"),(0,r.kt)("p",null,"\u901a\u8fc7 Helm \u5b89\u88c5 GitLab \u65f6\u5df2\u7ecf\u9ed8\u8ba4\u5b89\u88c5\u4e86\u4e00\u4e2a Kubernetes \u6267\u884c\u5668\uff0c\u8fd9\u91cc\u7ed9\u9700\u8981\u5b83\u8bbe\u7f6e\u4e00\u4e2a\u6267\u884c\u5668\u7684\u6807\u7b7e\uff08",(0,r.kt)("inlineCode",{parentName:"p"},"executor=kubernetes"),"\uff09\u3002\u6807\u7b7e\u662f\u7528\u4e8e\u7ed9 GitLab CI \u9009\u62e9 GitLab Runner \u7684\uff0c\u540e\u7eed\u5728\u521b\u5efa\u6ce8\u518c Shell \u6267\u884c\u5668\u7684 GitLab Runner \u65f6\u4e5f\u4f1a\u4e3a\u5176\u6dfb\u52a0\u6807\u7b7e\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/ee1102c9422544b99eb4ce179e2a7a02.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("h4",{id:"shell-\u6267\u884c\u5668"},"Shell \u6267\u884c\u5668"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/20eba10d72ab43679fea1c9d5634f373.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("p",null,"\u5176\u4e2d\u5c06 GitLab Runner \u5b89\u88c5\u4e3a\u670d\u52a1\u7684\u547d\u4ee4\u9700\u8981\u8c03\u6574\u4e00\u4e0b\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"# \u76f4\u63a5\u4f7f\u7528 root \u7528\u6237\u8fd0\u884c runner \u4f46\u662f\u5de5\u4f5c\u76ee\u5f55\u4f9d\u7136\u5728\u539f\u5148\u7684\u7528\u6237\u4e3b\u76ee\u5f55\u4e0b\nmkdir -p /home/gitlab-runner\n\ngitlab-runner install --user=root --working-directory=/home/gitlab-runner\n")),(0,r.kt)("p",null,"\u9488\u5bf9 Shell \u6267\u884c\u5668\uff0c\u76f4\u63a5\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"root")," \u7528\u6237\u542f\u52a8 GitLab Runner \u540e\u7eed\u7684\u914d\u7f6e\u76f8\u5bf9\u4f1a\u5c11\u5f88\u591a\u4e5f\u6700\u4e3a\u7b80\u5355\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"gitlab-runner")," \u7528\u6237\u6267\u884c\u9700\u8981\u914d\u7f6e\u514d\u5bc6",(0,r.kt)("inlineCode",{parentName:"p"},"sudo"),"\u3002"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'echo "gitlab-runner ALL=(ALL:ALL)  NOPASSWD:ALL" > /etc/sudoers.d/gitlab-runner\n\n# \u5728 Ubuntu \u73af\u5883\u4e0b\u9700\u8981\u5148\u6e05\u7a7a `gitlab-runner` \u7528\u6237\u4e3b\u76ee\u5f55\u4e0b\u7684\u4e00\u4e9b\u914d\u7f6e\u6587\u4ef6\u624d\u80fd\u6b63\u5e38\u6267\u884c\u4f5c\u4e1a\ncd /home/gitlab-runner\n\nrm -rf .bash_history  .bash_logout  .bashrc  .profile  .sudo_as_admin_successful\n')),(0,r.kt)("blockquote",{parentName:"li"},(0,r.kt)("p",{parentName:"blockquote"},"\u4f46\u662f\u5373\u904d\u5df2\u7ecf\u914d\u7f6e\u514d\u5bc6",(0,r.kt)("inlineCode",{parentName:"p"},"sudo")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"KUBECONFIG"),"\uff0c\u901a\u8fc7 ",(0,r.kt)("inlineCode",{parentName:"p"},"sudo")," \u547d\u4ee4\u8fd0\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"helm")," \u547d\u4ee4\u65f6\u8fd8\u662f\u62a5 ",(0,r.kt)("inlineCode",{parentName:"p"},'Error: Kubernetes cluster unreachable: Get "http://localhost:8080/version": dial tcp 127.0.0.1:8080: connect: connection refused')," \u7684\u95ee\u9898\uff0c\u76ee\u524d\u6682\u672a\u89e3\u51b3\u3002"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"\u6ce8\u518c\u4e3a SSH \u6267\u884c\u5668\u4e5f\u4ecd\u7136\u9700\u8981\u8fde\u63a5\u7684\u673a\u5668\u5b89\u88c5\uff08\u4e0d\u9700\u542f\u52a8\uff09 GitLab Runner \u624d\u80fd\u5728\u4efb\u52a1\u95f4\u4f20\u9012 Artifacts\uff0c\u5e76\u4e14\u9488\u5bf9\u53ea\u80fd\u4f7f\u7528 PublicKey \u767b\u5f55\u7684\u60c5\u51b5\u8fd8\u9700\u4e3a GitLab Runner \u6302\u8f7d SSH Key\u3002"),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"services:\n  gitlab-runner-ssh:\n    image: gitlab/gitlab-runner:ubuntu-v15.3.0\n    container_name: gitlab-runner-ssh\n    volumes:\n      - /root/.ssh/gitlab-runner:/root/.ssh/gitlab-runner\nnetworks:\n  default:\n    external: true\n    name: compose\n")))),(0,r.kt)("p",null,"\u6ce8\u518c\u5b8c GitLab Runner \u540e\u5982\u679c\u6ca1\u6709\u586b\u5199 Tag \u8fd8\u53ef\u4ee5\u5728 GitLab \u8fdb\u884c\u4fee\u6539\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/fbec46014f2c42d48c377984b8fe0092.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"maven-\u9879\u76ee"},"Maven \u9879\u76ee"),(0,r.kt)("h4",{id:"\u521b\u5efa\u9879\u76ee"},"\u521b\u5efa\u9879\u76ee"),(0,r.kt)("p",null,"\u6211\u4eec\u53ef\u4ee5\u521b\u5efa\u4e00\u4e2a\u7b80\u5355\u7684 Spring Boot \u9879\u76ee\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"pom.xml")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/0708c9e31aee4129a458c5eadaadbe62.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"App.java")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/c951ae2b72de4f2a95a83c8cb3ff7bfc.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/05637f5a6d3c4aa58ff21bb11bd50d36.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"kubectl.yaml")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/13e25ad49fa844138f091fa670952193.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})))),(0,r.kt)("h4",{id:"gitlab-ci-\u6d41\u6c34\u7ebf"},"GitLab CI \u6d41\u6c34\u7ebf"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},"variables:\n  # \u955c\u50cf\u6ce8\u518c\u8868\n  IMAGE_REGISTRY_NAME: core.harbor.dev.icefery.xyz\n  IMAGE_REGISTRY_USERNAME: admin\n  IMAGE_REGISTRY_PASSWORD: admin\n  # \u5e94\u7528\n  APP_GROUP: icefery\n  APP_NAME: my-app-maven\n  APP_VERSION: 0.0.1\n\nstages:\n  - package\n  - build\n  - deploy\n\npackage-jar:\n  image: maven:3.8-openjdk-17\n  stage: package\n  tags:\n    # \u9009\u62e9\u6267\u884c\u5668\u4e3a Kubernetes \u7684 GitLab Runner \u6267\u884c\u4f5c\u4e1a\n    - executor=kubernetes\n  variables:\n    MAVEN_OPTS: -Dmaven.repo.local=${CI_PROJECT_DIR}/.m2\n  cache:\n    key: m2\n    paths:\n      - .m2\n  before_script:\n    # \u79fb\u9664 Maven \u955c\u50cf\u4e2d\u9ed8\u8ba4\u7684\u914d\u7f6e\u6587\u4ef6\n    - rm -rf /usr/share/maven/conf/settings.xml\n  script:\n    - mvn clean package\n  artifacts:\n    paths:\n      - target/*.jar\n\nbuild-docker-image:\n  stage: build\n  tags:\n    # \u9009\u62e9\u6267\u884c\u5668\u4e3a Shell \u5e76\u4e14\u53ef\u4ee5\u6267\u884c nerdctl \u547d\u4ee4\u7684 GitLab Runner \u6267\u884c\u4f5c\u4e1a\n    - executor=shell\n    - command=nerdctl\n  before_script:\n    # non-interactively shell \u9700\u8981\u624b\u52a8\u914d\u7f6e\u73af\u5883\u53d8\u91cf\n    - source /etc/custom.sh\n  script:\n    # \u6784\u5efa\u955c\u50cf\n    - nerdctl build --tag ${IMAGE_REGISTRY_NAME}/${APP_GROUP}/${APP_NAME}:${APP_VERSION} --platform linux/amd64,linux/arm64 .\n    # \u767b\u5f55\u955c\u50cf\u6ce8\u518c\u8868\n    - nerdctl login http://${IMAGE_REGISTRY_NAME} --username ${IMAGE_REGISTRY_USERNAME} --password ${IMAGE_REGISTRY_PASSWORD}\n    # \u63a8\u9001\u955c\u50cf\n    - nerdctl push ${IMAGE_REGISTRY_NAME}/${APP_GROUP}/${APP_NAME}:${APP_VERSION} --all-platforms\n\ndeploy-to-kubernetes:\n  stage: deploy\n  tags:\n    - executor=shell\n    - command=kubectl\n  before_script:\n    - source /etc/custom.sh\n  script:\n    - kubectl apply -f ci/kubectl.yaml\n")),(0,r.kt)("p",null,"\u7531\u4e8e Maven \u540e\u7eed\u7684\u9ad8\u7248\u672c\u4e2d\u4f1a\u963b\u6b62 HTTP \u7c7b\u578b\u4ed3\u5e93\u7684\u8bbf\u95ee\uff0c\u5bfc\u81f4 ",(0,r.kt)("inlineCode",{parentName:"p"},"pom.xml")," \u4e2d\u914d\u7f6e\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"<repository>")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"<pluginRepository>")," \u65e0\u6548\uff0c\u56e0\u6b64\u9700\u8981\u5148\u5220\u9664\u8be5\u6587\u4ef6\uff0c\u5f53\u7136\u5c06\u672c\u5730\u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"settings.xml")," \u6587\u4ef6\u5e26\u5165\u9879\u76ee\u7248\u672c\u63a7\u5236\u968f\u7740\u6d41\u6c34\u7ebf\u4e00\u8d77 ",(0,r.kt)("inlineCode",{parentName:"p"},"mvn --settings ci/settings.xml clean package")," \u4e5f\u53ef\u884c\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/079bdb73beba442e9f46ca8e54ad950d.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("h4",{id:"\u7f13\u5b58\u5230-nexus-\u4e2d\u7684-jar"},"\u7f13\u5b58\u5230 Nexus \u4e2d\u7684 Jar"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/4cb925c7499849ae8d5fe6a160c15221.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"npm-\u9879\u76ee"},"NPM \u9879\u76ee"),(0,r.kt)("h4",{id:"\u521b\u5efa\u9879\u76ee-1"},"\u521b\u5efa\u9879\u76ee"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"index.js")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/6c9e65fdd1dd4f788c57c008b34a5be3.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"Dockerfile")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/1c100f745caf4c989ddf1a05e724dac0.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"}))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"p"},"chart/templates/my-app-npm.yaml")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/beeacc8dab354a70a73cc9f01f89e4c9.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})))),(0,r.kt)("h4",{id:"gitlab-ci-\u6d41\u6c34\u7ebf-1"},"GitLab CI \u6d41\u6c34\u7ebf"),(0,r.kt)("p",null,"\u5bf9\u4e8e NodeJS \u9879\u76ee\u53ef\u80fd\u591a\u9636\u6bb5\u6784\u5efa\u955c\u50cf\u4f1a\u66f4\u9002\u7528\u4e00\u4e9b\uff0c\u56e0\u4e3a\u5728\u6267\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"npm install")," \u4e0b\u8f7d\u5305\u65f6\u5e76\u4e0d\u50cf Maven \u90a3\u6837\u900f\u660e\u5e76\u4e14\u4e0b\u8f7d\u8fc7\u7a0b\u5f88\u53ef\u80fd\u4f1a\u6267\u884c\u4e00\u4e9b\u4f9d\u8d56\u4e8e\u5e73\u53f0\u7684\u5de5\u4f5c\uff0c\u5982\u679c\u50cf\u6253\u5305 Jar \u5305\u90a3\u6837\u653e\u5728 GitLab Runner \u7684\u4f5c\u4e1a\u4e2d\uff0c\u867d\u7136\u53ef\u4ee5\u5bf9 ",(0,r.kt)("inlineCode",{parentName:"p"},"node_moduels")," \u8fdb\u884c\u7f13\u5b58\uff0c\u4f46\u4e5f\u6709\u53ef\u80fd\u56e0\u4e3a\u67d0\u4e9b\u4f9d\u8d56\u7684\u5e73\u53f0\u7ed1\u5b9a\uff0c\u5bfc\u81f4\u540e\u7eed\u7684\u591a\u5e73\u53f0\u955c\u50cf\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-yaml"},'variables:\n  # \u955c\u50cf\u6ce8\u518c\u8868\n  IMAGE_REGISTRY_NAME: core.harbor.dev.icefery.xyz\n  IMAGE_REGISTRY_USERNAME: admin\n  IMAGE_REGISTRY_PASSWORD: admin\n  # \u56fe\u8868\u4ed3\u5e93\n  CHART_REPO_NAME: icefery\n  CHART_REPO_URL: http://core.harbor.dev.icefery.xyz/chartrepo/icefery\n  CHART_REPO_USERNAME: admin\n  CHART_REPO_PASSWORD: admin\n  # \u5e94\u7528\n  APP_GROUP: icefery\n  APP_NAME: my-app-npm\n  APP_VERSION: 0.0.1\n\nstages:\n  - build\n  - deploy\n\nbuild-docker-image:\n  stage: build\n  tags:\n    # \u9009\u62e9\u6267\u884c\u5668\u4e3a Shell \u5e76\u4e14\u53ef\u4ee5\u6267\u884c nerdctl \u547d\u4ee4\u7684 GitLab Runner \u6267\u884c\u4f5c\u4e1a\n    - executor=shell\n    - command=nerdctl\n  before_script:\n    # non-interactively shell \u9700\u8981\u624b\u52a8\u914d\u7f6e\u73af\u5883\u53d8\u91cf\n    - source /etc/custom.sh\n  script:\n    # \u6784\u5efa\u955c\u50cf\n    - nerdctl build -t ${IMAGE_REGISTRY_NAME}/${APP_GROUP}/${APP_NAME}:${APP_VERSION} --platform linux/amd64,linux/arm64 .\n    # \u767b\u5f55\u955c\u50cf\u6ce8\u518c\u8868\n    - nerdctl login http://${IMAGE_REGISTRY_NAME} --username ${IMAGE_REGISTRY_USERNAME} --password ${IMAGE_REGISTRY_PASSWORD}\n    # \u63a8\u9001\u955c\u50cf\n    - nerdctl push ${IMAGE_REGISTRY_NAME}/${APP_GROUP}/${APP_NAME}:${APP_VERSION} --all-platforms\n\nbuild-helm-chart:\n  stage: build\n  tags:\n    - executor=shell\n    - command=helm\n  before_script:\n    - source /etc/custom.sh\n    - mkdir -p artifacts\n  script:\n    # \u6dfb\u52a0\u56fe\u8868\u4ed3\u5e93\n    - helm repo add ${CHART_REPO_NAME} ${CHART_REPO_URL} --username=${CHART_REPO_USERNAME} --password=${CHART_REPO_PASSWORD} || echo "\u5ffd\u7565\u9519\u8bef"\n    # \u63a8\u9001\u56fe\u8868\n    - helm cm-push chart/ ${CHART_REPO_NAME}\n    # \u5bfc\u51fa\u56fe\u8868\n    - helm package chart/ --destination artifacts\n  artifacts:\n    paths:\n      - artifacts/*.tgz\n\ndeploy-to-kubernetes:\n  stage: deploy\n  tags:\n    - executor=shell\n    - command=helm\n  before_script:\n    - source /etc/custom.sh\n  script:\n    - echo "$(whoami)"\n    # \u5378\u8f7d\n    - helm uninstall ${APP_NAME} --namespace ${APP_GROUP} || echo "\u5ffd\u7565\u9519\u8bef"\n    # \u66f4\u65b0\n    - helm repo update\n    # \u5b89\u88c5\n    - helm install ${APP_NAME} ${CHART_REPO_NAME}/${APP_NAME} --namespace ${APP_GROUP} --create-namespace --version ${APP_VERSION}\n')),(0,r.kt)("h4",{id:"\u4e0a\u4f20\u5230-harbor-\u7684\u955c\u50cf"},"\u4e0a\u4f20\u5230 Harbor \u7684\u955c\u50cf"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/b6427f275830403f8729eb13226e5d2a.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("br",null),(0,r.kt)("h2",{id:"\u5e38\u89c1\u95ee\u9898"},"\u5e38\u89c1\u95ee\u9898"),(0,r.kt)("h3",{id:"gitlab-ci-\u7f13\u5b58"},"GitLab CI \u7f13\u5b58"),(0,r.kt)("p",null,"\u5bf9\u4e8e\u901a\u8fc7 Maven \u6784\u5efa Jar \u5305\u7684\u4f5c\u4e1a\uff0c\u867d\u7136\u6211\u4eec\u5df2\u7ecf\u914d\u7f6e\u4e86 Nexus \u4f5c\u4e3a Jar \u5305\u7684\u4e00\u7ea7\u7f13\u5b58\uff0c\u4f46\u662f\u5c06 Jar \u5305\u4ece Nexus \u4e0b\u8f7d\u5230\u672c\u5730\u4ed3\u5e93\u4f9d\u7136\u9700\u8981\u6d88\u8017\u5927\u91cf\u8d44\u6e90\uff0c\u5982\u679c\u80fd\u591f\u5c06\u672c\u5730\u4ed3\u5e93\u7f13\u5b58\u8d77\u6765\u4f5c\u4e1a\u7684\u6267\u884c\u901f\u5ea6\u5c06\u4f1a\u5feb\u4e0d\u5c11\u3002"),(0,r.kt)("p",null,"GitLab CI \u9ed8\u8ba4\u662f\u672c\u5730\u7f13\u5b58\uff0c\u5bf9\u4e8e Kubernetes \u7b49\u901a\u8fc7\u542f\u52a8\u4e00\u4e2a\u5bb9\u5668\u6267\u884c\u7684 GitLab Runner \u6765\u8bf4\u5373\u4fbf\u8bbe\u7f6e\u4e86\u7f13\u5b58\u4e0b\u6b21\u4e5f\u65e0\u6cd5\u8fdb\u884c\u590d\u7528\u3002\u5728\u901a\u8fc7 Helm \u5b89\u88c5 GitLab \u65f6\u6211\u4eec\u5728\u914d\u7f6e\u4e86\u56fe\u8868\u81ea\u5e26\u7684 MinIO \u4f5c\u4e3a CI \u4f5c\u4e1a\u7684\u5206\u5e03\u5f0f\u7f13\u5b58\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/d3c456b2eed44e9298d8012838e45439.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("p",null,"\u56e0\u6b64\u5728\u901a\u8fc7 Maven \u6784\u5efa Jar \u5305\u65f6\u53ef\u4ee5\u76f4\u63a5\u590d\u7528\u7f13\u5b58\uff08\u4ece MinIO \u4e0b\u8f7d\uff09\uff1a"),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/37421fc4fce74a3596794562192553ce.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("p",null,"\u8981\u67e5\u770b GitLab \u56fe\u8868\u4e2d\u81ea\u5e26\u7684 MinIO \u6216\u8005\u9700\u8981\u4e3a\u5176\u5b83 GitLab Runner \u914d\u7f6e\u5206\u5e03\u5f0f\u7f13\u5b58\uff0c\u9700\u8981\u5148\u62ff\u5230\u5176 AccessKey \u548c Secret Key\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get -n gitlab secrets gitlab-minio-secret -ojsonpath='{.data.accesskey}' | base64 --decode\n\nkubectl get -n gitlab secrets gitlab-minio-secret -ojsonpath='{.data.secretkey}' | base64 --decode\n")),(0,r.kt)("p",null,(0,r.kt)("img",{parentName:"p",src:"https://img-blog.csdnimg.cn/d96ac33393de40c1982f09b2e0ee020a.png",alt:"\u5728\u8fd9\u91cc\u63d2\u5165\u56fe\u7247\u63cf\u8ff0"})),(0,r.kt)("br",null),(0,r.kt)("h3",{id:"\u5185\u7f51-dns"},"\u5185\u7f51 DNS"),(0,r.kt)("p",null,'Nexus \u548c Harbor \u90fd\u662f\u9700\u8981\u66b4\u9732\u51fa\u6765\u4f9b\u5ba2\u6237\u7aef\u4f7f\u7528\u7684\u670d\u52a1\uff0c\u5e76\u4e14 CI \u4f5c\u4e1a\u540c\u6837\u9700\u8981\u9891\u7e41\u7684\u8bbf\u95ee Nexus \u548c Harbor \u7b49\u670d\u52a1\uff0c\u90a3\u4e48\u5982\u679c\u975e\u8981\u901a\u8fc7 Ingress \u8bbf\u95ee\u670d\u52a1\u4e0d\u53ef\uff0c\u5728\u4e0d\u8003\u8651 Ingress Controller \u7684\u5206\u6d41\u65b9\u6848\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd8\u53ef\u4ee5\u901a\u8fc7\u4e24\u4e2a DNS \u670d\u52a1\u6765\u5206\u522b\u89e3\u6790 Ingress \u7684"\u865a\u62df\u4e3b\u673a" \u6765\u8fbe\u5230\u5bbf\u4e3b\u673a\u5185\u548c\u5bbf\u4e3b\u673a\u5916\u7684\u5206\u6d41\u6548\u679c\u3002'),(0,r.kt)("p",null,"\u4e4b\u524d\uff0c\u6211\u4eec\u4f7f\u7528 ExternalDNS + ETCD + CoreDNS \u5b9e\u73b0\u4e86\u5c40\u57df\u7f51\u7684 DNS \u81ea\u52a8\u6ce8\u518c\uff0c\u9664\u6b64\u4e4b\u5916\uff0c\u8fd8\u6709\u4e2a\u66f4\u8f7b\u91cf\u7ea7\u7684 DNS \u670d\u52a1\u2014\u2014\u2014\u2014DNSmasq\u3002\u76f8\u6bd4 CoreDNS \u4f7f\u7528 DNSmasq \u53ef\u4ee5\u66f4\u65b9\u4fbf\u7684\u914d\u7f6e\u6cdb\u89e3\u6790\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'apt install -y dnsmasq\n\necho "address=/dev.icefery.xyz/192.192.192.6" > /etc/dnsmasq.conf\n\nsystemctl restart dnsmasq\n')),(0,r.kt)("p",null,"\u7136\u540e\u518d\u5c06\u96c6\u7fa4\u5185\u7684 CoreDNS \u515c\u5e95 ",(0,r.kt)("inlineCode",{parentName:"p"},"forward")," \u5230\u8be5 DNS \u670d\u52a1\uff0c\u8fd9\u6837\u65e0\u8bba\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"gitlab.dev.icefery.xyz"),"\u8fd8\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"nexus.dev.icefery.xyz")," \u90fd\u5c06\u89e3\u6790\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"192.192.192.6")," \u8fd9\u4e2a\u5bbf\u4e3b\u673a\u5185\u7684 IP \u4e0a\uff0c\u8fd9\u5bf9\u4f7f\u7528 HostNetwork + NodeSelector \u7684 Ingress Controller \u4f1a\u66f4\u52a0\u65b9\u4fbf\u4e00\u4e9b\u3002"))}m.isMDXComponent=!0}}]);